!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.opensoql=t():e.opensoql=t()}(this,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";n.r(t),n.d(t,"applyWhereConditions",(function(){return q})),n.d(t,"applyHavingConditions",(function(){return M})),n.d(t,"sortRecords",(function(){return $})),n.d(t,"build",(function(){return $n})),n.d(t,"setDefaultStaticResolverConfig",(function(){return pr})),n.d(t,"staticJsonResolverBuilder",(function(){return wr})),n.d(t,"staticCsvResolverBuilder",(function(){return br})),n.d(t,"passThroughResolverBuilder",(function(){return vr}));const r=Function("return this")(),s={}.constructor,o=Function,a=/^(\d{4}-[01]\d-[0-3]\d)$/,i=/^((?:(?:\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+)|(?:\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d)|(?:\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d))(?:[+-][0-2]\d:[0-5]\d|Z))$/,l={};function c(e,t){if(e===r||"__proto__"===t||"__defineGetter__"===t||"__defineSetter__"===t||"__lookupGetter__"===t||"__lookupSetter__"===t)return!0;if(!("prototype"!==t&&"constructor"!==t||null!=e&&"function"!=typeof e))return!0;if((null==e||e===s)&&s.hasOwnProperty(t))return!0;if(null==e||e===o){let e=o;for(;e;){if(e.hasOwnProperty(t))return!0;e=e.__proto__}}return"function"==typeof e&&!e.hasOwnProperty(t)}function u(e){switch(typeof e){case"object":if(Array.isArray(e))return e.slice().map(e=>u(e));if(null===e)return e;if(e instanceof Map){const t=Array.from(e.entries()).map(e=>[u(e[0]),u(e[1])]);return new Map(t)}if(e instanceof Set){const t=Array.from(e.values()).map(e=>u(e));return new Set(t)}{const t={};for(const n of Object.keys(e))t[n]=u(e[n]);return t}default:return e}}function f(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].toLowerCase()!==t[n].toLowerCase())return!1;return!0}function d(e,t){const n=[];for(let r=0;r<e.length;r++){const s=e.slice(r);if(f(t.slice(0,s.length),s))break;n.push(e[r])}return n.length?n.concat(t):t}function p(e,t){const n=Object.keys(e),r=t.toLowerCase(),s=n.findIndex(e=>e.toLowerCase()===r);return 0>s?null:n[s]}function m(e,t){const n=Object.keys(e),r=t.toLowerCase(),s=n.findIndex(e=>e.toLowerCase()===r);return 0>s?null:e[n[s]]}function g(e,t,n){const r=n.toLowerCase();return e.has(r)?t[e.get(r)]:null}function h(e,t){const n=[];let r=e;for(const e of t){if(null==r)return null;const t=Object.keys(r),s=e.toLowerCase(),o=t.findIndex(e=>e.toLowerCase()===s);if(0>o)return null;r=r[t[o]],n.push(t[o])}return n}function y(e,t){let n=e;for(const e of t)if(n=n[e],null==n)return null;return n}function w(e,t){let n=e;for(const e of t){const t=Object.keys(n),r=e.toLowerCase(),s=t.findIndex(e=>e.toLowerCase()===r);if(0>s)return null;if(n=n[t[s]],null==n)return null}return n}const b=new WeakMap,v=new WeakMap,k=new WeakMap;function A(e,t,n,r,s,o){const a=t.args.map(t=>{switch(typeof t){case"object":if(null===t)return t;switch(t.type){case"field":{let e=m(s,t.name[t.name.length-1]);switch(r){case"date":case"datetime":e=new Date(e).getTime()}return e}case"date":case"datetime":switch(r){case"date":case"datetime":return new Date(t.value).getTime();default:return t.value}case"fncall":{let n=k.get(t);if(!n){const r=t.fn.toLowerCase();n=e.functions.find(e=>e.name.toLowerCase()===r)}const r=n;switch(null==r?void 0:r.type){case"aggregate":if(!o)throw new Error(`Nested function ${t.fn} is not allowed.`);return N(e,t,r,"any",o);case"scalar":return A(e,t,r,"any",s,o);case"immediate-scalar":return x(e,t,r,"any",s,o);default:throw new Error(`Nested function ${t.fn} is not allowed.`)}}default:return t}default:return t}});return n.fn(e,a,s)}function x(e,t,n,r,s,o){const a=t.args.map(t=>{switch(typeof t){case"object":if(null===t)return t;switch(t.type){case"field":throw new Error(`Immediate scalar function should not refer the field (${t.name.join(".")}).`);case"date":case"datetime":switch(r){case"date":case"datetime":return new Date(t.value).getTime();default:return t.value}case"fncall":{let n=k.get(t);if(!n){const r=t.fn.toLowerCase();n=e.functions.find(e=>e.name.toLowerCase()===r)}const r=n;switch(null==r?void 0:r.type){case"aggregate":if(null===o)throw new Error(`Nested function ${t.fn} is not allowed.`);return N(e,t,r,"any",o);case"scalar":if(null===s)throw new Error(`Nested function ${t.fn} is not allowed.`);return A(e,t,r,"any",s,o);case"immediate-scalar":return x(e,t,r,"any",s,o);default:throw new Error(`Nested function ${t.fn} is not allowed.`)}}default:return t}default:return t}});return n.fn(e,a)}function N(e,t,n,r,s){const o=t.args.map(t=>{switch(typeof t){case"object":if(null===t)return t;switch(t.type){case"field":{let e=s.map(e=>m(e,t.name[t.name.length-1]));switch(r){case"date":case"datetime":e=e.map(e=>new Date(e).getTime())}return e}case"date":case"datetime":switch(r){case"date":case"datetime":return new Date(t.value).getTime();default:return t.value}case"fncall":{let n=k.get(t);if(!n){const r=t.fn.toLowerCase();n=e.functions.find(e=>e.name.toLowerCase()===r)}const r=n;switch(null==r?void 0:r.type){case"scalar":return s.map(n=>A(e,t,r,"any",n,s));case"immediate-scalar":return s.map(n=>x(e,t,r,"any",n,s));default:throw new Error(`Nested function ${t.fn} is not allowed.`)}}default:return t}default:return t}});return n.fn(e,o,s)}function _(e,t){if(e.has(t)){const n=e.get(t);if(n)return n}return null}function C(e,t,n){for(const r of n)switch(typeof r){case"object":switch(null==r?void 0:r.type){case"field":if(!_(t,r.name[r.name.length-1]))return!1;break;case"fncall":{const n=r.fn.toLowerCase(),s=e.functions.find(e=>e.name.toLowerCase()===n);switch(null==s?void 0:s.type){case"scalar":if(!C(e,t,r.args))return!1}}}}return!0}const F=(e,t,n,r)=>{},O=(e,t,n,r)=>{const{op:s,op2FieldResultType:o,fnInfo:a}=n;return N(t,s,a,o,r)},j=(e,t,n,r)=>{const{op:s,op2FieldResultType:o,fnInfo:a}=n;return A(t,s,a,o,r[0],r)},E=(e,t,n,r)=>{const{op:s,op2FieldResultType:o,fnInfo:a}=n;return A(t,s,a,o,r,null)},P=(e,t,n,r)=>{const{op:s,op2FieldResultType:o,fnInfo:a}=n;return x(t,s,a,o,null,r)},D=(e,t,n,r)=>{const{op:s,op2FieldResultType:o,fnInfo:a}=n;return x(t,s,a,o,r,null)};function T(e,t,n,r,s,o){var a;let i=null;const l=s.operands[0],c=null!==(a=b.get(s))&&void 0!==a?a:function(e,t,n,r){let s=b.get(r);const o=r.operands[0],a=r.operands[1];let i=!1,l="any";switch(typeof a){case"object":if(null===a);else if(Array.isArray(a));else switch(a.type){case"date":case"datetime":i=!0,l=a.type}}switch(typeof o){case"object":if(null===o);else{if(Array.isArray(o))throw new Error("Array is not allowed in the operand(1).");switch(o.type){case"field":s={isField:!0,isDateOrDatetime:i,op:o,op2FieldResultType:l,fnInfo:null,fn:F},b.set(r,s);break;case"fncall":{const a=o.fn.toLowerCase(),i=n.functions.find(e=>e.name.toLowerCase()===a);switch(null==i?void 0:i.type){case"aggregate":if(!t)throw new Error(`Aggregate function ${i.name} is not allowed.`);s={isField:!1,isDateOrDatetime:!1,op:o,op2FieldResultType:l,fnInfo:i,fn:O},b.set(r,s);break;case"scalar":if(t){if(!C(n,e,o.args))throw new Error(o.fn+" is not allowed. Aggregate function is needed.");s={isField:!1,isDateOrDatetime:!1,op:o,op2FieldResultType:l,fnInfo:i,fn:j},b.set(r,s)}else s={isField:!1,isDateOrDatetime:!1,op:o,op2FieldResultType:l,fnInfo:i,fn:E},b.set(r,s);break;case"immediate-scalar":s={isField:!1,isDateOrDatetime:!1,op:o,op2FieldResultType:l,fnInfo:i,fn:t?P:D},b.set(r,s);break;default:throw new Error("Unexpected type appears in the operand(1).")}}break;default:throw new Error("Unexpected type appears in the operand(1).")}}break;default:throw new Error("Unexpected type appears in the operand(1).")}return s}(t,n,r,s);if(null===l);else{if(Array.isArray(l))throw new Error("Array is not allowed in the operand(1).");if(c.isField){const{isDateOrDatetime:t,op:n}=c;i=g(e,o,n.name[n.name.length-1]),t&&null!==i&&(i=new Date(i).getTime())}else i=c.fn(e,r,c,o)}return i}function S(e,t,n,r,s,o){let a=!0;switch(typeof s){case"object":if(Array.isArray(s))throw new Error("Array is not allowed in the condition.");if(null===s)throw new Error("Unexpected type appears in the condition.");switch(s.type){case"condition":a=I(e,t,n,r,s,o);break;default:throw new Error("Unexpected type appears in the condition.")}break;default:throw new Error("Unexpected type appears in the condition.")}return a}function L(e){const t=e.replace(/[.*+?^=!:${}()|[\]\/]/g,"\\$&");let n="",r=void 0;for(const e of t){switch(e){case"%":n+="\\"===r?"%":".*";break;case"_":n+="\\"===r?"_":".";break;case"\\":break;default:"\\"===r&&(n+="\\"),n+=e}r=e}return"\\"===r&&(n+="\\"),`^${n}$`}function I(e,t,n,r,s,o){let a=!0;e:switch(s.op){case"true":break;case"and":for(const i of s.operands)if(!S(e,t,n,r,i,o)){a=!1;break e}break;case"or":for(const a of s.operands)if(S(e,t,n,r,a,o))break e;a=!1;break;case"not":a=!S(e,t,n,r,s.operands[0],o);break;default:{const i=T(e,t,n,r,s,o),l=function(e,t,n){const r=v.get(t);if(r)return r.value;let s=null;const o=t.operands[1];switch(typeof o){case"object":if(null===o);else if(Array.isArray(o))s=o;else switch(o.type){case"fncall":{const t=o.fn.toLowerCase(),n=e.functions.find(e=>e.name.toLowerCase()===t);switch(null==n?void 0:n.type){case"immediate-scalar":s=x(e,o,n,"any",null,null);break;default:throw new Error("Unexpected type appears in the operand(2).")}}default:switch(o.type){case"date":case"datetime":s=new Date(o.value).getTime();break;default:throw new Error("Unexpected type appears in the operand(2).")}}break;default:s=o}return v.set(t,{value:s}),s}(r,s);switch(s.op){case"=":i!==l&&(a=!1);break;case"!=":i===l&&(a=!1);break;case"<":if(null===i){a=!1;break}if(null===l){a=!1;break}i<l||(a=!1);break;case"<=":if(null===i){a=!1;break}if(null===l){a=!1;break}i<=l||(a=!1);break;case">":if(null===i){a=!1;break}if(null===l){a=!1;break}i>l||(a=!1);break;case">=":if(null===i){a=!1;break}if(null===l){a=!1;break}i>=l||(a=!1);break;case"like":if("string"!=typeof i){a=!1;break}if("string"!=typeof l)throw new Error('Operator "like": operand(2) should be string.');new RegExp(L(l),"i").test(i)||(a=!1);break;case"not_like":if("string"!=typeof i){a=!1;break}if("string"!=typeof l)throw new Error('Operator "not_like": operand(2) should be string.');new RegExp(L(l),"i").test(i)&&(a=!1);break;case"in":if(!Array.isArray(l))throw new Error('Operator "in": operand(2) should be array.');l.filter(e=>null!==e).includes(i)||(a=!1);break;case"not_in":if(!Array.isArray(l))throw new Error('Operator "not_in": operand(2) should be array.');if(null===i){a=!1;break}if(l.includes(null)){a=!1;break}l.includes(i)&&(a=!1);break;case"includes":if("string"!=typeof i){a=!1;break}if(!Array.isArray(l))throw new Error('Operator "includes": operand(2) should be array.');a=!1;t:for(const e of l){if("string"!=typeof e)throw new Error('Operator "includes": operand(2) array items should be string.');const t=i.split(";"),n=e.split(";");for(const e of n)if(!t.includes(e))continue t;a=!0;break}break;case"excludes":if("string"!=typeof i){a=!1;break}if(!Array.isArray(l))throw new Error('Operator "excludes": operand(2) should be array.');{const e=i.split(";");for(const t of l){if("string"!=typeof t)throw new Error('Operator "excludes": operand(2) array items should be string.');const n=t.split(";");let r=!0;for(const t of n)if(!e.includes(t)){r=!1;break}if(r){a=!1;break}}}}}}return a}function q(e,t,n){const r=[];if(!n.length)return r;const s=new Map(Object.keys(n[0]).map(e=>[e.toLowerCase(),e]));e:for(const o of n){for(const n of t)if(!I(s,null,!1,e,n,o))continue e;r.push(o)}return r}function M(e,t,n){var r,s;const o=[];if(!n.length)return o;const a=new Map(Object.keys(n[0][0]).map(e=>[e.toLowerCase(),e])),i=n[0][0],l=new Map(null===(s=null===(r=e.query)||void 0===r?void 0:r.groupBy)||void 0===s?void 0:s.map(e=>{var t;return[e.toLowerCase(),null!==(t=p(i,e))&&void 0!==t?t:""]}));e:for(const r of n){for(const n of t)if(!I(a,l,!0,e,n,r))continue e;o.push(r)}return o}function $(e,t){if(e.orderBy){const n=e.from[0].name.length,r=e.orderBy;t=t.sort((e,s)=>{const o=(e,t)=>"desc"===e.direction?-t:t,a=r.map(e=>({f:e,fName:h(t[0],e.name.slice(n))}));e:for(let{f:t,fName:r}of a){let a=null,i=null;if(null!==r?(a=y(e,r),i=y(s,r)):(a=w(e,t.name.slice(n)),r=h(s,t.name.slice(n)),i=null!==r?y(s,r):null),a!==i){if(null===a)return o(t,"last"===t.nulls?1:-1);if(null===i)return o(t,"last"===t.nulls?-1:1);switch(typeof a){case"number":case"bigint":return o(t,a-i);case"string":return o(t,a>i?1:-1);default:continue e}}}return 0})}return t}class R extends Error{constructor(e){super(e.message),this.result=e}}function U(e,t){return{src:e,start:0,end:e.length,context:t,templateArgs:[],templateArgsPos:[]}}function B(e){let t="",n="";if("string"==typeof e.src){n=e.src.slice(Math.max(e.pos-5,0),e.pos+55);let r=n.split(/\r\n|\n|\r/);r=r.slice(0,1).concat("          ^~~~~~~~").concat(...r.slice(1)),n=r.join("\n")+"\n\n";const s=function(e,t){let n=1,r=1;for(let s=0;s<=t;s++)switch(e[s]){case"\r":"\n"===e[s+1]&&s++;case"\n":n++,r=1;break;default:r++}return{line:n,col:r}}(e.src,e.pos);t=`parse failed at position:${e.pos} line:${s.line} col:${s.col} ${e.message?" "+e.message:""}\n     ${n}`}else{n="     (object)\n          ^~~~~~~~";try{n="     "+JSON.stringify(e.src.slice(Math.max(e.pos-10,0),e.pos))+"\n          "+JSON.stringify(e.src.slice(e.pos,e.pos+1))+"\n          "+JSON.stringify(e.src.slice(e.pos+1,e.pos+10));let t=n.split(/\r\n|\n|\r/);t=t.slice(0,2).concat("          ^~~~~~~~").concat(...t.slice(2)),n=t.join("\n")+"\n\n"}catch(e){}t=`parse failed at position:${e.pos} ${e.message?" "+e.message:""}\n     ${n}`}return t}function Q(e){return t=>({succeeded:!0,next:{src:t.src,start:t.start,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:e?[e()]:[]})}function W(e){return t=>{throw new R({succeeded:!1,error:!0,src:t.src,pos:t.start,message:e||""})}}function z(e){return t=>0===t.start?{succeeded:!0,next:{src:t.src,start:t.start,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:e?[e()]:[]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "beginning"'}}function J(e){return t=>t.start===t.end?{succeeded:!0,next:{src:t.src,start:t.start,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:e?[e()]:[]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "end"'}}function Y(e,t){return e=e||0,n=>r=>{let s=r;const o=[];for(;;){const r=n(s);if(!r.succeeded){if(r.error)return r;if(o.length>=e)break;return{succeeded:!1,error:!1,src:s.src,pos:s.start,message:'operator "quantify"'}}if(s=r.next,o.push({next:r.next,tokens:r.tokens}),t&&t===o.length)break}if(o.length>0){const e=[];for(const t of o)e.push(...t.tokens);return{succeeded:!0,next:o[o.length-1].next,tokens:e}}return{succeeded:!0,next:{src:r.src,start:r.start,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[]}}}function Z(...e){return t=>{let n=null,r=null;for(const s of e){const e=s(t);if(e.succeeded){n={next:e.next,tokens:e.tokens};break}r?e.error?(!r.error||r.pos<e.pos)&&(r=e):r.pos<e.pos&&(r=e):r=e}return n?{succeeded:!0,next:n.next,tokens:n.tokens}:r||{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "first"'}}}function H(...e){return t=>{const n=[];let r=null;for(const s of e){const e=s(t);e.succeeded?n.push({next:e.next,tokens:e.tokens}):r?e.error?(!r.error||r.pos<e.pos)&&(r=e):r.pos<e.pos&&(r=e):r=e}if(n.length>0){const e=n.reduce((e,t)=>e.next.start>=t.next.start?e:t);return{succeeded:!0,next:e.next,tokens:e.tokens}}return r||{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "or"'}}}function G(e,t){return(...n)=>r=>{let s=r;const o=[];for(const e of n){const t=e(s);if(!t.succeeded)return t;s=t.next,o.push(...t.tokens)}const a=e?e(o,r):o;return{succeeded:!0,next:t?{src:s.src,start:s.start,end:s.end,context:t(s.context),templateArgs:s.templateArgs,templateArgsPos:s.templateArgsPos}:s,tokens:a}}}function K(...e){return t=>{let n=t;for(const t of e){const e=t(n);if(!e.succeeded)return e;n=e.next}return{succeeded:!0,next:t,tokens:[]}}}function V(e,t){return(...n)=>r=>{if(r.start-e<0)return{succeeded:!1,error:!1,src:r.src,pos:r.start,message:"lookBehind: src is too short"};let s={src:r.src,start:r.start-e,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos};for(const e of n){const t=e(s);if(!t.succeeded)return t;s=t.next}return{succeeded:!0,next:r,tokens:t?[t()]:[]}}}function X(e){return t=>n=>{const r=t(n);if(!r.succeeded)return r;const s=U(r.tokens,n.context);let o=s,a=!1;if(e.check(o).succeeded)return{succeeded:!0,next:r.next,tokens:r.tokens};e:for(let t=0;void 0===e.maxApply||t<e.maxApply;t++){let t=!1;t:for(const n of e.rules){const{parser:r,rtol:s}="function"==typeof n?{parser:n,rtol:!1}:n,i=o.src.length;for(let n=0;n<=i;n++){const l=r({src:o.src,start:s?i-n:n,end:o.src.length,context:o.context,templateArgs:o.templateArgs,templateArgsPos:o.templateArgsPos});if(l.succeeded){t=!0;const r=o.src.slice(0,s?i-n:n);if(r.push(...l.tokens),r.push(...o.src.slice(l.next.start)),o={src:r,start:0,end:r.length,context:l.next.context,templateArgs:l.next.templateArgs,templateArgsPos:l.next.templateArgsPos},e.check(o).succeeded){a=!0;break e}break t}}}if(!t)break}if(!a&&!e.check(o).succeeded)throw new R({succeeded:!1,error:!0,src:s.src,pos:s.start,message:"The application of production rules was not finished"});return{succeeded:!0,next:r.next,tokens:o.src}}}function ee(e){return t=>{try{return e(t)}catch(e){if(e.result)return e.result;throw e}}}function te(e,t){return n=>{if("\0"===n.src.slice(n.start,n.start+1)&&n.templateArgsPos){let r=-1;if(0<=n.templateArgsPos.findIndex((e,t)=>(r=t,e===n.start))){const s=n.templateArgs[r];if(e(s))return{succeeded:!0,next:{src:n.src,start:n.start+1,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[t?t(s):s]}}}return{succeeded:!1,error:!1,src:n.src,pos:n.start,message:'operator "stringTemplatesParam()"'}}}function ne(e){const t=(n=e.rawToToken,e=>t=>t.src.slice(t.start,t.end).startsWith(e)?{succeeded:!0,next:{src:t.src,start:t.start+e.length,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:[n(e)]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:`operator "charSequence(${e})"`});var n;const r=function(e){return(...t)=>n=>{const r=n.src.slice(n.start,n.end);let s=-1;return t.some((e,t)=>{if(r.startsWith(e))return s=t,!0})?{succeeded:!0,next:{src:n.src,start:n.start+t[s].length,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[e(t[s])]}:{succeeded:!1,error:!1,src:n.src,pos:n.start,message:`operator "charClass(${t.join(",")})"`}}}(e.rawToToken),s=function(e){return(...t)=>n=>{const r=n.src.slice(n.start,n.end);for(const e of t){if(r.startsWith(e))return{succeeded:!1,error:!1,src:n.src,pos:n.start,message:`operator "charClassNot(${t.join(",")})"`}}const s=n.src.codePointAt(n.start);if(void 0===s)return{succeeded:!1,error:!1,src:n.src,pos:n.start,message:`operator "charClassNot(${t.join(",")})"`};const o=String.fromCodePoint(s);return{succeeded:!0,next:{src:n.src,start:n.start+o.length,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[e(o)]}}}(e.rawToToken),o=function(e){return t=>n=>{const r=n.src.slice(n.start,n.end),s=t(r);return s>=0?{succeeded:!0,next:{src:n.src,start:n.start+s,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[e(r.substring(0,s))]}:{succeeded:!1,error:!1,src:n.src,pos:n.start,message:'operator "charClassByNeedleFn"'}}}(e.rawToToken),a=G(e.concatTokens),i=Y(1,1),l=Y(),c=(e,t)=>Y(e,t),u=G(),f=G(e=>[]),d=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="Z"||"a"<=n&&n<="z"?n.length:-1}),p=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="Z"?n.length:-1}),m=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"a"<=n&&n<="z"?n.length:-1}),g=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"0"<=n&&n<="9"?n.length:-1}),h=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"1"<=n&&n<="9"?n.length:-1}),y=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"0"<=n&&n<="1"?n.length:-1}),w=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"0"<=n&&n<="7"?n.length:-1}),b=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="F"||"a"<=n&&n<="f"||"0"<=n&&n<="9"?n.length:-1}),v=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="Z"||"a"<=n&&n<="z"||"0"<=n&&n<="9"?n.length:-1}),k=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return" \f\n\r\t\v​  ​᠎           ​\u2028\u2029  ​　\ufeff".includes(n)?n.length:-1}),A=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return" \f\t\v​  ​᠎           ​\u2028\u2029  ​　\ufeff".includes(n)?n.length:-1}),x=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return 0<=t&&t<=31||127<=t&&t<=159?n.length:-1}),N=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return" \f\n\r\t\v​  ​᠎           ​\u2028\u2029  ​　\ufeff".includes(n)||0<=t&&t<=31||127<=t&&t<=159?-1:n.length}),_=r("\r\n","\n","\r"),C=o(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;return String.fromCodePoint(t).length}),F=Z(y,r("_")),O=Z(w,r("_")),j=Z(b,r("_")),E=u(a(c(0,1)(r("+","-")),Z(u(i(h),l(Z(g,r("_")))),t("0")))),P=u(a(E,f(t("n")))),D=u(a(c(0,1)(r("+","-")),Z(u(i(h),l(Z(g,r("_")))),t("0")),c(0,1)(u(t("."),c(1)(Z(g,r("_"))))),c(0,1)(u(r("E","e"),c(0,1)(r("+","-")),Z(u(i(h),l(g)),t("0"))))));return{seq:t,cls:r,notCls:s,clsFn:o,classes:{alpha:d,upper:p,lower:m,num:g,nonzero:h,bin:y,oct:w,hex:b,alnum:v,space:k,spaceWithinSingleLine:A,ctrl:x,newline:_,word:N,any:C},numbers:{bin:(...e)=>u(f(Z(...e)),a(i(y),l(F))),oct:(...e)=>u(f(Z(...e)),a(i(w),l(O))),hex:(...e)=>u(f(Z(...e)),a(i(b),l(j))),int:E,bigint:P,float:D},isParam:te,cat:a,once:i,repeat:l,qty:c,zeroWidth:e=>Q(e),err:e=>W(e),beginning:e=>z(e),end:e=>J(e),first:(...e)=>Z(...e),or:(...e)=>H(...e),combine:u,erase:f,trans:e=>G(e),ahead:(...e)=>K(...e),behind:(e,t)=>V(e,t),rules:e=>X(e),makeProgram:ee}}function re(e,t){return n=>r=>{let s=!0;if(Math.max(0,r.end-r.start)>=n.length){for(let e=0;e<n.length;e++)if(!t(r.src[r.start+e],n[e])){s=!1;break}}else s=!1;return s?{succeeded:!0,next:{src:r.src,start:r.start+n.length,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[e(n)]}:{succeeded:!1,error:!1,src:r.src,pos:r.start,message:`operator "objSequence(${n})"`}}}function se(e,t){return(...n)=>r=>{const s=Math.max(0,r.end-r.start);let o=-1;return s>0&&n.some((e,n)=>{if(t(r.src[r.start],e))return o=n,!0})?{succeeded:!0,next:{src:r.src,start:r.start+1,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[e(n[o])]}:{succeeded:!1,error:!1,src:r.src,pos:r.start,message:`operator "objClass(${n.join(",")})"`}}}function oe(e,t){return(...n)=>r=>{if(Math.max(0,r.end-r.start)>0)for(const e of n){let s=!0;if(!t(r.src[r.start],e)){s=!1;break}if(s)return{succeeded:!1,error:!1,src:r.src,pos:r.start,message:`operator "objClassNot(${n.join(",")})"`}}return{succeeded:!0,next:{src:r.src,start:r.start+1,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[e(r.src[r.start])]}}}const ae=ne({rawToToken:e=>e,concatTokens:e=>e.length?[e.reduce((e,t)=>String(e)+t)]:[]}),ie=function(e){const t=(n=e.rawToToken,e.comparator,e=>t=>Math.max(0,t.end-t.start)>0&&e(t.src[t.start])?{succeeded:!0,next:{src:t.src,start:t.start+1,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:[n(t.src[t.start])]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "objClassByNeedleFn"'});var n;const r=t(e=>!0);return{seq:re(e.rawToToken,e.comparator),cls:se(e.rawToToken,e.comparator),notCls:oe(e.rawToToken,e.comparator),clsFn:t,classes:{any:r},cat:G(e.concatTokens),once:Y(1,1),repeat:Y(),qty:(e,t)=>Y(e,t),zeroWidth:e=>Q(e),err:e=>W(e),beginning:e=>z(e),end:e=>J(e),first:(...e)=>Z(...e),or:(...e)=>H(...e),combine:G(),erase:G(e=>[]),trans:e=>G(e),ahead:(...e)=>K(...e),behind:(e,t)=>V(e,t),rules:e=>X(e),makeProgram:ee}}({rawToToken:e=>e,concatTokens:e=>e.length?[e.reduce((e,t)=>String(e)+t)]:[],comparator:(e,t)=>e===t}),{seq:le,cls:ce,notCls:ue,clsFn:fe,classes:de,numbers:pe,isParam:me,cat:ge,once:he,repeat:ye,qty:we,zeroWidth:be,err:ve,beginning:ke,end:Ae,first:xe,or:Ne,combine:_e,erase:Ce,trans:Fe,ahead:Oe,rules:je,makeProgram:Ee}=ae,Pe=e=>fe(t=>t.slice(0,e.length).toLocaleLowerCase()===e?e.length:-1),De=(e,t,n)=>({type:"condition",op:e,operands:[t,n]}),Te=(e,t)=>"object"==typeof e&&"rawop"===e.type&&e.op===t,Se=_e(Ce(we(2)(ce("-"))),xe(_e(ye(ue("\r\n","\n","\r")),xe(de.newline,Oe(Ae()))),xe(de.newline,Oe(Ae())))),Le=_e(le("/*"),ye(ue("*/")),le("*/")),Ie=xe(de.space,Se,Le),qe=xe(_e(Pe("select"),e=>Re(e)),_e(Pe("from"),e=>Re(e)),_e(Pe("where"),e=>Re(e)),ge(_e(Pe("order"),Ce(we(1)(Ie)),Pe("by"))),ge(_e(Pe("group"),Ce(we(1)(Ie)),Pe("by"))),_e(Pe("having"),e=>Re(e)),_e(Pe("offset"),e=>Re(e)),_e(Pe("limit"),e=>Re(e))),Me=Oe(e=>_e(qe,xe(we(1)(Ie),ce("(",")","'",'"',"=","!","<",">"),Ae()))(e).succeeded?{succeeded:!1,error:!1,src:e.src,pos:e.start,message:"Unexpected reserved keyword aheads"}:{succeeded:!0,next:{src:e.src,start:e.start,end:e.end,context:e.context},tokens:[]}),$e=e=>"string"==typeof e&&/^[A-Za-z0-9$_"]$/.test(e),Re=Oe(e=>{let t=!1;return t=0===e.src.length||(e.start===e.end?$e(e.src[e.start-1]):0===e.start?$e(e.src[e.start]):!$e(e.src[e.start-1])&&$e(e.src[e.start])||$e(e.src[e.start-1])&&!$e(e.src[e.start])),t?{succeeded:!0,next:{src:e.src,start:e.start,end:e.end,context:e.context},tokens:[]}:{succeeded:!1,error:!1,src:e.src,pos:e.start,message:"Expect word break"}}),Ue=Fe(e=>[!0])(Pe("true"),Re),Be=Fe(e=>[!1])(Pe("false"),Re),Qe=Fe(e=>[null])(Pe("null"),Re),We=Fe(e=>[Number.POSITIVE_INFINITY])(we(0,1)(le("+")),le("Infinity"),Re),ze=Fe(e=>[Number.NEGATIVE_INFINITY])(le("-Infinity"),Re),Je=Fe(e=>[Number.NaN])(le("NaN"),Re),Ye=Fe(e=>[Number.parseInt(e[0].replace(/_/g,""),2)])(pe.bin(le("0b"))),Ze=Fe(e=>[Number.parseInt(e[0].replace(/_/g,""),8)])(pe.oct(le("0o"),le("0"))),He=Fe(e=>[Number.parseInt(e[0].replace(/_/g,""),16)])(pe.hex(le("0x"),le("0X"))),Ge=Fe(e=>[Number.parseInt(e[0].replace(/_/g,""),10)])(pe.int),Ke=Fe(e=>[Number.parseFloat(e[0].replace(/_/g,""))])(pe.float),Ve=xe(Ze,He,Ye,Ke,Ge,We,ze,Je),Xe=xe(Fe(e=>["'"])(le("\\'")),Fe(e=>['"'])(le('\\"')),Fe(e=>["`"])(le("\\`")),Fe(e=>["/"])(le("\\/")),Fe(e=>["\\"])(le("\\\\")),Fe(e=>[""])(le("\\\r\n")),Fe(e=>[""])(le("\\\r")),Fe(e=>[""])(le("\\\n")),Fe(e=>["\n"])(le("\\n")),Fe(e=>["\n"])(le("\\N")),Fe(e=>["\r"])(le("\\r")),Fe(e=>["\r"])(le("\\R")),Fe(e=>["\v"])(le("\\v")),Fe(e=>["\t"])(le("\\t")),Fe(e=>["\t"])(le("\\T")),Fe(e=>["\b"])(le("\\b")),Fe(e=>["\b"])(le("\\B")),Fe(e=>["\f"])(le("\\f")),Fe(e=>["\f"])(le("\\F")),Fe(e=>[String.fromCodePoint(Number.parseInt(e[0],16))])(ge(Ce(le("\\u")),we(4,4)(de.hex))),Fe(e=>[String.fromCodePoint(Number.parseInt(e[0],16))])(ge(Ce(le("\\u{")),we(1,6)(de.hex),Ce(le("}")))),Fe(e=>[String.fromCodePoint(Number.parseInt(e[0],16))])(ge(Ce(le("\\x")),we(2,2)(de.hex))),Fe(e=>[String.fromCodePoint(Number.parseInt(e[0],8))])(ge(Ce(le("\\")),we(3,3)(de.oct)))),et=Fe(e=>{var t;return[null!==(t=e[0])&&void 0!==t?t:""]})(Ce(le("'")),ge(ye(xe(Xe,_e(ce("\r","\n"),ve("Line breaks within strings are not allowed.")),ue("'")))),Ce(le("'"))),tt=Fe(e=>[{type:"date",value:e[0]}])(ge(we(4,4)(de.num),ce("-"),we(2,2)(de.num),ce("-"),we(2,2)(de.num),Re)),nt=Fe(e=>[{type:"datetime",value:e[0]}])(ge(we(4,4)(de.num),ce("-"),we(2,2)(de.num),ce("-"),we(2,2)(de.num),ce("T"),we(2,2)(de.num),ce(":"),we(2,2)(de.num),we(0,1)(_e(ce(":"),we(2,2)(de.num))),xe(ce("Z"),_e(xe(ce("+"),ce("-")),we(2,2)(de.num),ce(":"),we(2,2)(de.num))),Re)),rt=xe(me(e=>{switch(typeof e){case"number":case"string":case"boolean":return!0;case"object":if(null===e)return!0;if(e.type)switch(e.type){case"date":if("string"==typeof e.value)return a.test(e.value);break;case"datetime":if("string"==typeof e.value)return i.test(e.value)}}return!1}),nt,tt,Ve,et,Ue,Be,Qe),st=Fe(e=>{var t;const n=null!==(t=e[0])&&void 0!==t?t:"";if(c(l,n))throw new Error("Unsafe symbol name is appeared: "+n);return[n]})(Ce(le('"')),ge(ye(xe(Xe,_e(ce("\r","\n"),ve("Line breaks within strings are not allowed.")),ue('"')))),Ce(le('"'))),ot=Fe(e=>{if(c(l,e[0]))throw new Error("Unsafe symbol name is appeared: "+e[0]);return e})(ge(_e(xe(de.alpha,ce("$","_")),ye(xe(de.alnum,ce("$","_")))))),at=Fe(e=>[{name:e}])(xe(ot,st),ye(_e(Ce(ye(Ie),ce("."),ye(Ie)),xe(ot,st)))),it=Fe(e=>[{fn:e[0],args:e.slice(1)}])(ot,Ce(ye(Ie)),Ce(ce("(")),Ce(ye(Ie)),ye(xe(Fe(e=>[Object.assign({type:"fncall"},e[0])])(e=>it(e)),rt,Fe(e=>[Object.assign({type:"field"},e[0])])(at))),ye(_e(Ce(ye(Ie)),Ce(ce(",")),Ce(ye(Ie)),xe(Fe(e=>[Object.assign({type:"fncall"},e[0])])(e=>it(e)),rt,Fe(e=>[Object.assign({type:"field"},e[0])])(at)))),Ce(ye(Ie)),Ce(ce(")"))),lt=Fe(e=>[{query:e[0]}])(Ce(ce("("),ye(Ie)),e=>Tt(e),Ce(ye(Ie),ce(")"))),ct=Fe(e=>[e])(Ce(ce("("),ye(Ie)),rt,Ce(ye(Ie)),ye(_e(Ce(ce(","),ye(Ie)),rt)),Ce(ye(Ie),ce(")"))),ut=Fe(e=>[Object.assign(Object.assign({},e[0]),{aliasName:e.length>1?e[1]:null})])(Me,xe(Fe(e=>[Object.assign({type:"fncall"},e[0])])(it),Fe(e=>[Object.assign({type:"field"},e[0])])(at),Fe(e=>[Object.assign({type:"subquery"},e[0])])(lt)),xe(_e(Ce(ye(Ie)),Me,ot),be(()=>null))),ft=Fe(e=>[{select:e}])(ut,Ce(ye(Ie)),ye(_e(Ce(ce(",")),Ce(ye(Ie)),ut,Ce(ye(Ie))))),dt=Fe(e=>[{from:e}])(Ce(Pe("from")),Fe(e=>{var t;return[Object.assign(Object.assign({},e[0]),{aliasName:null!==(t=e[1])&&void 0!==t?t:null})]})(Ce(we(1)(Ie)),Me,at,we(0,1)(_e(Ce(we(1)(Ie)),Me,ot))),ye(Fe(e=>{var t;return[Object.assign(Object.assign({},e[0]),{aliasName:null!==(t=e[1])&&void 0!==t?t:null})]})(Ce(ye(Ie),ce(","),ye(Ie)),Me,at,xe(_e(Ce(we(1)(Ie)),Me,ot),be(()=>null))))),pt=xe(le("!="),le("<="),le(">="),le("="),le("<"),le(">"),Fe(e=>[`${e[0]}_${e[1]}`])(Pe("not"),Ce(we(1)(Ie)),xe(Pe("like"),Pe("in")),Ce(Re,ye(Ie))),_e(Pe("like"),Ce(Re,ye(Ie))),_e(Pe("in"),Ce(Re,ye(Ie))),_e(Pe("includes"),Ce(Re,ye(Ie))),_e(Pe("excludes"),Ce(Re,ye(Ie)))),mt=ie.trans(e=>{return[(t="not",n=e[1],{type:"condition",op:t,operands:[n]})];var t,n})(ie.clsFn(e=>Te(e,"not")),ie.clsFn(e=>!0)),gt=ie.trans(e=>[De("and",e[0],e[2])])(ie.clsFn(e=>!0),ie.clsFn(e=>Te(e,"and")),ie.clsFn(e=>!0)),ht=ie.trans(e=>[De("or",e[0],e[2])])(ie.clsFn(e=>!0),ie.clsFn(e=>Te(e,"or")),ie.clsFn(e=>!0)),yt=Fe(e=>[{type:"condition",op:e[1],operands:e.slice(0,1).concat(e.slice(2))}])(Me,xe(Fe(e=>[Object.assign({type:"fncall"},e[0])])(it),Fe(e=>[Object.assign({type:"field"},e[0])])(at)),Ce(ye(Ie)),pt,Ce(ye(Ie)),xe(rt,Fe(e=>[Object.assign({type:"subquery"},e[0])])(lt),Fe(e=>[Object.assign({type:"fncall"},e[0])])(it),ct)),wt=Fe(e=>e)(we(0,1)(_e(Fe(e=>[{type:"rawop",op:e[0]}])(Pe("not")),Ce(Re,ye(Ie)))),xe(Fe(e=>e)(Ce(ye(Ie)),Ce(ce("(")),Ce(ye(Ie)),e=>bt(e),Ce(ye(Ie)),Ce(ce(")"))),yt),ye(_e(Ce(ye(Ie)),Fe(e=>[{type:"rawop",op:e[0]}])(xe(Pe("and"),Pe("or"))),Ce(Re,ye(Ie)),e=>bt(e)))),bt=je({rules:[mt,gt,ht],check:ie.combine(ie.classes.any,ie.end())})(Fe(e=>e)(wt)),vt=Fe(e=>[{where:[e[0]]}])(Ce(ye(Ie),Re),Ce(Pe("where")),Ce(xe(Oe(ce("(")),we(1)(Ie),_e(ye(Ie),Re))),bt),kt=Fe(e=>[{groupBy:e}])(Ce(ye(Ie),Re),Ce(Pe("group"),we(1)(Ie),Pe("by"),we(1)(Ie)),ot,ye(_e(Ce(ye(Ie),ce(","),ye(Ie)),ot))),At=Fe(e=>[{type:"condition",op:e[1],operands:e.slice(0,1).concat(e.slice(2))}])(Me,Fe(e=>[Object.assign({type:"fncall"},e[0])])(it),Ce(ye(Ie)),pt,Ce(ye(Ie)),xe(rt,Fe(e=>[Object.assign({type:"subquery"},e[0])])(lt,Fe(e=>[Object.assign({type:"fncall"},e[0])])(it),ct))),xt=Fe(e=>e)(we(0,1)(_e(Fe(e=>[{type:"rawop",op:e[0]}])(Pe("not")),Ce(Re,ye(Ie)))),xe(Fe(e=>e)(Ce(ye(Ie)),Ce(ce("(")),Ce(ye(Ie)),e=>Nt(e),Ce(ye(Ie)),Ce(ce(")"))),At),ye(_e(Ce(ye(Ie)),Fe(e=>[{type:"rawop",op:e[0]}])(xe(Pe("and"),Pe("or"))),Ce(Re,ye(Ie)),e=>Nt(e)))),Nt=je({rules:[mt,gt,ht],check:ie.combine(ie.classes.any,ie.end())})(Fe(e=>e)(xt)),_t=Fe(e=>[{having:[e[0]]}])(Ce(ye(Ie),Re),Ce(Pe("having")),Ce(xe(Oe(ce("(")),we(1)(Ie),_e(ye(Ie),Re))),Nt),Ct=xe(we(1,1)(_e(Ce(we(1)(Ie)),Fe(e=>[e[0].toLowerCase()])(xe(Pe("asc"),Pe("desc"))),Ce(Re))),be(()=>"asc")),Ft=xe(we(1,1)(_e(Ce(we(1)(Ie),Pe("nulls"),we(1)(Ie)),Fe(e=>[e[0].toLowerCase()])(xe(Pe("first"),Pe("last"))),Ce(Re))),be(()=>"first")),Ot=Fe(e=>[{orderBy:e}])(Ce(ye(Ie),Re),Ce(Pe("order"),we(1)(Ie),Pe("by"),we(1)(Ie)),Fe(e=>[Object.assign(Object.assign({},e[0]),{direction:e[1],nulls:e[2]})])(at,Ct,Ft),ye(_e(Ce(ye(Ie),ce(","),ye(Ie)),Fe(e=>[Object.assign(Object.assign({},e[0]),{direction:e[1],nulls:e[2]})])(at,Ct,Ft)))),jt=Fe(e=>[{offset:e[0]}])(Ce(ye(Ie),Re),Ce(Pe("offset"),we(1)(Ie)),Ge),Et=Fe(e=>[{limit:e[0]}])(Ce(ye(Ie),Re),Ce(Pe("limit"),we(1)(Ie)),Ge),Pt=Fe(e=>[{for:e.map(e=>e.toLowerCase())}])(Ce(ye(Ie),Re),Ce(Pe("for"),we(1)(Ie)),xe(_e(Pe("view"),we(0,1)(_e(Ce(ye(Ie),ce(","),ye(Ie)),Pe("reference")))),_e(Pe("reference"),we(0,1)(_e(Ce(ye(Ie),ce(","),ye(Ie)),Pe("view"))))),Ce(Re)),Dt=Fe(e=>[{for:e.map(e=>e.toLowerCase())}])(Ce(ye(Ie),Re),Ce(Pe("for"),we(1)(Ie)),Pe("update"),xe(_e(Ce(we(1)(Ie)),Pe("tracking"),we(0,1)(_e(Ce(ye(Ie),ce(","),ye(Ie)),Pe("viewstat")))),_e(Ce(we(1)(Ie)),Pe("viewstat"),we(0,1)(_e(Ce(ye(Ie),ce(","),ye(Ie)),Pe("tracking")))),be(()=>{})),Ce(Re)),Tt=Fe(e=>{let t={};for(const n of e)t=Object.assign(Object.assign({},t),n);return[t]})(Ce(Pe("select")),Ce(we(1)(Ie)),ft,dt,we(0,1)(vt),we(0,1)(_e(kt,we(0,1)(_t))),we(0,1)(Ot),we(0,1)(xe(_e(jt,we(0,1)(Et)),_e(Et,we(0,1)(jt)))),we(0,1)(xe(Pt,Dt)),Ce(ye(Ie))),St=Ee(_e(ke(),Ce(ye(Ie)),Tt,Ce(ye(Ie)),Ae()));function Lt(e,t){const n=t.name.slice(0,t.name.length-1);return e.from.find(e=>f(e.name,n))}function It(e,t,n,r){var s;const o=null!==(s=Lt(e,t))&&void 0!==s?s:n;o&&r(o).add(t.name[t.name.length-1])}function qt(e,t,n){const r=(t,n)=>{const r=[];qt(r,t,n),n.operands=r,e.push(n)};switch(n.op){case"and":case"or":case"not":n.op===t?(()=>{for(const s of n.operands)switch(typeof s){case"object":if(null===s||Array.isArray(s))throw new Error("Unexpected AST is found.");switch(s.type){case"condition":switch(s.op){case"and":case"or":case"not":"not"!==s.op&&s.op===t?qt(e,s.op,s):r(s.op,s);break;default:e.push(s)}break;default:throw new Error(`Unexpected AST ${s.type} is found.`)}break;default:throw new Error("Unexpected AST is found.")}})():r(n.op,n);break;default:e.push(n)}}function Mt(e,t){for(const n of e.args)switch(typeof n){case"object":if(null===n);else switch(n.type){case"field":t(n);break;case"fncall":Mt(n,t)}}}function $t(e,t){switch(e.type){case"condition":for(const n of e.operands)switch(typeof n){case"object":if(null===n);else if(Array.isArray(n));else switch(n.type){case"condition":$t(n,t);break;case"field":t(n);break;case"fncall":for(const e of n.args)switch(typeof e){case"object":if(null===e);else switch(e.type){case"field":t(e);break;case"fncall":Mt(e,t)}}}}}return e}function Rt(e,t,n,r){var s,o,a,i;const l=new Map(null!=r?r:[]);if(0===n.length&&t.from[0].name.length>1)throw new Error("Relationship name is not allowed at first item of root level from clause.");{const e=t.from[0];if(t.from[0].name.length>1)for(;l.has(e.name[0].toLowerCase());)e.name=l.get(e.name[0].toLowerCase()).concat(e.name.slice(1));if(n.length>0&&(e.name=d(n,e.name),!f(e.name.slice(0,n.length),n)))throw new Error(`Resolver name ${e.name.join(".")} is not match to parent resolver ${n.join(".")}`)}const c=t.from[0].name;t.from[0].aliasName&&l.set(t.from[0].aliasName.toLowerCase(),c),t.whereSubQueries=[],t.havingSubQueries=[],t.selectSubQueries=[];for(const e of t.from.slice(1)){if(1===e.name.length)e.name=c.concat(e.name);else{let t=e.name[0].toLowerCase();for(;l.has(t);)e.name=l.get(t).concat(e.name.slice(1)),t=e.name[0].toLowerCase();e.name=d(c,e.name)}e.aliasName&&l.set(e.aliasName.toLowerCase(),e.name)}const u=new Map;let m="select";const g=e=>{switch(m){case"select":e.aliasName&&u.set(e.aliasName.toLowerCase(),e.name);break;case"where":case"having":case"orderby":if(1===e.name.length){const t=e.name[0].toLowerCase();u.has(t)&&(e.name=u.get(t))}}if(1===e.name.length)e.name=c.concat(e.name);else{let n=e.name[0].toLowerCase();for(;l.has(n);)e.name=l.get(n).concat(e.name.slice(1)),n=e.name[0].toLowerCase();e.name=d(c,e.name);const r=e.name.slice(0,e.name.length-1);t.from.find(e=>f(e.name,r))||t.from.push({name:r,aliasName:null})}return e},h=(n,r)=>{const s=n.fn.toLowerCase(),o=e.functions.find(e=>e.name.toLowerCase()===s);if(!o)throw new Error(`Function '${n.fn}' is not found.`);switch(m){case"select":"aggregate"!==o.type||t.groupBy||(t.groupBy=[]);break;case"where":if("aggregate"===o.type)throw new Error(`Aggregate function '${n.fn}' is not allowed.`);if(0!==r&&"immediate-scalar"!==o.type)throw new Error(`Function '${n.fn}' is not allowed at operand ${r+1}.`);break;case"having":if(0!==r&&"immediate-scalar"!==o.type)throw new Error(`Function '${n.fn}' is not allowed at operand ${r+1}.`)}for(const e of n.args)switch(typeof e){case"object":if(null===e);else switch(e.type){case"field":g(e);break;case"fncall":h(e,0)}}return n},y=n=>{switch(n.type){case"condition":for(let r=0;r<n.operands.length;r++){const s=n.operands[r];switch(typeof s){case"object":if(null===s);else if(Array.isArray(s));else switch(s.type){case"condition":y(s);break;case"field":g(s);break;case"fncall":h(s,r);break;case"subquery":("where"===m?t.whereSubQueries:t.havingSubQueries).push(s),s.query=Rt(e,s.query,[],null)}}}}return n};for(let n=0;n<t.select.length;n++){const r=t.select[n];switch(r.type){case"field":g(r);break;case"fncall":h(r,n);break;case"subquery":t.selectSubQueries.push(r),r.query=Rt(e,r.query,c,l)}}if(t.where&&(m="where",y(t.where[0])),t.having&&(m="having",y(t.having[0])),t.orderBy){m="orderby";for(const e of t.orderBy)g(e)}for(const e of t.from)e.queryFields=new Set,e.queryFieldsMap=new Map,e.condFields=new Set,e.condAliasFields=new Set,e.havingCondFields=new Set,e.relationshipIdFields=new Set;const w=e=>It(t,e,t.from[0],e=>e.queryFields),b=e=>It(t,e,t.from[0],e=>e.condFields),v=e=>It(t,e,t.from[0],e=>e.havingCondFields);let k=0;const A=(e,n)=>{n||e.aliasName||(e.aliasName="expr"+k++);let r=void 0;for(const n of e.args)switch(typeof n){case"object":if(null===n);else switch(n.type){case"field":w(n),r||(r=Lt(t,n));break;case"fncall":{const e=A(n,!0);r||(r=e)}}}return n||(null!=r?r:t.from[0]).queryFieldsMap.set(e.aliasName,e),r};for(const e of t.select)switch(e.type){case"field":{w(e);const n=Lt(t,e);null==n||n.queryFieldsMap.set(e.name[e.name.length-1],e)}break;case"fncall":A(e,!1)}if(t.where&&$t(t.where[0],b),t.having&&$t(t.having[0],v),t.groupBy)for(const e of t.groupBy)t.from[0].havingCondFields.add(e);t.from[0].name=c;const x=p(e.relationships,c[0]);if(!x)throw new Error(`Resolver '${c[0]}' is not found.`);const N=function e(t,n,r){const s=r.resolverName.toLowerCase(),o=r.fieldOrRelName.toLowerCase(),a=p(t.relationships,r.resolverName);if(!a)throw new Error(`Resolver '${r.resolverName}' is not found.`);const i=n.find(e=>e.resolverName.toLowerCase()===s&&e.fieldOrRelName.toLowerCase()===o);if(i)return i;const l=[],c={fieldOrRelName:r.fieldOrRelName,resolverName:a,direction:r.direction,children:l},u=t.relationships[a],f=n.concat([c]);for(const n of Object.keys(u)){const r=u[n];Array.isArray(r)?l.push(e(t,f,{resolverName:r[0],fieldOrRelName:n,direction:2})):"string"==typeof r?l.push(e(t,f,{resolverName:r,fieldOrRelName:n,direction:1})):l.push(e(t,f,{resolverName:r.resolver,fieldOrRelName:n,direction:1}))}return c}(e,[],{resolverName:x,fieldOrRelName:x,direction:1});for(const n of t.from){let t,r=[N];for(let e=0;e<n.name.length;e++){const s=n.name[e],o=s.toLowerCase(),a=r.find(e=>e.fieldOrRelName.toLowerCase()===o);if(!a)throw new Error(`Resolver '${s}' is not found.`);t=a,r=a.children,n.name[e]=a.fieldOrRelName}t&&(n.resolver=e.resolvers.query[t.resolverName],n.resolverName=t.resolverName)}if(t.where){const e=[];qt(e,"and",t.where[0]),t.where=e}if(t.having){const e=[];qt(e,"and",t.having[0]),t.having=e}t.from=t.from.slice(0,1).concat(t.from.slice(1).sort((e,t)=>e.name.length-t.name.length));for(let n=0;n<t.from.length;n++){const r=t.from[n];r.fieldAliasNames=new Set(Array.from(r.queryFieldsMap.entries()).map(e=>{const t=e[1];return t.aliasName&&!r.queryFields.has(t.aliasName)?t.aliasName.toLowerCase():""}).filter(e=>!!e));for(const e of r.fieldAliasNames)r.condFields.has(e)&&(r.condFields.delete(e),r.condAliasFields.add(e));r.sortFieldNames=new Set(t.orderBy?t.orderBy.filter(e=>r.name.length+1===e.name.length&&f(r.name,e.name.slice(0,r.name.length))).filter(e=>!r.fieldAliasNames.has(e.name[e.name.length-1].toLowerCase())).map(e=>e.name[e.name.length-1]):[]);{const l=null!==(s=r.resolverName)&&void 0!==s?s:"";for(let s=n+1;s<t.from.length;s++){const n=t.from[s];if(r.name.length+1===n.name.length&&f(r.name,n.name.slice(0,r.name.length))){const t=null!==(o=n.resolverName)&&void 0!==o?o:"",s=null!==(i=(null!==(a=e.relationships[l])&&void 0!==a?a:{})[t])&&void 0!==i?i:{},c=s.id?s.id:e.rules.foreignIdFieldName(t);c&&r.relationshipIdFields.add(c)}}}}return t}function Ut(e){const t=Date.UTC(e.getUTCFullYear(),0,1);return(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())-t)/864e5+1}function Bt(e){const t=Date.UTC(e.getFullYear(),0,1);return(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())-t)/864e5+1}const Qt={type:"scalar",name:"cast_to_string",fn:(e,t,n)=>{if(t.length>0)return null===t[0]?null:String(t[0]);throw new Error('Argument of function "cast_to_string" should be field.')}},Wt={type:"scalar",name:"cast_to_number",fn:(e,t,n)=>{if(t.length>0)return null===t[0]?null:Number(t[0]);throw new Error('Argument of function "cast_to_number" should be field.')}},zt={type:"scalar",name:"cast_to_boolean",fn:(e,t,n)=>{if(t.length>0)return null===t[0]?null:Boolean(t[0]);throw new Error('Argument of function "cast_to_boolean" should be field.')}},Jt={type:"scalar",name:"concat",fn:(e,t,n)=>{if(t.length>0){const e=t.filter(e=>null!==e);return 0===e.length?null:e.map(e=>String(e)).join("")}throw new Error('Argument of function "concat" should be field.')}},Yt={type:"scalar",name:"add",fn:(e,t,n)=>{if(t.length>1){const e=t.filter(e=>null!==e);return 0===e.length?null:e.map(e=>Number(e)).reduce((e,t)=>e+t)}throw new Error('Argument of function "add" should be field.')}},Zt={type:"scalar",name:"sub",fn:(e,t,n)=>{if(t.length>1)return null===t[0]?null:t.filter(e=>null!==e).map(e=>Number(e)).reduce((e,t)=>e-t);throw new Error('Argument of function "sub" should be field.')}},Ht={type:"scalar",name:"mul",fn:(e,t,n)=>{if(t.length>1){const e=t.filter(e=>null!==e);return 0===e.length?null:e.map(e=>Number(e)).reduce((e,t)=>e*t)}throw new Error('Argument of function "mul" should be field.')}},Gt={type:"scalar",name:"div",fn:(e,t,n)=>{if(t.length>1)return null===t[0]?null:t.filter(e=>null!==e).map(e=>Number(e)).reduce((e,t)=>e/t);throw new Error('Argument of function "div" should be field.')}},Kt={type:"scalar",name:"mod",fn:(e,t,n)=>{if(t.length>1)return null===t[0]?null:t.filter(e=>null!==e).map(e=>Number(e)).reduce((e,t)=>e%t);throw new Error('Argument of function "div" should be field.')}},Vt={type:"aggregate",name:"count",fn:(e,t,n)=>{if(0===t.length)return n.length;{const e=t[0];if(Array.isArray(e))return e.filter(e=>null!=e).length;throw new Error('Argument of function "count" should be field.')}}},Xt={type:"aggregate",name:"count_distinct",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>null!=e).map(e=>JSON.stringify(e));return new Set(t).size}}throw new Error('Argument of function "count_distinct" should be field.')}},en={type:"aggregate",name:"sum",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e));return t.length?t.reduce((e,t)=>e+t):null}}throw new Error('Argument of function "sum" should be field.')}},tn={type:"aggregate",name:"avg",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e));return t.length?t.reduce((e,t)=>e+t)/t.length:null}}throw new Error('Argument of function "avg" should be field.')}},nn={type:"aggregate",name:"max",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e)||"string"==typeof e);return t.length?t.reduce((e,t)=>e>t?e:t):null}}throw new Error('Argument of function "max" should be field.')}},rn={type:"aggregate",name:"min",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e)||"string"==typeof e);return t.length?t.reduce((e,t)=>e<t?e:t):null}}throw new Error('Argument of function "min" should be field.')}};function sn(e,t){return(n,r,s)=>{if(r.length>0){const e=r[0];switch(typeof e){case"object":if(null===e)return null;switch(e.type){case"date":case"datetime":return t(e.value);default:return null}case"string":return a.test(e)||i.test(e)?t(e):null}}throw new Error(`Argument of function "${e}" should be field.`)}}const on={type:"scalar",name:"calendar_month",fn:sn("calendar_month",e=>new Date(e).getUTCMonth()+1)},an={type:"scalar",name:"calendar_month_lc",fn:sn("calendar_month_lc",e=>new Date(e).getMonth()+1)},ln={type:"scalar",name:"calendar_quarter",fn:sn("calendar_quarter",e=>Math.floor(new Date(e).getUTCMonth()/3)+1)},cn={type:"scalar",name:"calendar_quarter_lc",fn:sn("calendar_quarter_lc",e=>Math.floor(new Date(e).getMonth()/3)+1)},un={type:"scalar",name:"calendar_year",fn:sn("calendar_year",e=>new Date(e).getUTCFullYear())},fn={type:"scalar",name:"calendar_year_lc",fn:sn("calendar_year_lc",e=>new Date(e).getFullYear())},dn={type:"scalar",name:"day_in_month",fn:sn("day_in_month",e=>new Date(e).getUTCDate())},pn={type:"scalar",name:"day_in_month_lc",fn:sn("day_in_month_lc",e=>new Date(e).getDate())},mn={type:"scalar",name:"day_in_week",fn:sn("day_in_week",e=>new Date(e).getUTCDay()+1)},gn={type:"scalar",name:"day_in_week_lc",fn:sn("day_in_week_lc",e=>new Date(e).getDay()+1)},hn={type:"scalar",name:"day_in_year",fn:sn("day_in_year",e=>Ut(new Date(e)))},yn={type:"scalar",name:"day_in_year_lc",fn:sn("day_in_year_lc",e=>Bt(new Date(e)))},wn={type:"scalar",name:"day_only",fn:sn("day_only",e=>new Date(e).toISOString().split("T")[0])},bn={type:"scalar",name:"day_only_lc",fn:sn("day_only_lc",e=>{const t=new Date(e);return new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())).toISOString().split("T")[0]})},vn={type:"scalar",name:"hour_in_day",fn:sn("hour_in_day",e=>new Date(e).getUTCHours())},kn={type:"scalar",name:"hour_in_day_lc",fn:sn("hour_in_day_lc",e=>new Date(e).getHours())},An={type:"scalar",name:"week_in_month",fn:sn("week_in_month",e=>Math.floor((new Date(e).getUTCDate()-1)/7)+1)},xn={type:"scalar",name:"week_in_month_lc",fn:sn("week_in_month_lc",e=>Math.floor((new Date(e).getDate()-1)/7)+1)},Nn=[Qt,Wt,zt,Jt,Yt,Zt,Ht,Gt,Kt,Vt,Xt,en,tn,nn,rn,on,ln,un,dn,mn,hn,wn,vn,An,{type:"scalar",name:"week_in_year",fn:sn("week_in_year",e=>Math.floor((Ut(new Date(e))-1)/7)+1)},an,cn,fn,pn,gn,yn,bn,kn,xn,{type:"scalar",name:"week_in_year_lc",fn:sn("week_in_year_lc",e=>Math.floor((Bt(new Date(e))-1)/7)+1)}],_n={idFieldName:()=>"Id",foreignIdFieldName:e=>e?e+"Id":void 0};function Cn(e,t,...n){return function(e,t){return Rt(e,t,[],null)}(e,function(e,...t){const n=St("string"==typeof e?U(e,{}):function(e,t,n){const r=[];let s=0;if(t.length)for(let n=0;n<e.length;n++){const o=e[n];n<t.length&&(r.push(s+o.length),s+=o.length+1)}const o=e.join("\0");return{src:o,start:0,end:o.length,context:n,templateArgs:t,templateArgsPos:r}}(e,t,{}));if(!n.succeeded)throw new Error(B(n));return n.tokens[0]}(t,...n))}var Fn=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function i(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};function On(e){switch(e.op){case"true":return!1;case"not":case"and":case"or":if(0===e.operands.length)return!1}return!0}function jn(e,t){if(t.operands.length){const n=t.operands[0];switch(typeof n){case"object":if(null===n);else if(Array.isArray(n));else switch(n.type){case"field":if(!f(e,n.name.slice(0,n.name.length-1)))return{type:"condition",op:"true",operands:[]};n.name=n.name.slice(n.name.length-1);break;case"fncall":{const t=function e(t,n){for(const r of n.args)switch(typeof r){case"object":if(null===r);else switch(r.type){case"field":if(!f(t,r.name.slice(0,r.name.length-1)))return{type:"condition",op:"true",operands:[]};r.name=r.name.slice(r.name.length-1);break;case"fncall":{const n=e(t,r);if(n)return n}}}return null}(e,n);if(t)return t}}}}return function(e,t){return t.operands=t.operands.map(t=>{switch(typeof t){case"object":if(Array.isArray(t))return t;if(null===t)return t;switch(t.type){case"condition":return jn(e,t);default:return t}default:return t}}).filter(e=>{switch(typeof e){case"object":if(null!==e&&!Array.isArray(e)&&"condition"===e.type)return On(e)}return!0}),t}(e,t)}function En(e,t,n,r,s){return Fn(this,void 0,void 0,(function*(){const o=[];r.forEach(e=>function e(t,n){switch(n.type){case"condition":for(let r=0;r<n.operands.length;r++){const s=n.operands[r];switch(typeof s){case"object":if(null===s);else if(Array.isArray(s));else switch(s.type){case"condition":e(t,s);break;case"subquery":t.push({cond:n,index:r,subQuery:s})}}}}return n}(o,e));const a=o.map(r=>In(e,t,n,r.subQuery.query,null,null,null,s).then(e=>({cond:r.cond,index:r.index,subQuery:r.subQuery,result:e})));(yield Promise.all(a)).map(e=>{var t;const n=e.subQuery.query.select[0];let r="";switch(n.type){case"field":r=n.name[n.name.length-1];break;default:r=null!==(t=n.aliasName)&&void 0!==t?t:""}if(e.result.length){const t=new Map(Object.keys(e.result[0]).map(e=>[e.toLowerCase(),e]));e.cond.operands[e.index]=e.result.map(e=>g(t,e,r))}else e.cond.operands[e.index]=[]})}))}function Pn(e,t,n,r){const s=new Array(t.queryFieldsMap.size),o=new Array(t.queryFieldsMap.size),a=(t,n,r,s)=>{const a=o[t];s[r.aliasName]=A(e,r,a,"any",s,null)},i=(t,n,r,s)=>{const a=o[t];s[r.aliasName]=x(e,r,a,"any",s,null)},l=(e,t,n,r)=>{};{let n=0;for(const c of t.queryFieldsMap.entries()){const[t,u]=c;switch(u.type){case"field":s[n]={isField:!0,fieldName:t,field:u,fn:l};break;case"fncall":if(r)s[n]={isField:!1,fieldName:t,field:u,fn:l};else{const r=u.fn.toLowerCase(),c=e.functions.find(e=>e.name.toLowerCase()===r);switch(o[n]=c,null==c?void 0:c.type){case"scalar":s[n]={isField:!1,fieldName:t,field:u,fn:a};break;case"immediate-scalar":s[n]={isField:!1,fieldName:t,field:u,fn:i};break;default:s[n]={isField:!1,fieldName:t,field:u,fn:l}}}break;default:s[n]={isField:!1,fieldName:t,field:u,fn:l}}n++}}for(const e of n)for(let t=0;t<s.length;t++){const{isField:n,fieldName:r,field:o,fn:a}=s[t];n?o.aliasName&&(e[o.aliasName]=e[r]):a(t,r,o,e)}return n}function Dn(e,t,n,r){if(0===r.length)return[];if(1===r.length||0===t.length)return[r];const s=new Map;if(r.length){let e=0;const n=new Map(Object.keys(r[0]).map(e=>[e.toLowerCase(),e]));for(const o of r){const r=[];for(const s of t){let t=g(n,o,s);null==t&&(t="__$$GENSYM_VT4iHbNbZW3C7taC7J6bx8pruw40cX5X$$_"+e++),r.push(t)}const a=JSON.stringify(r);if(s.has(a)){s.get(a).push(o)}else s.set(a,[o])}}return Array.from(s.values())}function Tn(e,t,n,r){var s,o;const a=[];if(!r.length)return a;const i=r[0][0],l=new Map(t.map(e=>{var t;return[e.toLowerCase(),null!==(t=p(i,e))&&void 0!==t?t:""]})),c=new Array(n.queryFieldsMap.size),u=new Array(n.queryFieldsMap.size),f=(t,n,r,s)=>{const o=u[t];s[n.aliasName]=N(e,n,o,"any",r)},d=(t,n,r,s)=>{const o=u[t];s[n.aliasName]=x(e,n,o,"any",null,r)},m=(t,n,r,s)=>{const o=u[t];s[n.aliasName]=A(e,n,o,"any",r[0],r)},g=(e,t,n,r)=>{};{let t=0;for(const r of n.queryFieldsMap.entries()){const[,n]=r;switch(n.type){case"field":{const e=_(l,n.name[n.name.length-1]);if(!e)throw new Error(n.name.join(".")+" is not allowed. Aggregate function is needed.");c[t]={isField:!0,field:n,trueCaseName:e,fn:g}}break;case"fncall":{const r=n.fn.toLowerCase(),a=e.functions.find(e=>e.name.toLowerCase()===r);switch(u[t]=a,null==a?void 0:a.type){case"aggregate":c[t]={isField:!1,field:n,trueCaseName:"",fn:f};break;case"immediate-scalar":c[t]={isField:!1,field:n,trueCaseName:"",fn:d};break;case"scalar":if(!C(e,l,n.args))throw new Error((null!==(s=n.aliasName)&&void 0!==s?s:"(unnamed)")+" is not allowed. Aggregate function is needed.");c[t]={isField:!1,field:n,trueCaseName:"",fn:m};break;default:throw new Error((null!==(o=n.aliasName)&&void 0!==o?o:"(unnamed)")+" is not allowed. Aggregate function is needed.")}}break;default:c[t]={isField:!1,field:n,trueCaseName:"",fn:g}}t++}}for(const e of r){const t={};for(let n=0;n<c.length;n++){const{isField:r,field:s,trueCaseName:o,fn:a}=c[n];r?(t[o]=e[0][o],s.aliasName&&(t[s.aliasName]=e[0][o])):a(n,s,e,t)}a.push(t)}return a}function Sn(e,t,n){const r=new Set;if(t.length){const s=new Set,o=t[0];for(const t of e.queryFieldsMap.entries()){const e=t[1];if(n&&"field"===e.type&&e.aliasName)s.add(e.aliasName);else{const e=p(o,t[0]);e&&s.add(e)}}for(const e of Object.keys(o))s.has(e)||r.add(e)}return r}function Ln(e,t,n,r){var s,o,a,i;const l=0===r?"master":"detail",c=JSON.stringify(n.name.slice(0,n.name.length-1)),u=JSON.stringify(n.name),f=null!==(s=n.resolverName)&&void 0!==s?s:"",d=t.get(c),p=null!==(i=0===r?(null!==(o=e.relationships[f])&&void 0!==o?o:{})[d]:(null!==(a=e.relationships[d])&&void 0!==a?a:{})[f])&&void 0!==i?i:{};return{parentType:l,parentKey:c,currentKey:u,resolverName:f,parentResolverName:d,masterRelationshipInfo:p,foreignIdField:"object"==typeof p&&p.id?p.id:0===r?e.rules.foreignIdFieldName(d):e.rules.foreignIdFieldName(f),parentIdFieldName:d?e.rules.idFieldName(d):void 0,currentIdFieldName:e.rules.idFieldName(f)}}function In(e,t,n,r,s,o,a,i){var l,c;return Fn(this,void 0,void 0,(function*(){let f,d;const p=null!=o?o:new Map,m=null!=a?a:new Map,g=null!=i?i:{};!s&&e.events.beginExecute&&(yield e.events.beginExecute({resolverData:g,transactionData:t,transactionOptions:n}));try{const o=r.where?u(r.where):[],a=r.having?u(r.having):[];yield En(e,t,n,o,g),yield En(e,t,n,a,g);const i=[],h=new Map;for(let y=0;y<r.from.length;y++){const w=r.from[y],{parentType:b,parentKey:v,currentKey:k,resolverName:A,parentResolverName:x,foreignIdField:N,parentIdFieldName:_,currentIdFieldName:C}=Ln(e,m,w,y);if(!w.resolver)throw new Error(`Resolver name ${w.name.join(".")} is not resolved.`);let F=[];const O=p.get(v),j=w.condAliasFields.size>0,E=!(0!==y||!r.groupBy),P=Array.from(w.queryFields.values()),D=Array.from(w.condFields.values()),T=Array.from(w.havingCondFields.values()),S=0===y&&r.groupBy?r.groupBy:[],L=Array.from(w.sortFieldNames.values()),I=Array.from(w.relationshipIdFields.values()),$=Array.from(new Set(P.concat(D).concat(T).concat(e.rules.idFieldName?[e.rules.idFieldName(A)]:[]).concat(S).concat(L).concat(I)).values()),R=u(o).map(e=>jn(w.name,e)).filter(On),U=u(a).map(e=>jn(w.name,e)).filter(On),B={functions:e.functions,query:r,graphPath:w.name,resolverName:A,parentResolverName:x,parentType:b,foreignIdField:N,masterIdField:0===y?_:C,detailIdField:0===y?C:_,parentRecords:O,conditions:R,resolverData:g,transactionData:t,transactionOptions:n};if(0===y){const e=Object.assign(Object.assign({},B),{parent:s,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}});if(F=yield w.resolver($,j?[]:R,E||j?null:null!==(l=r.limit)&&void 0!==l?l:null,E||j?null:null!==(c=r.offset)&&void 0!==c?c:null,e),d=e.resolverCapabilities,j&&(d.filtering=!1,d.limit=!1,d.offset=!1,d.sorting=!1),j&&(F=Pn(B,w,F,E)),e.resolverCapabilities.filtering||(F=q(B,R,F)),j||(F=Pn(B,w,F,E)),E){d.limit=!1,d.offset=!1,d.sorting=!1;const e=M(B,U,Dn(0,S,0,F));F=Tn(B,S,w,e)}f=F}else if(O&&O.length){e.events.beforeMasterSubQueries&&(yield e.events.beforeMasterSubQueries(B));const t=w.name[w.name.length-1];for(const e of O){const n=Object.assign(Object.assign({},B),{parent:e,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}});let r=(yield w.resolver($,j?[]:R,1,0,n)).slice(0,1);j&&(n.resolverCapabilities.filtering=!1,n.resolverCapabilities.limit=!1,n.resolverCapabilities.offset=!1,n.resolverCapabilities.sorting=!1),j&&(r=Pn(B,w,r,E)),n.resolverCapabilities.filtering||(r=q(B,R,r)),j||(r=Pn(B,w,r,E)),e[t]=r.length>0?r[0]:null,F=F.concat(r)}e.events.afterMasterSubQueries&&(yield e.events.afterMasterSubQueries(B));const n=h.get(v);n&&n.delete(t)}const Q=Sn(w,F,E);i.push([Q,F]),h.set(k,Q),p.set(k,F),m.set(k,A)}if(r.selectSubQueries&&f){const s=[];for(const o of r.selectSubQueries){const r=o.query.from[0].name,a=JSON.stringify(r.slice(0,r.length-1)),i=p.get(a);if(i){const{parentType:a,resolverName:l,parentResolverName:c,foreignIdField:u,parentIdFieldName:f,currentIdFieldName:d}=Ln(e,m,o.query.from[0],0);e.events.beforeDetailSubQueries&&(yield e.events.beforeDetailSubQueries({functions:e.functions,query:o.query,graphPath:r,resolverName:l,parentResolverName:c,parentType:a,foreignIdField:u,masterIdField:f,detailIdField:d,parentRecords:i,resolverData:g,transactionData:t,transactionOptions:n}));for(const a of i)s.push(In(e,t,n,o.query,a,p,m,g).then(e=>({name:r,parent:a,result:e})));e.events.afterDetailSubQueries&&(yield e.events.afterDetailSubQueries({functions:e.functions,query:o.query,graphPath:r,parentRecords:i,resolverData:g,transactionData:t,transactionOptions:n}))}const l=h.get(a);l&&l.delete(r[r.length-1])}(yield Promise.all(s)).forEach(e=>{e.parent[e.name[e.name.length-1]]=e.result})}f?d&&(d.sorting||(f=$(r,f)),d.offset||d.limit?d.offset?d.limit||"number"==typeof r.limit&&(f=f.slice(0,r.limit)):"number"==typeof r.offset&&(f=f.slice(r.offset)):"number"==typeof r.offset&&"number"==typeof r.limit?f=f.slice(r.offset,r.offset+r.limit):"number"==typeof r.offset?f=f.slice(r.offset):"number"==typeof r.limit&&(f=f.slice(0,r.limit))):f=[];for(const e of i){const[t,n]=e;for(const e of n)for(const n of t)delete e[n]}!s&&e.events.endExecute&&(yield e.events.endExecute({resolverData:g,transactionData:t,transactionOptions:n},null))}catch(r){throw!s&&e.events.endExecute&&(yield e.events.endExecute({resolverData:g,transactionData:t,transactionOptions:n},r)),r}return f}))}var qn=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function i(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};var Mn=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function i(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};function $n(e){const t=function(e){const t=Object.assign({},e);t.relationships||(t.relationships={});for(const e of Object.keys(t.resolvers.query))t.relationships[e]||(t.relationships[e]={});return t.resolvers.insert||(t.resolvers.insert={}),t.resolvers.update||(t.resolvers.update={}),t.resolvers.remove||(t.resolvers.remove={}),t.functions||(t.functions=[]),t.functions=t.functions.concat(Nn),t.rules||(t.rules={}),t.rules=Object.assign(Object.assign({},_n),t.rules),t.events||(t.events={}),t}(e);return function e(n,r,s){function o(e,n,r){return Mn(this,void 0,void 0,(function*(){try{t.events.beginTransaction&&(yield t.events.beginTransaction({resolverData:{},transactionData:e,transactionOptions:n}));const s=yield r(e,n);return t.events.endTransaction&&(yield t.events.endTransaction({resolverData:{},transactionData:e,transactionOptions:n},null)),s}catch(r){throw t.events.endTransaction&&(yield t.events.endTransaction({resolverData:{},transactionData:e,transactionOptions:n},r)),r}}))}return{soql:function(e,...a){return Mn(this,void 0,void 0,(function*(){const i=(n,r)=>Mn(this,void 0,void 0,(function*(){const s=Cn(t,e,...a);return yield In(t,n,r,s,null,null,null,null)}));return s?yield o({},void 0,i):yield i(n,r)}))},insert:function(e,a){return Mn(this,void 0,void 0,(function*(){const i=(n,r)=>Mn(this,void 0,void 0,(function*(){const s=Array.isArray(a),o=yield function(e,t,n,r,s){return qn(this,void 0,void 0,(function*(){const o=e.resolvers.insert;let a=null;for(const e of Object.keys(o))e.toLowerCase()===r.toLowerCase()&&(a=o[e]);if(!a)throw new Error(`Resolver name ${r} is not resolved.`);const i={resolverData:{},transactionData:t,transactionOptions:n};e.events.beginExecute&&(yield e.events.beginExecute(i));let l=null;try{const o={functions:e.functions,graphPath:[],resolverName:r,resolverData:i.resolverData,transactionData:t,transactionOptions:n,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}};l=yield a(s,o),e.events.endExecute&&(yield e.events.endExecute(i,null))}catch(t){throw e.events.endExecute&&(yield e.events.endExecute(i,t)),t}return l}))}(t,n,r,e,s?a:[a]);return s?o:o[0]}));return s?yield o({},void 0,i):yield i(n,r)}))},update:function(e,a){return Mn(this,void 0,void 0,(function*(){const i=(n,r)=>Mn(this,void 0,void 0,(function*(){const s=Array.isArray(a),o=yield function(e,t,n,r,s){return qn(this,void 0,void 0,(function*(){const o=e.resolvers.update;let a=null;for(const e of Object.keys(o))e.toLowerCase()===r.toLowerCase()&&(a=o[e]);if(!a)throw new Error(`Resolver name ${r} is not resolved.`);const i={resolverData:{},transactionData:t,transactionOptions:n};e.events.beginExecute&&(yield e.events.beginExecute(i));let l=null;try{const o={functions:e.functions,graphPath:[],resolverName:r,resolverData:i.resolverData,transactionData:t,transactionOptions:n,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}};l=yield a(s,o),e.events.endExecute&&(yield e.events.endExecute(i,null))}catch(t){throw e.events.endExecute&&(yield e.events.endExecute(i,t)),t}return l}))}(t,n,r,e,s?a:[a]);return s?o:o[0]}));return s?yield o({},void 0,i):yield i(n,r)}))},remove:function(e,a){return Mn(this,void 0,void 0,(function*(){const i=(n,r)=>Mn(this,void 0,void 0,(function*(){return yield function(e,t,n,r,s){return qn(this,void 0,void 0,(function*(){const o=e.resolvers.remove;let a=null;for(const e of Object.keys(o))e.toLowerCase()===r.toLowerCase()&&(a=o[e]);if(!a)throw new Error(`Resolver name ${r} is not resolved.`);const i={resolverData:{},transactionData:t,transactionOptions:n};e.events.beginExecute&&(yield e.events.beginExecute(i));try{const o={functions:e.functions,graphPath:[],resolverName:r,resolverData:i.resolverData,transactionData:t,transactionOptions:n,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}};yield a(s,o),e.events.endExecute&&(yield e.events.endExecute(i,null))}catch(t){throw e.events.endExecute&&(yield e.events.endExecute(i,t)),t}}))}(t,n,r,e,Array.isArray(a)?a:[a])}));return s?yield o({},void 0,i):yield i(n,r)}))},transaction:function(t,n){return Mn(this,void 0,void 0,(function*(){const r={},s=e(r,n,!1);return yield o(r,n,e=>Mn(this,void 0,void 0,(function*(){yield t({soql:s.soql,insert:s.insert,update:s.update,remove:s.remove},r)})))}))}}}({},void 0,!0)}const Rn=ne({rawToToken:e=>e,concatTokens:e=>e.length?[e.reduce((e,t)=>e+t)]:[]}),{seq:Un,cls:Bn,notCls:Qn,classes:Wn,numbers:zn,cat:Jn,repeat:Yn,end:Zn,first:Hn,combine:Gn,erase:Kn,trans:Vn,ahead:Xn,makeProgram:er}=Rn,tr=Vn(e=>[Number.parseInt(e[0].replace(/_/g,""),10)])(zn.int),nr=Hn(Vn(e=>[Number.parseFloat(e[0].replace(/_/g,""))])(zn.float),tr),rr=Vn(e=>[!0])(Un("true")),sr=Vn(e=>[!1])(Un("false")),or=Vn(e=>e.length?e:[""])(Kn(Yn(Wn.spaceWithinSingleLine),Bn('"')),Jn(Yn(Hn(Vn(e=>['"'])(Un('""')),Qn('"')))),Kn(Bn('"'),Yn(Kn(Wn.spaceWithinSingleLine)))),ar=Vn(e=>e.length?e:[null])(Kn(Yn(Wn.spaceWithinSingleLine)),Hn(rr,sr,nr),Kn(Yn(Wn.spaceWithinSingleLine)),Xn(Hn(Bn(",","\r\n","\n","\r"),Zn()))),ir=Vn(e=>e.length?[e[0]?e[0].trim():""]:[null])(Kn(Yn(Wn.spaceWithinSingleLine)),Jn(Yn(Hn(Kn(Wn.spaceWithinSingleLine,Xn(Bn(",","\r\n","\n","\r"))),Qn(",","\r\n","\n","\r"))))),lr=Hn(or,ar,ir),cr=Vn(e=>[e])(lr,Yn(Gn(Kn(Un(",")),lr))),ur=er(Gn(cr,Yn(Gn(Kn(Wn.newline),cr)),Zn()));var fr=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function i(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};const dr={noCache:!1,noFiltering:!1,noSorting:!1};function pr(e){Object.assign(dr,e)}function mr(e){const t=JSON.parse(e);if(!Array.isArray(t))throw new Error("jsonRecordsParser: Records should be array.");return t}function gr(e){const t=function(e){const t=ur(U(e));if(!t.succeeded)throw new Error(B(t));return t.tokens}(e.trim());if(!t.length)throw new Error("csvRecordsParser: Header row is needed.");const n=t[0];for(let e=0;e<n.length;e++)if(c(l,n[e]))throw new Error("Unsafe symbol name is appeared: "+n[e]);const r=[];for(let e=1;e<t.length;e++){const s=t[e],o={};for(let e=0;e<n.length;e++)o[n[e]]=s[e];r.push(o)}return r}function hr(e){return e}function yr(e){return(t,n,r)=>(s,o,a,i,l)=>fr(this,void 0,void 0,(function*(){let c,u=null;l.resolverData.cache?(c=l.resolverData.cache,c.has(t)&&(u=c.get(t))):(c=new Map,r.noCache||(l.resolverData.cache=c));let d=null;if(null===u){const r=yield n();d=e(r),c.set(t,d.map(e=>Object.assign({},e)))}else d=u.map(e=>Object.assign({},e));return function(e,t,n,r,s,o,a){if(!e.length)return e;const i=new Set,l=new Map(Object.keys(e[0]).map(e=>[e.toLowerCase(),e])),c=new Set(t.map(e=>e.toLowerCase()));for(const e of c.keys())if(!l.has(e))throw new Error(`Field "${e}" is not supplied from resolver "${o.resolverName}".`);if(a.noFiltering||(e=q(o,n,e),o.resolverCapabilities.filtering=!0),e.length&&o.parent)switch(o.parentType){case"master":if(o.foreignIdField){const t=m(o.parent,o.masterIdField),n=p(e[0],o.foreignIdField);e=e.filter(e=>e[n]===t)}break;case"detail":if(o.foreignIdField){const t=m(o.parent,o.foreignIdField),n=p(e[0],o.masterIdField);e=e.filter(e=>e[n]===t)}}if(a.noFiltering)return e;if(!a.noSorting&&o.query&&o.query.orderBy){const t=o.query.from[0].name.length;o.graphPath.length===t&&f(o.graphPath,o.query.from[0].name)&&o.query.orderBy.every(e=>e.name.length===t+1&&l.has(e.name[e.name.length-1].toLowerCase()))&&(e=$(o.query,e),o.resolverCapabilities.sorting=!0)}for(const e of l.keys())c.has(e)||i.add(l.get(e));for(const t of e)for(const e of i)delete t[e];return o.resolverCapabilities.sorting&&("number"==typeof s&&(e=e.slice(s)),"number"==typeof r&&(e=e.slice(0,r)),o.resolverCapabilities.limit=!0,o.resolverCapabilities.offset=!0),e}(d,s,o,a,i,l,r)}))}const wr=(e,t,n)=>yr(mr)(e,t,null!=n?n:dr),br=(e,t,n)=>yr(gr)(e,t,null!=n?n:dr),vr=(e,t,n)=>yr(hr)(e,t,null!=n?n:dr)}])}));
//# sourceMappingURL=opensoql.min.js.map