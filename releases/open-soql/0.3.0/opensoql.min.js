!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.opensoql=t():e.opensoql=t()}(this,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";n.r(t),n.d(t,"applyWhereConditions",(function(){return I})),n.d(t,"applyHavingConditions",(function(){return q})),n.d(t,"sortRecords",(function(){return M})),n.d(t,"build",(function(){return Un})),n.d(t,"setDefaultStaticResolverConfig",(function(){return hr})),n.d(t,"staticJsonResolverBuilder",(function(){return vr})),n.d(t,"staticCsvResolverBuilder",(function(){return Ar})),n.d(t,"passThroughResolverBuilder",(function(){return kr}));const r=Function("return this")(),o={}.constructor,s=Function,a=/^(\d{4}-[01]\d-[0-3]\d)$/,i=/^((?:(?:\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+)|(?:\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d)|(?:\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d))(?:[+-][0-2]\d:[0-5]\d|Z))$/,l={};function c(e,t){if(e===r||"__proto__"===t||"__defineGetter__"===t||"__defineSetter__"===t||"__lookupGetter__"===t||"__lookupSetter__"===t)return!0;if(!("prototype"!==t&&"constructor"!==t||null!=e&&"function"!=typeof e))return!0;if((null==e||e===o)&&o.hasOwnProperty(t))return!0;if(null==e||e===s){let e=s;for(;e;){if(e.hasOwnProperty(t))return!0;e=e.__proto__}}return"function"==typeof e&&!e.hasOwnProperty(t)}function u(e){switch(typeof e){case"object":if(Array.isArray(e))return e.slice().map(e=>u(e));if(null===e)return e;if(e instanceof Map){const t=Array.from(e.entries()).map(e=>[u(e[0]),u(e[1])]);return new Map(t)}if(e instanceof Set){const t=Array.from(e.values()).map(e=>u(e));return new Set(t)}{const t={};for(const n of Object.keys(e))t[n]=u(e[n]);return t}default:return e}}function f(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].toLowerCase()!==t[n].toLowerCase())return!1;return!0}function d(e,t){const n=[];for(let r=0;r<e.length;r++){const o=e.slice(r);if(f(t.slice(0,o.length),o))break;n.push(e[r])}return n.length?n.concat(t):t}function p(e,t){const n=Object.keys(e),r=t.toLowerCase(),o=n.findIndex(e=>e.toLowerCase()===r);return 0>o?null:n[o]}function m(e,t){const n=Object.keys(e),r=t.toLowerCase(),o=n.findIndex(e=>e.toLowerCase()===r);return 0>o?null:e[n[o]]}function h(e,t,n){const r=n.toLowerCase();return e.has(r)?t[e.get(r)]:null}function g(e,t){const n=[];let r=e;for(const e of t){if(null==r)return null;const t=Object.keys(r),o=e.toLowerCase(),s=t.findIndex(e=>e.toLowerCase()===o);if(0>s)return null;r=r[t[s]],n.push(t[s])}return n}function y(e,t){let n=e;for(const e of t)if(n=n[e],null==n)return null;return n}function w(e,t){let n=e;for(const e of t){const t=Object.keys(n),r=e.toLowerCase(),o=t.findIndex(e=>e.toLowerCase()===r);if(0>o)return null;if(n=n[t[o]],null==n)return null}return n}const b=new WeakMap,v=new WeakMap,A=new WeakMap;function k(e,t,n,r,o,s){const a=t.args.map(t=>{var n;switch(typeof t){case"object":if(null===t)return t;switch(t.type){case"field":{let e=m(o,t.name[t.name.length-1]);switch(r){case"date":case"datetime":e=new Date(e).getTime()}return e}case"date":case"datetime":switch(r){case"date":case"datetime":return new Date(t.value).getTime();default:return t.value}case"parameter":{if(!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const o=null!==(n=e.params[t.name])&&void 0!==n?n:null;if(null===o)return null;switch(r){case"date":case"datetime":if(Array.isArray(o))throw new Error(`Parameter '${t.name}' should be string or number.`);return new Date(o).getTime();default:return o}}case"fncall":{let n=A.get(t);if(!n){const r=t.fn.toLowerCase();n=e.functions.find(e=>e.name.toLowerCase()===r)}const r=n;switch(null==r?void 0:r.type){case"aggregate":if(!s)throw new Error(`Nested function ${t.fn} is not allowed.`);return N(e,t,r,"any",s);case"scalar":return k(e,t,r,"any",o,s);case"immediate-scalar":return x(e,t,r,"any",o,s);default:throw new Error(`Nested function ${t.fn} is not allowed.`)}}default:return t}default:return t}});return n.fn(e,a,o)}function x(e,t,n,r,o,s){const a=t.args.map(t=>{var n;switch(typeof t){case"object":if(null===t)return t;switch(t.type){case"field":throw new Error(`Immediate scalar function should not refer the field (${t.name.join(".")}).`);case"date":case"datetime":switch(r){case"date":case"datetime":return new Date(t.value).getTime();default:return t.value}case"parameter":{if(!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const o=null!==(n=e.params[t.name])&&void 0!==n?n:null;if(null===o)return null;switch(r){case"date":case"datetime":if(Array.isArray(o))throw new Error(`Parameter '${t.name}' should be string or number.`);return new Date(o).getTime();default:return o}}case"fncall":{let n=A.get(t);if(!n){const r=t.fn.toLowerCase();n=e.functions.find(e=>e.name.toLowerCase()===r)}const r=n;switch(null==r?void 0:r.type){case"aggregate":if(null===s)throw new Error(`Nested function ${t.fn} is not allowed.`);return N(e,t,r,"any",s);case"scalar":if(null===o)throw new Error(`Nested function ${t.fn} is not allowed.`);return k(e,t,r,"any",o,s);case"immediate-scalar":return x(e,t,r,"any",o,s);default:throw new Error(`Nested function ${t.fn} is not allowed.`)}}default:return t}default:return t}});return n.fn(e,a)}function N(e,t,n,r,o){const s=t.args.map(t=>{var n;switch(typeof t){case"object":if(null===t)return t;switch(t.type){case"field":{let e=o.map(e=>m(e,t.name[t.name.length-1]));switch(r){case"date":case"datetime":e=e.map(e=>new Date(e).getTime())}return e}case"date":case"datetime":switch(r){case"date":case"datetime":return new Date(t.value).getTime();default:return t.value}case"parameter":{if(!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const o=null!==(n=e.params[t.name])&&void 0!==n?n:null;if(null===o)return null;switch(r){case"date":case"datetime":if(Array.isArray(o))throw new Error(`Parameter '${t.name}' should be string or number.`);return new Date(o).getTime();default:return o}}case"fncall":{let n=A.get(t);if(!n){const r=t.fn.toLowerCase();n=e.functions.find(e=>e.name.toLowerCase()===r)}const r=n;switch(null==r?void 0:r.type){case"scalar":return o.map(n=>k(e,t,r,"any",n,o));case"immediate-scalar":return o.map(n=>x(e,t,r,"any",n,o));default:throw new Error(`Nested function ${t.fn} is not allowed.`)}}default:return t}default:return t}});return n.fn(e,s,o)}function _(e,t){if(e.has(t)){const n=e.get(t);if(n)return n}return null}function C(e,t,n){for(const r of n)switch(typeof r){case"object":switch(null==r?void 0:r.type){case"field":if(!_(t,r.name[r.name.length-1]))return!1;break;case"fncall":{const n=r.fn.toLowerCase(),o=e.functions.find(e=>e.name.toLowerCase()===n);switch(null==o?void 0:o.type){case"scalar":if(!C(e,t,r.args))return!1}}}}return!0}const F=(e,t,n,r)=>{},O=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return N(t,o,a,s,r)},P=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return k(t,o,a,s,r[0],r)},j=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return k(t,o,a,s,r,null)},E=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return x(t,o,a,s,null,r)},D=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return x(t,o,a,s,r,null)};function T(e,t,n,r,o,s){var a;let i=null;const l=o.operands[0],c=null!==(a=b.get(o))&&void 0!==a?a:function(e,t,n,r){let o=b.get(r);const s=r.operands[0],a=r.operands[1];let i=!1,l="any";switch(typeof a){case"object":if(null===a);else if(Array.isArray(a));else switch(a.type){case"date":case"datetime":i=!0,l=a.type}}switch(typeof s){case"object":if(null===s);else{if(Array.isArray(s))throw new Error("Array is not allowed in the operand(1).");switch(s.type){case"field":o={isField:!0,isDateOrDatetime:i,op:s,op2FieldResultType:l,fnInfo:null,fn:F},b.set(r,o);break;case"fncall":{const a=s.fn.toLowerCase(),i=n.functions.find(e=>e.name.toLowerCase()===a);switch(null==i?void 0:i.type){case"aggregate":if(!t)throw new Error(`Aggregate function ${i.name} is not allowed.`);o={isField:!1,isDateOrDatetime:!1,op:s,op2FieldResultType:l,fnInfo:i,fn:O},b.set(r,o);break;case"scalar":if(t){if(!C(n,e,s.args))throw new Error(s.fn+" is not allowed. Aggregate function is needed.");o={isField:!1,isDateOrDatetime:!1,op:s,op2FieldResultType:l,fnInfo:i,fn:P},b.set(r,o)}else o={isField:!1,isDateOrDatetime:!1,op:s,op2FieldResultType:l,fnInfo:i,fn:j},b.set(r,o);break;case"immediate-scalar":o={isField:!1,isDateOrDatetime:!1,op:s,op2FieldResultType:l,fnInfo:i,fn:t?E:D},b.set(r,o);break;default:throw new Error("Unexpected type appears in the operand(1).")}}break;default:throw new Error("Unexpected type appears in the operand(1).")}}break;default:throw new Error("Unexpected type appears in the operand(1).")}return o}(t,n,r,o);if(null===l);else{if(Array.isArray(l))throw new Error("Array is not allowed in the operand(1).");if(c.isField){const{isDateOrDatetime:t,op:n}=c;i=h(e,s,n.name[n.name.length-1]),t&&null!==i&&(i=new Date(i).getTime())}else i=c.fn(e,r,c,s)}return i}function S(e,t,n,r,o,s){let a=!0;switch(typeof o){case"object":if(Array.isArray(o))throw new Error("Array is not allowed in the condition.");if(null===o)throw new Error("Unexpected type appears in the condition.");switch(o.type){case"condition":a=$(e,t,n,r,o,s);break;default:throw new Error("Unexpected type appears in the condition.")}break;default:throw new Error("Unexpected type appears in the condition.")}return a}function L(e){const t=e.replace(/[.*+?^=!:${}()|[\]\/]/g,"\\$&");let n="",r=void 0;for(const e of t){switch(e){case"%":n+="\\"===r?"%":".*";break;case"_":n+="\\"===r?"_":".";break;case"\\":break;default:"\\"===r&&(n+="\\"),n+=e}r=e}return"\\"===r&&(n+="\\"),`^${n}$`}function $(e,t,n,r,o,s){let a=!0;e:switch(o.op){case"true":break;case"and":for(const i of o.operands)if(!S(e,t,n,r,i,s)){a=!1;break e}break;case"or":for(const a of o.operands)if(S(e,t,n,r,a,s))break e;a=!1;break;case"not":a=!S(e,t,n,r,o.operands[0],s);break;default:{const i=T(e,t,n,r,o,s),l=function(e,t,n){var r;const o=v.get(t);if(o)return o.value;let s=null;const a=t.operands[1];switch(typeof a){case"object":if(null===a);else if(Array.isArray(a))s=a.map(t=>{var n;if(null===t)return null;switch(typeof t){case"object":switch(t.type){case"date":case"datetime":return t.value;case"parameter":{if(!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const r=null!==(n=e.params[t.name])&&void 0!==n?n:null;if(Array.isArray(r))throw new Error(`Parameter '${t.name}' items should be atom.`);return r}}default:return t}});else switch(a.type){case"fncall":{const t=a.fn.toLowerCase(),n=e.functions.find(e=>e.name.toLowerCase()===t);switch(null==n?void 0:n.type){case"immediate-scalar":s=x(e,a,n,"any",null,null);break;default:throw new Error("Unexpected type appears in the operand(2).")}}default:switch(a.type){case"date":case"datetime":s=new Date(a.value).getTime();break;case"parameter":if(!Object.prototype.hasOwnProperty.call(e.params,a.name))throw new Error(`Parameter '${a.name}' is not found.`);s=null!==(r=e.params[a.name])&&void 0!==r?r:null;break;default:throw new Error("Unexpected type appears in the operand(2).")}}break;default:s=a}return v.set(t,{value:s}),s}(r,o);switch(o.op){case"=":i!==l&&(a=!1);break;case"!=":i===l&&(a=!1);break;case"<":if(null===i){a=!1;break}if(null===l){a=!1;break}i<l||(a=!1);break;case"<=":if(null===i){a=!1;break}if(null===l){a=!1;break}i<=l||(a=!1);break;case">":if(null===i){a=!1;break}if(null===l){a=!1;break}i>l||(a=!1);break;case">=":if(null===i){a=!1;break}if(null===l){a=!1;break}i>=l||(a=!1);break;case"like":if("string"!=typeof i){a=!1;break}if("string"!=typeof l)throw new Error('Operator "like": operand(2) should be string.');new RegExp(L(l),"i").test(i)||(a=!1);break;case"not_like":if("string"!=typeof i){a=!1;break}if("string"!=typeof l)throw new Error('Operator "not_like": operand(2) should be string.');new RegExp(L(l),"i").test(i)&&(a=!1);break;case"in":if(!Array.isArray(l))throw new Error('Operator "in": operand(2) should be array.');l.filter(e=>null!==e).includes(i)||(a=!1);break;case"not_in":if(!Array.isArray(l))throw new Error('Operator "not_in": operand(2) should be array.');if(null===i){a=!1;break}if(l.includes(null)){a=!1;break}l.includes(i)&&(a=!1);break;case"includes":if("string"!=typeof i){a=!1;break}if(!Array.isArray(l))throw new Error('Operator "includes": operand(2) should be array.');a=!1;t:for(const e of l){if("string"!=typeof e)throw new Error('Operator "includes": operand(2) array items should be string.');const t=i.split(";"),n=e.split(";");for(const e of n)if(!t.includes(e))continue t;a=!0;break}break;case"excludes":if("string"!=typeof i){a=!1;break}if(!Array.isArray(l))throw new Error('Operator "excludes": operand(2) should be array.');{const e=i.split(";");for(const t of l){if("string"!=typeof t)throw new Error('Operator "excludes": operand(2) array items should be string.');const n=t.split(";");let r=!0;for(const t of n)if(!e.includes(t)){r=!1;break}if(r){a=!1;break}}}}}}return a}function I(e,t,n){const r=[];if(!n.length)return r;const o=new Map(Object.keys(n[0]).map(e=>[e.toLowerCase(),e]));e:for(const s of n){for(const n of t)if(!$(o,null,!1,e,n,s))continue e;r.push(s)}return r}function q(e,t,n){var r,o;const s=[];if(!n.length)return s;const a=new Map(Object.keys(n[0][0]).map(e=>[e.toLowerCase(),e])),i=n[0][0],l=new Map(null===(o=null===(r=e.query)||void 0===r?void 0:r.groupBy)||void 0===o?void 0:o.map(e=>{var t;return[e.toLowerCase(),null!==(t=p(i,e))&&void 0!==t?t:""]}));e:for(const r of n){for(const n of t)if(!$(a,l,!0,e,n,r))continue e;s.push(r)}return s}function M(e,t){if(e.orderBy){const n=e.from[0].name.length,r=e.orderBy;t=t.sort((e,o)=>{const s=(e,t)=>"desc"===e.direction?-t:t,a=r.map(e=>({f:e,fName:g(t[0],e.name.slice(n))}));e:for(let{f:t,fName:r}of a){let a=null,i=null;if(null!==r?(a=y(e,r),i=y(o,r)):(a=w(e,t.name.slice(n)),r=g(o,t.name.slice(n)),i=null!==r?y(o,r):null),a!==i){if(null===a)return s(t,"last"===t.nulls?1:-1);if(null===i)return s(t,"last"===t.nulls?-1:1);switch(typeof a){case"number":case"bigint":return s(t,a-i);case"string":return s(t,a>i?1:-1);default:continue e}}}return 0})}return t}class R extends Error{constructor(e){super(e.message),this.result=e}}function U(e,t){return{src:e,start:0,end:e.length,context:t,templateArgs:[],templateArgsPos:[]}}function Q(e){let t="",n="";if("string"==typeof e.src){n=e.src.slice(Math.max(e.pos-5,0),e.pos+55);let r=n.split(/\r\n|\n|\r/);r=r.slice(0,1).concat("          ^~~~~~~~").concat(...r.slice(1)),n=r.join("\n")+"\n\n";const o=function(e,t){let n=1,r=1;for(let o=0;o<=t;o++)switch(e[o]){case"\r":"\n"===e[o+1]&&o++;case"\n":n++,r=1;break;default:r++}return{line:n,col:r}}(e.src,e.pos);t=`parse failed at position:${e.pos} line:${o.line} col:${o.col} ${e.message?" "+e.message:""}\n     ${n}`}else{n="     (object)\n          ^~~~~~~~";try{n="     "+JSON.stringify(e.src.slice(Math.max(e.pos-10,0),e.pos))+"\n          "+JSON.stringify(e.src.slice(e.pos,e.pos+1))+"\n          "+JSON.stringify(e.src.slice(e.pos+1,e.pos+10));let t=n.split(/\r\n|\n|\r/);t=t.slice(0,2).concat("          ^~~~~~~~").concat(...t.slice(2)),n=t.join("\n")+"\n\n"}catch(e){}t=`parse failed at position:${e.pos} ${e.message?" "+e.message:""}\n     ${n}`}return t}function B(e){return t=>({succeeded:!0,next:{src:t.src,start:t.start,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:e?[e()]:[]})}function W(e){return t=>{throw new R({succeeded:!1,error:!0,src:t.src,pos:t.start,message:e||""})}}function z(e){return t=>0===t.start?{succeeded:!0,next:{src:t.src,start:t.start,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:e?[e()]:[]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "beginning"'}}function J(e){return t=>t.start===t.end?{succeeded:!0,next:{src:t.src,start:t.start,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:e?[e()]:[]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "end"'}}function Y(e,t){return e=e||0,n=>r=>{let o=r;const s=[];for(;;){const r=n(o);if(!r.succeeded){if(r.error)return r;if(s.length>=e)break;return{succeeded:!1,error:!1,src:o.src,pos:o.start,message:'operator "quantify"'}}if(o=r.next,s.push({next:r.next,tokens:r.tokens}),t&&t===s.length)break}if(s.length>0){const e=[];for(const t of s)e.push(...t.tokens);return{succeeded:!0,next:s[s.length-1].next,tokens:e}}return{succeeded:!0,next:{src:r.src,start:r.start,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[]}}}function Z(...e){return t=>{let n=null,r=null;for(const o of e){const e=o(t);if(e.succeeded){n={next:e.next,tokens:e.tokens};break}r?e.error?(!r.error||r.pos<e.pos)&&(r=e):r.pos<e.pos&&(r=e):r=e}return n?{succeeded:!0,next:n.next,tokens:n.tokens}:r||{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "first"'}}}function H(...e){return t=>{const n=[];let r=null;for(const o of e){const e=o(t);e.succeeded?n.push({next:e.next,tokens:e.tokens}):r?e.error?(!r.error||r.pos<e.pos)&&(r=e):r.pos<e.pos&&(r=e):r=e}if(n.length>0){const e=n.reduce((e,t)=>e.next.start>=t.next.start?e:t);return{succeeded:!0,next:e.next,tokens:e.tokens}}return r||{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "or"'}}}function G(e,t){return(...n)=>r=>{let o=r;const s=[];for(const e of n){const t=e(o);if(!t.succeeded)return t;o=t.next,s.push(...t.tokens)}const a=e?e(s,r):s;return{succeeded:!0,next:t?{src:o.src,start:o.start,end:o.end,context:t(o.context),templateArgs:o.templateArgs,templateArgsPos:o.templateArgsPos}:o,tokens:a}}}function K(...e){return t=>{let n=t;for(const t of e){const e=t(n);if(!e.succeeded)return e;n=e.next}return{succeeded:!0,next:t,tokens:[]}}}function V(e,t){return(...n)=>r=>{if(r.start-e<0)return{succeeded:!1,error:!1,src:r.src,pos:r.start,message:"lookBehind: src is too short"};let o={src:r.src,start:r.start-e,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos};for(const e of n){const t=e(o);if(!t.succeeded)return t;o=t.next}return{succeeded:!0,next:r,tokens:t?[t()]:[]}}}function X(e){return t=>n=>{const r=t(n);if(!r.succeeded)return r;const o=U(r.tokens,n.context);let s=o,a=!1;if(e.check(s).succeeded)return{succeeded:!0,next:r.next,tokens:r.tokens};e:for(let t=0;void 0===e.maxApply||t<e.maxApply;t++){let t=!1;t:for(const n of e.rules){const{parser:r,rtol:o}="function"==typeof n?{parser:n,rtol:!1}:n,i=s.src.length;for(let n=0;n<=i;n++){const l=r({src:s.src,start:o?i-n:n,end:s.src.length,context:s.context,templateArgs:s.templateArgs,templateArgsPos:s.templateArgsPos});if(l.succeeded){t=!0;const r=s.src.slice(0,o?i-n:n);if(r.push(...l.tokens),r.push(...s.src.slice(l.next.start)),s={src:r,start:0,end:r.length,context:l.next.context,templateArgs:l.next.templateArgs,templateArgsPos:l.next.templateArgsPos},e.check(s).succeeded){a=!0;break e}break t}}}if(!t)break}if(!a&&!e.check(s).succeeded)throw new R({succeeded:!1,error:!0,src:o.src,pos:o.start,message:"The application of production rules was not finished"});return{succeeded:!0,next:r.next,tokens:s.src}}}function ee(e){return t=>{try{return e(t)}catch(e){if(e.result)return e.result;throw e}}}function te(e,t){return n=>{if("\0"===n.src.slice(n.start,n.start+1)&&n.templateArgsPos){let r=-1;if(0<=n.templateArgsPos.findIndex((e,t)=>(r=t,e===n.start))){const o=n.templateArgs[r];if(e(o))return{succeeded:!0,next:{src:n.src,start:n.start+1,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[t?t(o):o]}}}return{succeeded:!1,error:!1,src:n.src,pos:n.start,message:'operator "stringTemplatesParam()"'}}}function ne(e){const t=(n=e.rawToToken,e=>t=>t.src.slice(t.start,t.end).startsWith(e)?{succeeded:!0,next:{src:t.src,start:t.start+e.length,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:[n(e)]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:`operator "charSequence(${e})"`});var n;const r=function(e){return(...t)=>n=>{const r=n.src.slice(n.start,n.end);let o=-1;return t.some((e,t)=>{if(r.startsWith(e))return o=t,!0})?{succeeded:!0,next:{src:n.src,start:n.start+t[o].length,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[e(t[o])]}:{succeeded:!1,error:!1,src:n.src,pos:n.start,message:`operator "charClass(${t.join(",")})"`}}}(e.rawToToken),o=function(e){return(...t)=>n=>{const r=n.src.slice(n.start,n.end);for(const e of t){if(r.startsWith(e))return{succeeded:!1,error:!1,src:n.src,pos:n.start,message:`operator "charClassNot(${t.join(",")})"`}}const o=n.src.codePointAt(n.start);if(void 0===o)return{succeeded:!1,error:!1,src:n.src,pos:n.start,message:`operator "charClassNot(${t.join(",")})"`};const s=String.fromCodePoint(o);return{succeeded:!0,next:{src:n.src,start:n.start+s.length,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[e(s)]}}}(e.rawToToken),s=function(e){return t=>n=>{const r=n.src.slice(n.start,n.end),o=t(r);return o>=0?{succeeded:!0,next:{src:n.src,start:n.start+o,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[e(r.substring(0,o))]}:{succeeded:!1,error:!1,src:n.src,pos:n.start,message:'operator "charClassByNeedleFn"'}}}(e.rawToToken),a=G(e.concatTokens),i=Y(1,1),l=Y(),c=(e,t)=>Y(e,t),u=G(),f=G(e=>[]),d=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="Z"||"a"<=n&&n<="z"?n.length:-1}),p=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="Z"?n.length:-1}),m=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"a"<=n&&n<="z"?n.length:-1}),h=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"0"<=n&&n<="9"?n.length:-1}),g=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"1"<=n&&n<="9"?n.length:-1}),y=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"0"<=n&&n<="1"?n.length:-1}),w=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"0"<=n&&n<="7"?n.length:-1}),b=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="F"||"a"<=n&&n<="f"||"0"<=n&&n<="9"?n.length:-1}),v=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="Z"||"a"<=n&&n<="z"||"0"<=n&&n<="9"?n.length:-1}),A=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return" \f\n\r\t\v​  ​᠎           ​\u2028\u2029  ​　\ufeff".includes(n)?n.length:-1}),k=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return" \f\t\v​  ​᠎           ​\u2028\u2029  ​　\ufeff".includes(n)?n.length:-1}),x=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return 0<=t&&t<=31||127<=t&&t<=159?n.length:-1}),N=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return" \f\n\r\t\v​  ​᠎           ​\u2028\u2029  ​　\ufeff".includes(n)||0<=t&&t<=31||127<=t&&t<=159?-1:n.length}),_=r("\r\n","\n","\r"),C=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;return String.fromCodePoint(t).length}),F=Z(y,r("_")),O=Z(w,r("_")),P=Z(b,r("_")),j=u(a(c(0,1)(r("+","-")),Z(u(i(g),l(Z(h,r("_")))),t("0")))),E=u(a(j,f(t("n")))),D=u(a(c(0,1)(r("+","-")),Z(u(i(g),l(Z(h,r("_")))),t("0")),c(0,1)(u(t("."),c(1)(Z(h,r("_"))))),c(0,1)(u(r("E","e"),c(0,1)(r("+","-")),Z(u(i(g),l(h)),t("0"))))));return{seq:t,cls:r,notCls:o,clsFn:s,classes:{alpha:d,upper:p,lower:m,num:h,nonzero:g,bin:y,oct:w,hex:b,alnum:v,space:A,spaceWithinSingleLine:k,ctrl:x,newline:_,word:N,any:C},numbers:{bin:(...e)=>u(f(Z(...e)),a(i(y),l(F))),oct:(...e)=>u(f(Z(...e)),a(i(w),l(O))),hex:(...e)=>u(f(Z(...e)),a(i(b),l(P))),int:j,bigint:E,float:D},isParam:te,cat:a,once:i,repeat:l,qty:c,zeroWidth:e=>B(e),err:e=>W(e),beginning:e=>z(e),end:e=>J(e),first:(...e)=>Z(...e),or:(...e)=>H(...e),combine:u,erase:f,trans:e=>G(e),ahead:(...e)=>K(...e),behind:(e,t)=>V(e,t),rules:e=>X(e),makeProgram:ee}}function re(e,t){return n=>r=>{let o=!0;if(Math.max(0,r.end-r.start)>=n.length){for(let e=0;e<n.length;e++)if(!t(r.src[r.start+e],n[e])){o=!1;break}}else o=!1;return o?{succeeded:!0,next:{src:r.src,start:r.start+n.length,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[e(n)]}:{succeeded:!1,error:!1,src:r.src,pos:r.start,message:`operator "objSequence(${n})"`}}}function oe(e,t){return(...n)=>r=>{const o=Math.max(0,r.end-r.start);let s=-1;return o>0&&n.some((e,n)=>{if(t(r.src[r.start],e))return s=n,!0})?{succeeded:!0,next:{src:r.src,start:r.start+1,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[e(n[s])]}:{succeeded:!1,error:!1,src:r.src,pos:r.start,message:`operator "objClass(${n.join(",")})"`}}}function se(e,t){return(...n)=>r=>{if(Math.max(0,r.end-r.start)>0)for(const e of n){let o=!0;if(!t(r.src[r.start],e)){o=!1;break}if(o)return{succeeded:!1,error:!1,src:r.src,pos:r.start,message:`operator "objClassNot(${n.join(",")})"`}}return{succeeded:!0,next:{src:r.src,start:r.start+1,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[e(r.src[r.start])]}}}const ae=ne({rawToToken:e=>e,concatTokens:e=>e.length?[e.reduce((e,t)=>String(e)+t)]:[]}),ie=function(e){const t=(n=e.rawToToken,e.comparator,e=>t=>Math.max(0,t.end-t.start)>0&&e(t.src[t.start])?{succeeded:!0,next:{src:t.src,start:t.start+1,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:[n(t.src[t.start])]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "objClassByNeedleFn"'});var n;const r=t(e=>!0);return{seq:re(e.rawToToken,e.comparator),cls:oe(e.rawToToken,e.comparator),notCls:se(e.rawToToken,e.comparator),clsFn:t,classes:{any:r},cat:G(e.concatTokens),once:Y(1,1),repeat:Y(),qty:(e,t)=>Y(e,t),zeroWidth:e=>B(e),err:e=>W(e),beginning:e=>z(e),end:e=>J(e),first:(...e)=>Z(...e),or:(...e)=>H(...e),combine:G(),erase:G(e=>[]),trans:e=>G(e),ahead:(...e)=>K(...e),behind:(e,t)=>V(e,t),rules:e=>X(e),makeProgram:ee}}({rawToToken:e=>e,concatTokens:e=>e.length?[e.reduce((e,t)=>String(e)+t)]:[],comparator:(e,t)=>e===t}),{seq:le,cls:ce,notCls:ue,clsFn:fe,classes:de,numbers:pe,isParam:me,cat:he,once:ge,repeat:ye,qty:we,zeroWidth:be,err:ve,beginning:Ae,end:ke,first:xe,or:Ne,combine:_e,erase:Ce,trans:Fe,ahead:Oe,rules:Pe,makeProgram:je}=ae,Ee=e=>fe(t=>t.slice(0,e.length).toLocaleLowerCase()===e?e.length:-1),De=(e,t,n)=>({type:"condition",op:e,operands:[t,n]}),Te=(e,t)=>"object"==typeof e&&"rawop"===e.type&&e.op===t,Se=_e(Ce(we(2)(ce("-"))),xe(_e(ye(ue("\r\n","\n","\r")),xe(de.newline,Oe(ke()))),xe(de.newline,Oe(ke())))),Le=_e(le("/*"),ye(ue("*/")),le("*/")),$e=xe(de.space,Se,Le),Ie=xe(_e(Ee("select"),e=>Re(e)),_e(Ee("from"),e=>Re(e)),_e(Ee("where"),e=>Re(e)),he(_e(Ee("order"),Ce(we(1)($e)),Ee("by"))),he(_e(Ee("group"),Ce(we(1)($e)),Ee("by"))),_e(Ee("having"),e=>Re(e)),_e(Ee("offset"),e=>Re(e)),_e(Ee("limit"),e=>Re(e))),qe=Oe(e=>_e(Ie,xe(we(1)($e),ce("(",")","'",'"',"=","!","<",">"),ke()))(e).succeeded?{succeeded:!1,error:!1,src:e.src,pos:e.start,message:"Unexpected reserved keyword aheads"}:{succeeded:!0,next:{src:e.src,start:e.start,end:e.end,context:e.context},tokens:[]}),Me=e=>"string"==typeof e&&/^[A-Za-z0-9$_"]$/.test(e),Re=Oe(e=>{let t=!1;return t=0===e.src.length||(e.start===e.end?Me(e.src[e.start-1]):0===e.start?Me(e.src[e.start]):!Me(e.src[e.start-1])&&Me(e.src[e.start])||Me(e.src[e.start-1])&&!Me(e.src[e.start])),t?{succeeded:!0,next:{src:e.src,start:e.start,end:e.end,context:e.context},tokens:[]}:{succeeded:!1,error:!1,src:e.src,pos:e.start,message:"Expect word break"}}),Ue=Fe(e=>[!0])(Ee("true"),Re),Qe=Fe(e=>[!1])(Ee("false"),Re),Be=Fe(e=>[null])(Ee("null"),Re),We=Fe(e=>[Number.POSITIVE_INFINITY])(we(0,1)(le("+")),le("Infinity"),Re),ze=Fe(e=>[Number.NEGATIVE_INFINITY])(le("-Infinity"),Re),Je=Fe(e=>[Number.NaN])(le("NaN"),Re),Ye=Fe(e=>[Number.parseInt(e[0].replace(/_/g,""),2)])(pe.bin(le("0b"))),Ze=Fe(e=>[Number.parseInt(e[0].replace(/_/g,""),8)])(pe.oct(le("0o"),le("0"))),He=Fe(e=>[Number.parseInt(e[0].replace(/_/g,""),16)])(pe.hex(le("0x"),le("0X"))),Ge=Fe(e=>[Number.parseInt(e[0].replace(/_/g,""),10)])(pe.int),Ke=Fe(e=>[Number.parseFloat(e[0].replace(/_/g,""))])(pe.float),Ve=xe(Ze,He,Ye,Ke,Ge,We,ze,Je),Xe=xe(Fe(e=>["'"])(le("\\'")),Fe(e=>['"'])(le('\\"')),Fe(e=>["`"])(le("\\`")),Fe(e=>["/"])(le("\\/")),Fe(e=>["\\"])(le("\\\\")),Fe(e=>[""])(le("\\\r\n")),Fe(e=>[""])(le("\\\r")),Fe(e=>[""])(le("\\\n")),Fe(e=>["\n"])(le("\\n")),Fe(e=>["\n"])(le("\\N")),Fe(e=>["\r"])(le("\\r")),Fe(e=>["\r"])(le("\\R")),Fe(e=>["\v"])(le("\\v")),Fe(e=>["\t"])(le("\\t")),Fe(e=>["\t"])(le("\\T")),Fe(e=>["\b"])(le("\\b")),Fe(e=>["\b"])(le("\\B")),Fe(e=>["\f"])(le("\\f")),Fe(e=>["\f"])(le("\\F")),Fe(e=>[String.fromCodePoint(Number.parseInt(e[0],16))])(he(Ce(le("\\u")),we(4,4)(de.hex))),Fe(e=>[String.fromCodePoint(Number.parseInt(e[0],16))])(he(Ce(le("\\u{")),we(1,6)(de.hex),Ce(le("}")))),Fe(e=>[String.fromCodePoint(Number.parseInt(e[0],16))])(he(Ce(le("\\x")),we(2,2)(de.hex))),Fe(e=>[String.fromCodePoint(Number.parseInt(e[0],8))])(he(Ce(le("\\")),we(3,3)(de.oct)))),et=Fe(e=>{var t;return[null!==(t=e[0])&&void 0!==t?t:""]})(Ce(le("'")),he(ye(xe(Xe,_e(ce("\r","\n"),ve("Line breaks within strings are not allowed.")),ue("'")))),Ce(le("'"))),tt=Fe(e=>[{type:"date",value:e[0]}])(he(we(4,4)(de.num),ce("-"),we(2,2)(de.num),ce("-"),we(2,2)(de.num),Re)),nt=Fe(e=>[{type:"datetime",value:e[0]}])(he(we(4,4)(de.num),ce("-"),we(2,2)(de.num),ce("-"),we(2,2)(de.num),ce("T"),we(2,2)(de.num),ce(":"),we(2,2)(de.num),we(0,1)(_e(ce(":"),we(2,2)(de.num))),xe(ce("Z"),_e(xe(ce("+"),ce("-")),we(2,2)(de.num),ce(":"),we(2,2)(de.num))),Re)),rt=Fe(e=>{var t;const n=null!==(t=e[0])&&void 0!==t?t:"";if(c(l,n))throw new Error("Unsafe symbol name is appeared: "+n);return[n]})(Ce(le('"')),he(ye(xe(Xe,_e(ce("\r","\n"),ve("Line breaks within strings are not allowed.")),ue('"')))),Ce(le('"'))),ot=Fe(e=>{if(c(l,e[0]))throw new Error("Unsafe symbol name is appeared: "+e[0]);return e})(he(_e(xe(de.alpha,ce("$","_")),ye(xe(de.alnum,ce("$","_")))))),st=Fe(e=>[{name:e}])(xe(ot,rt),ye(_e(Ce(ye($e),ce("."),ye($e)),xe(ot,rt)))),at=Fe(e=>[{type:"parameter",name:e[0]}])(Ce(le(":")),ot),it=xe(me(e=>{switch(typeof e){case"number":case"string":case"boolean":return!0;case"object":if(null===e)return!0;if(e.type)switch(e.type){case"date":if("string"==typeof e.value)return a.test(e.value);break;case"datetime":if("string"==typeof e.value)return i.test(e.value)}}return!1}),nt,tt,Ve,et,Ue,Qe,Be,at),lt=Fe(e=>[{fn:e[0],args:e.slice(1)}])(ot,Ce(ye($e)),Ce(ce("(")),Ce(ye($e)),ye(xe(Fe(e=>[Object.assign({type:"fncall"},e[0])])(e=>lt(e)),it,Fe(e=>[Object.assign({type:"field"},e[0])])(st))),ye(_e(Ce(ye($e)),Ce(ce(",")),Ce(ye($e)),xe(Fe(e=>[Object.assign({type:"fncall"},e[0])])(e=>lt(e)),it,Fe(e=>[Object.assign({type:"field"},e[0])])(st)))),Ce(ye($e)),Ce(ce(")"))),ct=Fe(e=>[{query:e[0]}])(Ce(ce("("),ye($e)),e=>St(e),Ce(ye($e),ce(")"))),ut=Fe(e=>[e])(Ce(ce("("),ye($e)),it,Ce(ye($e)),ye(_e(Ce(ce(","),ye($e)),it)),Ce(ye($e),ce(")"))),ft=Fe(e=>[Object.assign(Object.assign({},e[0]),{aliasName:e.length>1?e[1]:null})])(qe,xe(Fe(e=>[Object.assign({type:"fncall"},e[0])])(lt),Fe(e=>[Object.assign({type:"field"},e[0])])(st),Fe(e=>[Object.assign({type:"subquery"},e[0])])(ct)),xe(_e(Ce(ye($e)),qe,ot),be(()=>null))),dt=Fe(e=>[{select:e}])(ft,Ce(ye($e)),ye(_e(Ce(ce(",")),Ce(ye($e)),ft,Ce(ye($e))))),pt=Fe(e=>[{from:e}])(Ce(Ee("from")),Fe(e=>{var t;return[Object.assign(Object.assign({},e[0]),{aliasName:null!==(t=e[1])&&void 0!==t?t:null})]})(Ce(we(1)($e)),qe,st,we(0,1)(_e(Ce(we(1)($e)),qe,ot))),ye(Fe(e=>{var t;return[Object.assign(Object.assign({},e[0]),{aliasName:null!==(t=e[1])&&void 0!==t?t:null})]})(Ce(ye($e),ce(","),ye($e)),qe,st,xe(_e(Ce(we(1)($e)),qe,ot),be(()=>null))))),mt=xe(le("!="),le("<="),le(">="),le("="),le("<"),le(">"),Fe(e=>[`${e[0]}_${e[1]}`])(Ee("not"),Ce(we(1)($e)),xe(Ee("like"),Ee("in")),Ce(Re,ye($e))),_e(Ee("like"),Ce(Re,ye($e))),_e(Ee("in"),Ce(Re,ye($e))),_e(Ee("includes"),Ce(Re,ye($e))),_e(Ee("excludes"),Ce(Re,ye($e)))),ht=ie.trans(e=>{return[(t="not",n=e[1],{type:"condition",op:t,operands:[n]})];var t,n})(ie.clsFn(e=>Te(e,"not")),ie.clsFn(e=>!0)),gt=ie.trans(e=>[De("and",e[0],e[2])])(ie.clsFn(e=>!0),ie.clsFn(e=>Te(e,"and")),ie.clsFn(e=>!0)),yt=ie.trans(e=>[De("or",e[0],e[2])])(ie.clsFn(e=>!0),ie.clsFn(e=>Te(e,"or")),ie.clsFn(e=>!0)),wt=Fe(e=>[{type:"condition",op:e[1],operands:e.slice(0,1).concat(e.slice(2))}])(qe,xe(Fe(e=>[Object.assign({type:"fncall"},e[0])])(lt),Fe(e=>[Object.assign({type:"field"},e[0])])(st)),Ce(ye($e)),mt,Ce(ye($e)),xe(it,Fe(e=>[Object.assign({type:"subquery"},e[0])])(ct),Fe(e=>[Object.assign({type:"fncall"},e[0])])(lt),ut)),bt=Fe(e=>e)(we(0,1)(_e(Fe(e=>[{type:"rawop",op:e[0]}])(Ee("not")),Ce(Re,ye($e)))),xe(Fe(e=>e)(Ce(ye($e)),Ce(ce("(")),Ce(ye($e)),e=>vt(e),Ce(ye($e)),Ce(ce(")"))),wt),ye(_e(Ce(ye($e)),Fe(e=>[{type:"rawop",op:e[0]}])(xe(Ee("and"),Ee("or"))),Ce(Re,ye($e)),e=>vt(e)))),vt=Pe({rules:[ht,gt,yt],check:ie.combine(ie.classes.any,ie.end())})(Fe(e=>e)(bt)),At=Fe(e=>[{where:[e[0]]}])(Ce(ye($e),Re),Ce(Ee("where")),Ce(xe(Oe(ce("(")),we(1)($e),_e(ye($e),Re))),vt),kt=Fe(e=>[{groupBy:e}])(Ce(ye($e),Re),Ce(Ee("group"),we(1)($e),Ee("by"),we(1)($e)),ot,ye(_e(Ce(ye($e),ce(","),ye($e)),ot))),xt=Fe(e=>[{type:"condition",op:e[1],operands:e.slice(0,1).concat(e.slice(2))}])(qe,Fe(e=>[Object.assign({type:"fncall"},e[0])])(lt),Ce(ye($e)),mt,Ce(ye($e)),xe(it,Fe(e=>[Object.assign({type:"subquery"},e[0])])(ct,Fe(e=>[Object.assign({type:"fncall"},e[0])])(lt),ut))),Nt=Fe(e=>e)(we(0,1)(_e(Fe(e=>[{type:"rawop",op:e[0]}])(Ee("not")),Ce(Re,ye($e)))),xe(Fe(e=>e)(Ce(ye($e)),Ce(ce("(")),Ce(ye($e)),e=>_t(e),Ce(ye($e)),Ce(ce(")"))),xt),ye(_e(Ce(ye($e)),Fe(e=>[{type:"rawop",op:e[0]}])(xe(Ee("and"),Ee("or"))),Ce(Re,ye($e)),e=>_t(e)))),_t=Pe({rules:[ht,gt,yt],check:ie.combine(ie.classes.any,ie.end())})(Fe(e=>e)(Nt)),Ct=Fe(e=>[{having:[e[0]]}])(Ce(ye($e),Re),Ce(Ee("having")),Ce(xe(Oe(ce("(")),we(1)($e),_e(ye($e),Re))),_t),Ft=xe(we(1,1)(_e(Ce(we(1)($e)),Fe(e=>[e[0].toLowerCase()])(xe(Ee("asc"),Ee("desc"))),Ce(Re))),be(()=>"asc")),Ot=xe(we(1,1)(_e(Ce(we(1)($e),Ee("nulls"),we(1)($e)),Fe(e=>[e[0].toLowerCase()])(xe(Ee("first"),Ee("last"))),Ce(Re))),be(()=>"first")),Pt=Fe(e=>[{orderBy:e}])(Ce(ye($e),Re),Ce(Ee("order"),we(1)($e),Ee("by"),we(1)($e)),Fe(e=>[Object.assign(Object.assign({},e[0]),{direction:e[1],nulls:e[2]})])(st,Ft,Ot),ye(_e(Ce(ye($e),ce(","),ye($e)),Fe(e=>[Object.assign(Object.assign({},e[0]),{direction:e[1],nulls:e[2]})])(st,Ft,Ot)))),jt=Fe(e=>[{offset:e[0]}])(Ce(ye($e),Re),Ce(Ee("offset"),we(1)($e)),xe(Ge,at,me(e=>"number"==typeof e))),Et=Fe(e=>[{limit:e[0]}])(Ce(ye($e),Re),Ce(Ee("limit"),we(1)($e)),xe(Ge,at,me(e=>"number"==typeof e))),Dt=Fe(e=>[{for:e.map(e=>e.toLowerCase())}])(Ce(ye($e),Re),Ce(Ee("for"),we(1)($e)),xe(_e(Ee("view"),we(0,1)(_e(Ce(ye($e),ce(","),ye($e)),Ee("reference")))),_e(Ee("reference"),we(0,1)(_e(Ce(ye($e),ce(","),ye($e)),Ee("view"))))),Ce(Re)),Tt=Fe(e=>[{for:e.map(e=>e.toLowerCase())}])(Ce(ye($e),Re),Ce(Ee("for"),we(1)($e)),Ee("update"),xe(_e(Ce(we(1)($e)),Ee("tracking"),we(0,1)(_e(Ce(ye($e),ce(","),ye($e)),Ee("viewstat")))),_e(Ce(we(1)($e)),Ee("viewstat"),we(0,1)(_e(Ce(ye($e),ce(","),ye($e)),Ee("tracking")))),be(()=>{})),Ce(Re)),St=Fe(e=>{let t={};for(const n of e)t=Object.assign(Object.assign({},t),n);return[t]})(Ce(Ee("select")),Ce(we(1)($e)),dt,pt,we(0,1)(At),we(0,1)(_e(kt,we(0,1)(Ct))),we(0,1)(Pt),we(0,1)(xe(_e(jt,we(0,1)(Et)),_e(Et,we(0,1)(jt)))),we(0,1)(xe(Dt,Tt)),Ce(ye($e))),Lt=je(_e(Ae(),Ce(ye($e)),St,Ce(ye($e)),ke()));function $t(e,t){const n=t.name.slice(0,t.name.length-1);return e.from.find(e=>f(e.name,n))}function It(e,t,n,r){var o;const s=null!==(o=$t(e,t))&&void 0!==o?o:n;s&&r(s).add(t.name[t.name.length-1])}function qt(e,t,n){const r=(t,n)=>{const r=[];qt(r,t,n),n.operands=r,e.push(n)};switch(n.op){case"and":case"or":case"not":n.op===t?(()=>{for(const o of n.operands)switch(typeof o){case"object":if(null===o||Array.isArray(o))throw new Error("Unexpected AST is found.");switch(o.type){case"condition":switch(o.op){case"and":case"or":case"not":"not"!==o.op&&o.op===t?qt(e,o.op,o):r(o.op,o);break;default:e.push(o)}break;default:throw new Error(`Unexpected AST ${o.type} is found.`)}break;default:throw new Error("Unexpected AST is found.")}})():r(n.op,n);break;default:e.push(n)}}function Mt(e,t){for(const n of e.args)switch(typeof n){case"object":if(null===n);else switch(n.type){case"field":t(n);break;case"fncall":Mt(n,t)}}}function Rt(e,t){switch(e.type){case"condition":for(const n of e.operands)switch(typeof n){case"object":if(null===n);else if(Array.isArray(n));else switch(n.type){case"condition":Rt(n,t);break;case"field":t(n);break;case"fncall":for(const e of n.args)switch(typeof e){case"object":if(null===e);else switch(e.type){case"field":t(e);break;case"fncall":Mt(e,t)}}}}}return e}function Ut(e,t,n,r){var o,s,a,i;const l=new Map(null!=r?r:[]);if(0===n.length&&t.from[0].name.length>1)throw new Error("Relationship name is not allowed at first item of root level from clause.");{const e=t.from[0];if(t.from[0].name.length>1)for(;l.has(e.name[0].toLowerCase());)e.name=l.get(e.name[0].toLowerCase()).concat(e.name.slice(1));if(n.length>0&&(e.name=d(n,e.name),!f(e.name.slice(0,n.length),n)))throw new Error(`Resolver name ${e.name.join(".")} is not match to parent resolver ${n.join(".")}`)}const c=t.from[0].name;t.from[0].aliasName&&l.set(t.from[0].aliasName.toLowerCase(),c),t.whereSubQueries=[],t.havingSubQueries=[],t.selectSubQueries=[];for(const e of t.from.slice(1)){if(1===e.name.length)e.name=c.concat(e.name);else{let t=e.name[0].toLowerCase();for(;l.has(t);)e.name=l.get(t).concat(e.name.slice(1)),t=e.name[0].toLowerCase();e.name=d(c,e.name)}e.aliasName&&l.set(e.aliasName.toLowerCase(),e.name)}const u=new Map;let m="select";const h=e=>{switch(m){case"select":e.aliasName&&u.set(e.aliasName.toLowerCase(),e.name);break;case"where":case"having":case"orderby":if(1===e.name.length){const t=e.name[0].toLowerCase();u.has(t)&&(e.name=u.get(t))}}if(1===e.name.length)e.name=c.concat(e.name);else{let n=e.name[0].toLowerCase();for(;l.has(n);)e.name=l.get(n).concat(e.name.slice(1)),n=e.name[0].toLowerCase();e.name=d(c,e.name);const r=e.name.slice(0,e.name.length-1);t.from.find(e=>f(e.name,r))||t.from.push({name:r,aliasName:null})}return e},g=(n,r)=>{const o=n.fn.toLowerCase(),s=e.functions.find(e=>e.name.toLowerCase()===o);if(!s)throw new Error(`Function '${n.fn}' is not found.`);switch(m){case"select":"aggregate"!==s.type||t.groupBy||(t.groupBy=[]);break;case"where":if("aggregate"===s.type)throw new Error(`Aggregate function '${n.fn}' is not allowed.`);if(0!==r&&"immediate-scalar"!==s.type)throw new Error(`Function '${n.fn}' is not allowed at operand ${r+1}.`);break;case"having":if(0!==r&&"immediate-scalar"!==s.type)throw new Error(`Function '${n.fn}' is not allowed at operand ${r+1}.`)}for(const e of n.args)switch(typeof e){case"object":if(null===e);else switch(e.type){case"field":h(e);break;case"fncall":g(e,0)}}return n},y=n=>{switch(n.type){case"condition":for(let r=0;r<n.operands.length;r++){const o=n.operands[r];switch(typeof o){case"object":if(null===o);else if(Array.isArray(o));else switch(o.type){case"condition":y(o);break;case"field":h(o);break;case"fncall":g(o,r);break;case"subquery":("where"===m?t.whereSubQueries:t.havingSubQueries).push(o),o.query=Ut(e,o.query,[],null)}}}}return n};for(let n=0;n<t.select.length;n++){const r=t.select[n];switch(r.type){case"field":h(r);break;case"fncall":g(r,n);break;case"subquery":t.selectSubQueries.push(r),r.query=Ut(e,r.query,c,l)}}if(t.where&&(m="where",y(t.where[0])),t.having&&(m="having",y(t.having[0])),t.orderBy){m="orderby";for(const e of t.orderBy)h(e)}for(const e of t.from)e.queryFields=new Set,e.queryFieldsMap=new Map,e.condFields=new Set,e.condAliasFields=new Set,e.havingCondFields=new Set,e.relationshipIdFields=new Set;const w=e=>It(t,e,t.from[0],e=>e.queryFields),b=e=>It(t,e,t.from[0],e=>e.condFields),v=e=>It(t,e,t.from[0],e=>e.havingCondFields);let A=0;const k=(e,n)=>{n||e.aliasName||(e.aliasName="expr"+A++);let r=void 0;for(const n of e.args)switch(typeof n){case"object":if(null===n);else switch(n.type){case"field":w(n),r||(r=$t(t,n));break;case"fncall":{const e=k(n,!0);r||(r=e)}}}return n||(null!=r?r:t.from[0]).queryFieldsMap.set(e.aliasName,e),r};for(const e of t.select)switch(e.type){case"field":{w(e);const n=$t(t,e);null==n||n.queryFieldsMap.set(e.name[e.name.length-1],e)}break;case"fncall":k(e,!1)}if(t.where&&Rt(t.where[0],b),t.having&&Rt(t.having[0],v),t.groupBy)for(const e of t.groupBy)t.from[0].havingCondFields.add(e);t.from[0].name=c;const x=p(e.relationships,c[0]);if(!x)throw new Error(`Resolver '${c[0]}' is not found.`);const N=function e(t,n,r){const o=r.resolverName.toLowerCase(),s=r.fieldOrRelName.toLowerCase(),a=p(t.relationships,r.resolverName);if(!a)throw new Error(`Resolver '${r.resolverName}' is not found.`);const i=n.find(e=>e.resolverName.toLowerCase()===o&&e.fieldOrRelName.toLowerCase()===s);if(i)return i;const l=[],c={fieldOrRelName:r.fieldOrRelName,resolverName:a,direction:r.direction,children:l},u=t.relationships[a],f=n.concat([c]);for(const n of Object.keys(u)){const r=u[n];Array.isArray(r)?l.push(e(t,f,{resolverName:r[0],fieldOrRelName:n,direction:2})):"string"==typeof r?l.push(e(t,f,{resolverName:r,fieldOrRelName:n,direction:1})):l.push(e(t,f,{resolverName:r.resolver,fieldOrRelName:n,direction:1}))}return c}(e,[],{resolverName:x,fieldOrRelName:x,direction:1});for(const n of t.from){let t,r=[N];for(let e=0;e<n.name.length;e++){const o=n.name[e],s=o.toLowerCase(),a=r.find(e=>e.fieldOrRelName.toLowerCase()===s);if(!a)throw new Error(`Resolver '${o}' is not found.`);t=a,r=a.children,n.name[e]=a.fieldOrRelName}t&&(n.resolver=e.resolvers.query[t.resolverName],n.resolverName=t.resolverName)}if(t.where){const e=[];qt(e,"and",t.where[0]),t.where=e}if(t.having){const e=[];qt(e,"and",t.having[0]),t.having=e}t.from=t.from.slice(0,1).concat(t.from.slice(1).sort((e,t)=>e.name.length-t.name.length));for(let n=0;n<t.from.length;n++){const r=t.from[n];r.fieldAliasNames=new Set(Array.from(r.queryFieldsMap.entries()).map(e=>{const t=e[1];return t.aliasName&&!r.queryFields.has(t.aliasName)?t.aliasName.toLowerCase():""}).filter(e=>!!e));for(const e of r.fieldAliasNames)r.condFields.has(e)&&(r.condFields.delete(e),r.condAliasFields.add(e));r.sortFieldNames=new Set(t.orderBy?t.orderBy.filter(e=>r.name.length+1===e.name.length&&f(r.name,e.name.slice(0,r.name.length))).filter(e=>!r.fieldAliasNames.has(e.name[e.name.length-1].toLowerCase())).map(e=>e.name[e.name.length-1]):[]);{const l=null!==(o=r.resolverName)&&void 0!==o?o:"";for(let o=n+1;o<t.from.length;o++){const n=t.from[o];if(r.name.length+1===n.name.length&&f(r.name,n.name.slice(0,r.name.length))){const t=null!==(s=n.resolverName)&&void 0!==s?s:"",o=null!==(i=(null!==(a=e.relationships[l])&&void 0!==a?a:{})[t])&&void 0!==i?i:{},c=o.id?o.id:e.rules.foreignIdFieldName(t);c&&r.relationshipIdFields.add(c)}}}}return t}function Qt(e){const t=Date.UTC(e.getUTCFullYear(),0,1);return(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())-t)/864e5+1}function Bt(e){const t=Date.UTC(e.getFullYear(),0,1);return(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())-t)/864e5+1}const Wt={type:"scalar",name:"cast_to_string",fn:(e,t,n)=>{if(t.length>0)return null===t[0]?null:String(t[0]);throw new Error('Argument of function "cast_to_string" should be field.')}},zt={type:"scalar",name:"cast_to_number",fn:(e,t,n)=>{if(t.length>0)return null===t[0]?null:Number(t[0]);throw new Error('Argument of function "cast_to_number" should be field.')}},Jt={type:"scalar",name:"cast_to_boolean",fn:(e,t,n)=>{if(t.length>0)return null===t[0]?null:Boolean(t[0]);throw new Error('Argument of function "cast_to_boolean" should be field.')}},Yt={type:"scalar",name:"concat",fn:(e,t,n)=>{if(t.length>0){const e=t.filter(e=>null!==e);return 0===e.length?null:e.map(e=>String(e)).join("")}throw new Error('Argument of function "concat" should be field.')}},Zt={type:"scalar",name:"add",fn:(e,t,n)=>{if(t.length>1){const e=t.filter(e=>null!==e);return 0===e.length?null:e.map(e=>Number(e)).reduce((e,t)=>e+t)}throw new Error('Argument of function "add" should be field.')}},Ht={type:"scalar",name:"sub",fn:(e,t,n)=>{if(t.length>1)return null===t[0]?null:t.filter(e=>null!==e).map(e=>Number(e)).reduce((e,t)=>e-t);throw new Error('Argument of function "sub" should be field.')}},Gt={type:"scalar",name:"mul",fn:(e,t,n)=>{if(t.length>1){const e=t.filter(e=>null!==e);return 0===e.length?null:e.map(e=>Number(e)).reduce((e,t)=>e*t)}throw new Error('Argument of function "mul" should be field.')}},Kt={type:"scalar",name:"div",fn:(e,t,n)=>{if(t.length>1)return null===t[0]?null:t.filter(e=>null!==e).map(e=>Number(e)).reduce((e,t)=>e/t);throw new Error('Argument of function "div" should be field.')}},Vt={type:"scalar",name:"mod",fn:(e,t,n)=>{if(t.length>1)return null===t[0]?null:t.filter(e=>null!==e).map(e=>Number(e)).reduce((e,t)=>e%t);throw new Error('Argument of function "div" should be field.')}},Xt={type:"aggregate",name:"count",fn:(e,t,n)=>{if(0===t.length)return n.length;{const e=t[0];if(Array.isArray(e))return e.filter(e=>null!=e).length;throw new Error('Argument of function "count" should be field.')}}},en={type:"aggregate",name:"count_distinct",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>null!=e).map(e=>JSON.stringify(e));return new Set(t).size}}throw new Error('Argument of function "count_distinct" should be field.')}},tn={type:"aggregate",name:"sum",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e));return t.length?t.reduce((e,t)=>e+t):null}}throw new Error('Argument of function "sum" should be field.')}},nn={type:"aggregate",name:"avg",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e));return t.length?t.reduce((e,t)=>e+t)/t.length:null}}throw new Error('Argument of function "avg" should be field.')}},rn={type:"aggregate",name:"max",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e)||"string"==typeof e);return t.length?t.reduce((e,t)=>e>t?e:t):null}}throw new Error('Argument of function "max" should be field.')}},on={type:"aggregate",name:"min",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e)||"string"==typeof e);return t.length?t.reduce((e,t)=>e<t?e:t):null}}throw new Error('Argument of function "min" should be field.')}};function sn(e,t){return(n,r,o)=>{if(r.length>0){const e=r[0];switch(typeof e){case"object":if(null===e)return null;switch(e.type){case"date":case"datetime":return t(e.value);default:return null}case"string":return a.test(e)||i.test(e)?t(e):null}}throw new Error(`Argument of function "${e}" should be field.`)}}const an={type:"scalar",name:"calendar_month",fn:sn("calendar_month",e=>new Date(e).getUTCMonth()+1)},ln={type:"scalar",name:"calendar_month_lc",fn:sn("calendar_month_lc",e=>new Date(e).getMonth()+1)},cn={type:"scalar",name:"calendar_quarter",fn:sn("calendar_quarter",e=>Math.floor(new Date(e).getUTCMonth()/3)+1)},un={type:"scalar",name:"calendar_quarter_lc",fn:sn("calendar_quarter_lc",e=>Math.floor(new Date(e).getMonth()/3)+1)},fn={type:"scalar",name:"calendar_year",fn:sn("calendar_year",e=>new Date(e).getUTCFullYear())},dn={type:"scalar",name:"calendar_year_lc",fn:sn("calendar_year_lc",e=>new Date(e).getFullYear())},pn={type:"scalar",name:"day_in_month",fn:sn("day_in_month",e=>new Date(e).getUTCDate())},mn={type:"scalar",name:"day_in_month_lc",fn:sn("day_in_month_lc",e=>new Date(e).getDate())},hn={type:"scalar",name:"day_in_week",fn:sn("day_in_week",e=>new Date(e).getUTCDay()+1)},gn={type:"scalar",name:"day_in_week_lc",fn:sn("day_in_week_lc",e=>new Date(e).getDay()+1)},yn={type:"scalar",name:"day_in_year",fn:sn("day_in_year",e=>Qt(new Date(e)))},wn={type:"scalar",name:"day_in_year_lc",fn:sn("day_in_year_lc",e=>Bt(new Date(e)))},bn={type:"scalar",name:"day_only",fn:sn("day_only",e=>new Date(e).toISOString().split("T")[0])},vn={type:"scalar",name:"day_only_lc",fn:sn("day_only_lc",e=>{const t=new Date(e);return new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())).toISOString().split("T")[0]})},An={type:"scalar",name:"hour_in_day",fn:sn("hour_in_day",e=>new Date(e).getUTCHours())},kn={type:"scalar",name:"hour_in_day_lc",fn:sn("hour_in_day_lc",e=>new Date(e).getHours())},xn={type:"scalar",name:"week_in_month",fn:sn("week_in_month",e=>Math.floor((new Date(e).getUTCDate()-1)/7)+1)},Nn={type:"scalar",name:"week_in_month_lc",fn:sn("week_in_month_lc",e=>Math.floor((new Date(e).getDate()-1)/7)+1)},_n=[Wt,zt,Jt,Yt,Zt,Ht,Gt,Kt,Vt,Xt,en,tn,nn,rn,on,an,cn,fn,pn,hn,yn,bn,An,xn,{type:"scalar",name:"week_in_year",fn:sn("week_in_year",e=>Math.floor((Qt(new Date(e))-1)/7)+1)},ln,un,dn,mn,gn,wn,vn,kn,Nn,{type:"scalar",name:"week_in_year_lc",fn:sn("week_in_year_lc",e=>Math.floor((Bt(new Date(e))-1)/7)+1)}],Cn={idFieldName:()=>"Id",foreignIdFieldName:e=>e?e+"Id":void 0};function Fn(e,t,...n){return function(e,t){return Ut(e,t,[],null)}(e,function(e,...t){const n=Lt("string"==typeof e?U(e,{}):function(e,t,n){const r=[];let o=0;if(t.length)for(let n=0;n<e.length;n++){const s=e[n];n<t.length&&(r.push(o+s.length),o+=s.length+1)}const s=e.join("\0");return{src:s,start:0,end:s.length,context:n,templateArgs:t,templateArgsPos:r}}(e,t,{}));if(!n.succeeded)throw new Error(Q(n));return n.tokens[0]}(t,...n))}var On=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function i(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};function Pn(e){switch(e.op){case"true":return!1;case"not":case"and":case"or":if(0===e.operands.length)return!1}return!0}function jn(e,t){if(t.operands.length){const n=t.operands[0];switch(typeof n){case"object":if(null===n);else if(Array.isArray(n));else switch(n.type){case"field":if(!f(e,n.name.slice(0,n.name.length-1)))return{type:"condition",op:"true",operands:[]};n.name=n.name.slice(n.name.length-1);break;case"fncall":{const t=function e(t,n){for(const r of n.args)switch(typeof r){case"object":if(null===r);else switch(r.type){case"field":if(!f(t,r.name.slice(0,r.name.length-1)))return{type:"condition",op:"true",operands:[]};r.name=r.name.slice(r.name.length-1);break;case"fncall":{const n=e(t,r);if(n)return n}}}return null}(e,n);if(t)return t}}}}return function(e,t){return t.operands=t.operands.map(t=>{switch(typeof t){case"object":if(Array.isArray(t))return t;if(null===t)return t;switch(t.type){case"condition":return jn(e,t);default:return t}default:return t}}).filter(e=>{switch(typeof e){case"object":if(null!==e&&!Array.isArray(e)&&"condition"===e.type)return Pn(e)}return!0}),t}(e,t)}function En(e,t,n,r,o,s){return On(this,void 0,void 0,(function*(){const a=[];o.forEach(e=>function e(t,n){switch(n.type){case"condition":for(let r=0;r<n.operands.length;r++){const o=n.operands[r];switch(typeof o){case"object":if(null===o);else if(Array.isArray(o));else switch(o.type){case"condition":e(t,o);break;case"subquery":t.push({cond:n,index:r,subQuery:o})}}}}return n}(a,e));const i=a.map(o=>In(e,t,n,r,o.subQuery.query,null,null,null,s).then(e=>({cond:o.cond,index:o.index,subQuery:o.subQuery,result:e})));(yield Promise.all(i)).map(e=>{var t;const n=e.subQuery.query.select[0];let r="";switch(n.type){case"field":r=n.name[n.name.length-1];break;default:r=null!==(t=n.aliasName)&&void 0!==t?t:""}if(e.result.length){const t=new Map(Object.keys(e.result[0]).map(e=>[e.toLowerCase(),e]));e.cond.operands[e.index]=e.result.map(e=>h(t,e,r))}else e.cond.operands[e.index]=[]})}))}function Dn(e,t,n,r){const o=new Array(t.queryFieldsMap.size),s=new Array(t.queryFieldsMap.size),a=(t,n,r,o)=>{const a=s[t];o[r.aliasName]=k(e,r,a,"any",o,null)},i=(t,n,r,o)=>{const a=s[t];o[r.aliasName]=x(e,r,a,"any",o,null)},l=(e,t,n,r)=>{};{let n=0;for(const c of t.queryFieldsMap.entries()){const[t,u]=c;switch(u.type){case"field":o[n]={isField:!0,fieldName:t,field:u,fn:l};break;case"fncall":if(r)o[n]={isField:!1,fieldName:t,field:u,fn:l};else{const r=u.fn.toLowerCase(),c=e.functions.find(e=>e.name.toLowerCase()===r);switch(s[n]=c,null==c?void 0:c.type){case"scalar":o[n]={isField:!1,fieldName:t,field:u,fn:a};break;case"immediate-scalar":o[n]={isField:!1,fieldName:t,field:u,fn:i};break;default:o[n]={isField:!1,fieldName:t,field:u,fn:l}}}break;default:o[n]={isField:!1,fieldName:t,field:u,fn:l}}n++}}for(const e of n)for(let t=0;t<o.length;t++){const{isField:n,fieldName:r,field:s,fn:a}=o[t];n?s.aliasName&&(e[s.aliasName]=e[r]):a(t,r,s,e)}return n}function Tn(e,t,n,r){if(0===r.length)return[];if(1===r.length||0===t.length)return[r];const o=new Map;if(r.length){let e=0;const n=new Map(Object.keys(r[0]).map(e=>[e.toLowerCase(),e]));for(const s of r){const r=[];for(const o of t){let t=h(n,s,o);null==t&&(t="__$$GENSYM_VT4iHbNbZW3C7taC7J6bx8pruw40cX5X$$_"+e++),r.push(t)}const a=JSON.stringify(r);if(o.has(a)){o.get(a).push(s)}else o.set(a,[s])}}return Array.from(o.values())}function Sn(e,t,n,r){var o,s;const a=[];if(!r.length)return a;const i=r[0][0],l=new Map(t.map(e=>{var t;return[e.toLowerCase(),null!==(t=p(i,e))&&void 0!==t?t:""]})),c=new Array(n.queryFieldsMap.size),u=new Array(n.queryFieldsMap.size),f=(t,n,r,o)=>{const s=u[t];o[n.aliasName]=N(e,n,s,"any",r)},d=(t,n,r,o)=>{const s=u[t];o[n.aliasName]=x(e,n,s,"any",null,r)},m=(t,n,r,o)=>{const s=u[t];o[n.aliasName]=k(e,n,s,"any",r[0],r)},h=(e,t,n,r)=>{};{let t=0;for(const r of n.queryFieldsMap.entries()){const[,n]=r;switch(n.type){case"field":{const e=_(l,n.name[n.name.length-1]);if(!e)throw new Error(n.name.join(".")+" is not allowed. Aggregate function is needed.");c[t]={isField:!0,field:n,trueCaseName:e,fn:h}}break;case"fncall":{const r=n.fn.toLowerCase(),a=e.functions.find(e=>e.name.toLowerCase()===r);switch(u[t]=a,null==a?void 0:a.type){case"aggregate":c[t]={isField:!1,field:n,trueCaseName:"",fn:f};break;case"immediate-scalar":c[t]={isField:!1,field:n,trueCaseName:"",fn:d};break;case"scalar":if(!C(e,l,n.args))throw new Error((null!==(o=n.aliasName)&&void 0!==o?o:"(unnamed)")+" is not allowed. Aggregate function is needed.");c[t]={isField:!1,field:n,trueCaseName:"",fn:m};break;default:throw new Error((null!==(s=n.aliasName)&&void 0!==s?s:"(unnamed)")+" is not allowed. Aggregate function is needed.")}}break;default:c[t]={isField:!1,field:n,trueCaseName:"",fn:h}}t++}}for(const e of r){const t={};for(let n=0;n<c.length;n++){const{isField:r,field:o,trueCaseName:s,fn:a}=c[n];r?(t[s]=e[0][s],o.aliasName&&(t[o.aliasName]=e[0][s])):a(n,o,e,t)}a.push(t)}return a}function Ln(e,t,n){const r=new Set;if(t.length){const o=new Set,s=t[0];for(const t of e.queryFieldsMap.entries()){const e=t[1];if(n&&"field"===e.type&&e.aliasName)o.add(e.aliasName);else{const e=p(s,t[0]);e&&o.add(e)}}for(const e of Object.keys(s))o.has(e)||r.add(e)}return r}function $n(e,t,n,r){var o,s,a,i;const l=0===r?"master":"detail",c=JSON.stringify(n.name.slice(0,n.name.length-1)),u=JSON.stringify(n.name),f=null!==(o=n.resolverName)&&void 0!==o?o:"",d=t.get(c),p=null!==(i=0===r?(null!==(s=e.relationships[f])&&void 0!==s?s:{})[d]:(null!==(a=e.relationships[d])&&void 0!==a?a:{})[f])&&void 0!==i?i:{};return{parentType:l,parentKey:c,currentKey:u,resolverName:f,parentResolverName:d,masterRelationshipInfo:p,foreignIdField:"object"==typeof p&&p.id?p.id:0===r?e.rules.foreignIdFieldName(d):e.rules.foreignIdFieldName(f),parentIdFieldName:d?e.rules.idFieldName(d):void 0,currentIdFieldName:e.rules.idFieldName(f)}}function In(e,t,n,r,o,s,a,i,l){return On(this,void 0,void 0,(function*(){let c,f;const d=null!=a?a:new Map,p=null!=i?i:new Map,m=null!=l?l:{},{limit:h,offset:g}=function(e,t,n){var r,o;if(n=null!=n?n:null,null!==(t=null!=t?t:null)&&"object"==typeof t){if(!Object.prototype.hasOwnProperty.call(e,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const n=null!==(r=e[t.name])&&void 0!==r?r:null;if("number"!=typeof n)throw new Error(`Parameter '${t.name}' should be number.`);t=n}if(null!==n&&"object"==typeof n){if(!Object.prototype.hasOwnProperty.call(e,n.name))throw new Error(`Parameter '${n.name}' is not found.`);const t=null!==(o=e[n.name])&&void 0!==o?o:null;if("number"!=typeof t)throw new Error(`Parameter '${n.name}' should be number.`);n=t}return{limit:t,offset:n}}(t,o.limit,o.offset);!s&&e.events.beginExecute&&(yield e.events.beginExecute({resolverData:m,transactionData:n,transactionOptions:r}));try{const a=o.where?u(o.where):[],i=o.having?u(o.having):[];yield En(e,t,n,r,a,m),yield En(e,t,n,r,i,m);const l=[],y=new Map;for(let w=0;w<o.from.length;w++){const b=o.from[w],{parentType:v,parentKey:A,currentKey:k,resolverName:x,parentResolverName:N,foreignIdField:_,parentIdFieldName:C,currentIdFieldName:F}=$n(e,p,b,w);if(!b.resolver)throw new Error(`Resolver name ${b.name.join(".")} is not resolved.`);let O=[];const P=d.get(A),j=b.condAliasFields.size>0,E=!(0!==w||!o.groupBy),D=Array.from(b.queryFields.values()),T=Array.from(b.condFields.values()),S=Array.from(b.havingCondFields.values()),L=0===w&&o.groupBy?o.groupBy:[],$=Array.from(b.sortFieldNames.values()),M=Array.from(b.relationshipIdFields.values()),R=Array.from(new Set(D.concat(T).concat(S).concat(e.rules.idFieldName?[e.rules.idFieldName(x)]:[]).concat(L).concat($).concat(M)).values()),U=u(a).map(e=>jn(b.name,e)).filter(Pn),Q=u(i).map(e=>jn(b.name,e)).filter(Pn),B={functions:e.functions,query:o,params:t,graphPath:b.name,resolverName:x,parentResolverName:N,parentType:v,foreignIdField:_,masterIdField:0===w?C:F,detailIdField:0===w?F:C,parentRecords:P,conditions:U,resolverData:m,transactionData:n,transactionOptions:r};if(0===w){const e=Object.assign(Object.assign({},B),{parent:s,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}});if(O=yield b.resolver(R,j?[]:U,E||j?null:h,E||j?null:g,e),f=e.resolverCapabilities,j&&(f.filtering=!1,f.limit=!1,f.offset=!1,f.sorting=!1),j&&(O=Dn(B,b,O,E)),e.resolverCapabilities.filtering||(O=I(B,U,O)),j||(O=Dn(B,b,O,E)),E){f.limit=!1,f.offset=!1,f.sorting=!1;const e=q(B,Q,Tn(0,L,0,O));O=Sn(B,L,b,e)}c=O}else if(P&&P.length){e.events.beforeMasterSubQueries&&(yield e.events.beforeMasterSubQueries(B));const t=b.name[b.name.length-1];for(const e of P){const n=Object.assign(Object.assign({},B),{parent:e,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}});let r=(yield b.resolver(R,j?[]:U,1,0,n)).slice(0,1);j&&(n.resolverCapabilities.filtering=!1,n.resolverCapabilities.limit=!1,n.resolverCapabilities.offset=!1,n.resolverCapabilities.sorting=!1),j&&(r=Dn(B,b,r,E)),n.resolverCapabilities.filtering||(r=I(B,U,r)),j||(r=Dn(B,b,r,E)),e[t]=r.length>0?r[0]:null,O=O.concat(r)}e.events.afterMasterSubQueries&&(yield e.events.afterMasterSubQueries(B));const n=y.get(A);n&&n.delete(t)}const W=Ln(b,O,E);l.push([W,O]),y.set(k,W),d.set(k,O),p.set(k,x)}if(o.selectSubQueries&&c){const s=[];for(const a of o.selectSubQueries){const o=a.query.from[0].name,i=JSON.stringify(o.slice(0,o.length-1)),l=d.get(i);if(l){const{parentType:i,resolverName:c,parentResolverName:u,foreignIdField:f,parentIdFieldName:h,currentIdFieldName:g}=$n(e,p,a.query.from[0],0),y={functions:e.functions,query:a.query,params:t,graphPath:o,resolverName:c,parentResolverName:u,parentType:i,foreignIdField:f,masterIdField:h,detailIdField:g,parentRecords:l,resolverData:m,transactionData:n,transactionOptions:r};e.events.beforeDetailSubQueries&&(yield e.events.beforeDetailSubQueries(Object.assign({},y)));for(const i of l)s.push(In(e,t,n,r,a.query,i,d,p,m).then(e=>({name:o,parent:i,result:e})));e.events.afterDetailSubQueries&&(yield e.events.afterDetailSubQueries(Object.assign({},y)))}const c=y.get(i);c&&c.delete(o[o.length-1])}(yield Promise.all(s)).forEach(e=>{e.parent[e.name[e.name.length-1]]=e.result})}c?f&&(f.sorting||(c=M(o,c)),f.offset||f.limit?f.offset?f.limit||"number"==typeof h&&(c=c.slice(0,h)):"number"==typeof g&&(c=c.slice(g)):"number"==typeof g&&"number"==typeof h?c=c.slice(g,g+h):"number"==typeof g?c=c.slice(g):"number"==typeof h&&(c=c.slice(0,h))):c=[];for(const e of l){const[t,n]=e;for(const e of n)for(const n of t)delete e[n]}!s&&e.events.endExecute&&(yield e.events.endExecute({resolverData:m,transactionData:n,transactionOptions:r},null))}catch(t){throw!s&&e.events.endExecute&&(yield e.events.endExecute({resolverData:m,transactionData:n,transactionOptions:r},t)),t}return c}))}var qn=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function i(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};var Mn=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function i(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};class Rn{constructor(e,t){this.query=e,this.runCompiledQuery=t}execute(e){return this.runCompiledQuery(this.query,e)}}function Un(e){const t=function(e){const t=Object.assign({},e);t.relationships||(t.relationships={});for(const e of Object.keys(t.resolvers.query))t.relationships[e]||(t.relationships[e]={});return t.resolvers.insert||(t.resolvers.insert={}),t.resolvers.update||(t.resolvers.update={}),t.resolvers.remove||(t.resolvers.remove={}),t.functions||(t.functions=[]),t.functions=t.functions.concat(_n),t.rules||(t.rules={}),t.rules=Object.assign(Object.assign({},Cn),t.rules),t.events||(t.events={}),t}(e),n={};class r{constructor(){this.eventQueue=[]}publish(e,r,o){const s=n[e];if(s&&s.size){{const t=s.get(null);if(t)for(const n of t.values())this.eventQueue.push({on:r,resolver:e,id:null,fn:n})}const n=t.rules.idFieldName(e);for(const t of o){const o=t[n],a=s.get(o);if(a)for(const t of a.values())this.eventQueue.push({on:r,resolver:e,id:o,fn:t})}}}toPublishFn(){return(e,t,n)=>this.publish(e,t,n)}fire(){if(this.eventQueue.length){const e=this.eventQueue;this.eventQueue=[],setTimeout(()=>{for(const t of e)try{t.fn({on:t.on,resolver:t.resolver,id:t.id})}catch(e){}},0)}}}function o(e,t,r){n[e]||(n[e]=new Map);const o=n[e];o.has(t)||o.set(t,new Set);o.get(t).add(r)}function s(e,t,r){if(!n[e])return;const o=n[e];if(!o.has(t))return;o.get(t).delete(r)}return function e(n,a,i,l){const c=null==i?void 0:i.toPublishFn();function u(e,n,r,o){return Mn(this,void 0,void 0,(function*(){try{t.events.beginTransaction&&(yield t.events.beginTransaction({resolverData:{},transactionData:e,transactionOptions:n}));const s=yield o(e,n,r.toPublishFn());return t.events.endTransaction&&(yield t.events.endTransaction({resolverData:{},transactionData:e,transactionOptions:n},null)),r.fire(),s}catch(r){try{t.events.endTransaction&&(yield t.events.endTransaction({resolverData:{},transactionData:e,transactionOptions:n},r))}catch(e){}throw r}}))}function f(e,o){return Mn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Mn(this,void 0,void 0,(function*(){const a=yield In(t,null!=o?o:{},n,r,e,null,null,null,null);return e.for&&(e.for.includes("view")||e.for.includes("reference"))&&s(e.from[0].resolverName[e.from[0].resolverName.length-1],"update",a),a}));return l?yield u({},void 0,new r,s):yield s(n,a,c)}))}return{compile:function(e,...n){const r=Fn(t,e,...n);return new Rn(r,f)},soql:function(e,...o){return Mn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Mn(this,void 0,void 0,(function*(){const a=Fn(t,e,...o),i=yield In(t,{},n,r,a,null,null,null,null);return a.for&&(a.for.includes("view")||a.for.includes("reference"))&&s(a.from[0].resolverName[a.from[0].resolverName.length-1],"update",i),i}));return l?yield u({},void 0,new r,s):yield s(n,a,c)}))},insert:function(e,o){return Mn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Mn(this,void 0,void 0,(function*(){const a=Array.isArray(o),i=yield function(e,t,n,r,o){return qn(this,void 0,void 0,(function*(){const s=e.resolvers.insert;let a=null;for(const e of Object.keys(s))e.toLowerCase()===r.toLowerCase()&&(a=s[e]);if(!a)throw new Error(`Resolver name ${r} is not resolved.`);const i={resolverData:{},transactionData:t,transactionOptions:n};e.events.beginExecute&&(yield e.events.beginExecute(i));let l=null;try{const s={functions:e.functions,graphPath:[],resolverName:r,resolverData:i.resolverData,transactionData:t,transactionOptions:n,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}};l=yield a(o,s),e.events.endExecute&&(yield e.events.endExecute(i,null))}catch(t){throw e.events.endExecute&&(yield e.events.endExecute(i,t)),t}return l}))}(t,n,r,e,a?o:[o]);return s(e,"insert",i),a?i:i[0]}));return l?yield u({},void 0,new r,s):yield s(n,a,c)}))},update:function(e,o){return Mn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Mn(this,void 0,void 0,(function*(){const a=Array.isArray(o),i=yield function(e,t,n,r,o){return qn(this,void 0,void 0,(function*(){const s=e.resolvers.update;let a=null;for(const e of Object.keys(s))e.toLowerCase()===r.toLowerCase()&&(a=s[e]);if(!a)throw new Error(`Resolver name ${r} is not resolved.`);const i={resolverData:{},transactionData:t,transactionOptions:n};e.events.beginExecute&&(yield e.events.beginExecute(i));let l=null;try{const s={functions:e.functions,graphPath:[],resolverName:r,resolverData:i.resolverData,transactionData:t,transactionOptions:n,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}};l=yield a(o,s),e.events.endExecute&&(yield e.events.endExecute(i,null))}catch(t){throw e.events.endExecute&&(yield e.events.endExecute(i,t)),t}return l}))}(t,n,r,e,a?o:[o]);return s(e,"update",i),a?i:i[0]}));return l?yield u({},void 0,new r,s):yield s(n,a,c)}))},remove:function(e,o){return Mn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Mn(this,void 0,void 0,(function*(){const a=Array.isArray(o)?o:[o];yield function(e,t,n,r,o){return qn(this,void 0,void 0,(function*(){const s=e.resolvers.remove;let a=null;for(const e of Object.keys(s))e.toLowerCase()===r.toLowerCase()&&(a=s[e]);if(!a)throw new Error(`Resolver name ${r} is not resolved.`);const i={resolverData:{},transactionData:t,transactionOptions:n};e.events.beginExecute&&(yield e.events.beginExecute(i));try{const s={functions:e.functions,graphPath:[],resolverName:r,resolverData:i.resolverData,transactionData:t,transactionOptions:n,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}};yield a(o,s),e.events.endExecute&&(yield e.events.endExecute(i,null))}catch(t){throw e.events.endExecute&&(yield e.events.endExecute(i,t)),t}}))}(t,n,r,e,a),s(e,"remove",a)}));return l?yield u({},void 0,new r,s):yield s(n,a,c)}))},touch:function(e,t){return Mn(this,void 0,void 0,(function*(){const n=(n,r,o)=>{const s=Array.isArray(t)?t:[t];return o(e,"update",s),Promise.resolve()};return l?yield u({},void 0,new r,n):yield n(0,0,c)}))},subscribe:o,unsubscribe:s,transaction:function(t,n){return Mn(this,void 0,void 0,(function*(){const o={},s=new r,a=e(o,n,s,!1);return yield u(o,n,s,(e,n,r)=>Mn(this,void 0,void 0,(function*(){yield t({compile:a.compile,soql:a.soql,insert:a.insert,update:a.update,remove:a.remove,touch:a.touch},e)})))}))}}}({},void 0,void 0,!0)}const Qn=ne({rawToToken:e=>e,concatTokens:e=>e.length?[e.reduce((e,t)=>e+t)]:[]}),{seq:Bn,cls:Wn,notCls:zn,classes:Jn,numbers:Yn,cat:Zn,repeat:Hn,end:Gn,first:Kn,combine:Vn,erase:Xn,trans:er,ahead:tr,makeProgram:nr}=Qn,rr=er(e=>[Number.parseInt(e[0].replace(/_/g,""),10)])(Yn.int),or=Kn(er(e=>[Number.parseFloat(e[0].replace(/_/g,""))])(Yn.float),rr),sr=er(e=>[!0])(Bn("true")),ar=er(e=>[!1])(Bn("false")),ir=er(e=>e.length?e:[""])(Xn(Hn(Jn.spaceWithinSingleLine),Wn('"')),Zn(Hn(Kn(er(e=>['"'])(Bn('""')),zn('"')))),Xn(Wn('"'),Hn(Xn(Jn.spaceWithinSingleLine)))),lr=er(e=>e.length?e:[null])(Xn(Hn(Jn.spaceWithinSingleLine)),Kn(sr,ar,or),Xn(Hn(Jn.spaceWithinSingleLine)),tr(Kn(Wn(",","\r\n","\n","\r"),Gn()))),cr=er(e=>e.length?[e[0]?e[0].trim():""]:[null])(Xn(Hn(Jn.spaceWithinSingleLine)),Zn(Hn(Kn(Xn(Jn.spaceWithinSingleLine,tr(Wn(",","\r\n","\n","\r"))),zn(",","\r\n","\n","\r"))))),ur=Kn(ir,lr,cr),fr=er(e=>[e])(ur,Hn(Vn(Xn(Bn(",")),ur))),dr=nr(Vn(fr,Hn(Vn(Xn(Jn.newline),fr)),Gn()));var pr=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function i(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};const mr={noCache:!1,noFiltering:!1,noSorting:!1};function hr(e){Object.assign(mr,e)}function gr(e){const t=JSON.parse(e);if(!Array.isArray(t))throw new Error("jsonRecordsParser: Records should be array.");return t}function yr(e){const t=function(e){const t=dr(U(e));if(!t.succeeded)throw new Error(Q(t));return t.tokens}(e.trim());if(!t.length)throw new Error("csvRecordsParser: Header row is needed.");const n=t[0];for(let e=0;e<n.length;e++)if(c(l,n[e]))throw new Error("Unsafe symbol name is appeared: "+n[e]);const r=[];for(let e=1;e<t.length;e++){const o=t[e],s={};for(let e=0;e<n.length;e++)s[n[e]]=o[e];r.push(s)}return r}function wr(e){return e}function br(e){return(t,n,r)=>(o,s,a,i,l)=>pr(this,void 0,void 0,(function*(){let c,u=null;l.resolverData.cache?(c=l.resolverData.cache,c.has(t)&&(u=c.get(t))):(c=new Map,r.noCache||(l.resolverData.cache=c));let d=null;if(null===u){const r=yield n();d=e(r),c.set(t,d.map(e=>Object.assign({},e)))}else d=u.map(e=>Object.assign({},e));return function(e,t,n,r,o,s,a){if(!e.length)return e;const i=new Set,l=new Map(Object.keys(e[0]).map(e=>[e.toLowerCase(),e])),c=new Set(t.map(e=>e.toLowerCase()));for(const e of c.keys())if(!l.has(e))throw new Error(`Field "${e}" is not supplied from resolver "${s.resolverName}".`);if(a.noFiltering||(e=I(s,n,e),s.resolverCapabilities.filtering=!0),e.length&&s.parent)switch(s.parentType){case"master":if(s.foreignIdField){const t=m(s.parent,s.masterIdField),n=p(e[0],s.foreignIdField);e=e.filter(e=>e[n]===t)}break;case"detail":if(s.foreignIdField){const t=m(s.parent,s.foreignIdField),n=p(e[0],s.masterIdField);e=e.filter(e=>e[n]===t)}}if(a.noFiltering)return e;if(!a.noSorting&&s.query&&s.query.orderBy){const t=s.query.from[0].name.length;s.graphPath.length===t&&f(s.graphPath,s.query.from[0].name)&&s.query.orderBy.every(e=>e.name.length===t+1&&l.has(e.name[e.name.length-1].toLowerCase()))&&(e=M(s.query,e),s.resolverCapabilities.sorting=!0)}for(const e of l.keys())c.has(e)||i.add(l.get(e));for(const t of e)for(const e of i)delete t[e];return s.resolverCapabilities.sorting&&("number"==typeof o&&(e=e.slice(o)),"number"==typeof r&&(e=e.slice(0,r)),s.resolverCapabilities.limit=!0,s.resolverCapabilities.offset=!0),e}(d,o,s,a,i,l,r)}))}const vr=(e,t,n)=>br(gr)(e,t,null!=n?n:mr),Ar=(e,t,n)=>br(yr)(e,t,null!=n?n:mr),kr=(e,t,n)=>br(wr)(e,t,null!=n?n:mr)}])}));
//# sourceMappingURL=opensoql.min.js.map