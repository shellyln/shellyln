!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.opensoql=t():e.opensoql=t()}(this,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";n.r(t),n.d(t,"applyWhereConditions",(function(){return M})),n.d(t,"applyHavingConditions",(function(){return R})),n.d(t,"getIndexFieldConditions",(function(){return Q})),n.d(t,"getSqlConditionString",(function(){return U})),n.d(t,"escapeSqlStringLiteral_Std",(function(){return B})),n.d(t,"escapeSqlStringLiteral_MySql",(function(){return W})),n.d(t,"sortRecords",(function(){return z})),n.d(t,"build",(function(){return Gn})),n.d(t,"setDefaultStaticResolverConfig",(function(){return xr})),n.d(t,"staticJsonResolverBuilder",(function(){return Or})),n.d(t,"staticCsvResolverBuilder",(function(){return Fr})),n.d(t,"passThroughResolverBuilder",(function(){return Er}));const r=/^(\d{4}-[01]\d-[0-3]\d)$/,o=/^((?:(?:\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+)|(?:\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d)|(?:\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d))(?:[+-][0-2]\d:[0-5]\d|Z))$/;function s(e){switch(typeof e){case"object":if(Array.isArray(e))return e.slice().map(e=>s(e));if(null===e)return e;if(e instanceof Map){const t=Array.from(e.entries()).map(e=>[s(e[0]),s(e[1])]);return new Map(t)}if(e instanceof Set){const t=Array.from(e.values()).map(e=>s(e));return new Set(t)}{const t={};for(const n of Object.keys(e))t[n]=s(e[n]);return t}default:return e}}function a(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].toLowerCase()!==t[n].toLowerCase())return!1;return!0}function i(e,t){const n=[];for(let r=0;r<e.length;r++){const o=e.slice(r);if(a(t.slice(0,o.length),o))break;n.push(e[r])}return n.length?n.concat(t):t}function l(e,t){const n=Object.keys(e),r=t.toLowerCase(),o=n.findIndex(e=>e.toLowerCase()===r);return 0>o?null:n[o]}function c(e,t){const n=Object.keys(e),r=t.toLowerCase(),o=n.findIndex(e=>e.toLowerCase()===r);return 0>o?null:e[n[o]]}function u(e,t,n){const r=n.toLowerCase();return e.has(r)?t[e.get(r)]:null}function f(e,t){const n=[];let r=e;for(const e of t){if(null==r)return null;const t=Object.keys(r),o=e.toLowerCase(),s=t.findIndex(e=>e.toLowerCase()===o);if(0>s)return null;r=r[t[s]],n.push(t[s])}return n}function d(e,t){let n=e;for(const e of t)if(n=n[e],null==n)return null;return n}function p(e,t){let n=e;for(const e of t){const t=Object.keys(n),r=e.toLowerCase(),o=t.findIndex(e=>e.toLowerCase()===r);if(0>o)return null;if(n=n[t[o]],null==n)return null}return n}function m(e){switch(e.op){case"true":return!1;case"not":case"and":case"or":if(0===e.operands.length)return!1}return!0}function h(e,t){if(t.operands.length){const n=t.operands[0];switch(typeof n){case"object":if(null===n);else if(Array.isArray(n));else switch(n.type){case"field":if(!a(e,n.name.slice(0,n.name.length-1)))return{type:"condition",op:"true",operands:[]};n.name=n.name.slice(n.name.length-1);break;case"fncall":{const t=function e(t,n){for(const r of n.args)switch(typeof r){case"object":if(null===r);else switch(r.type){case"field":if(!a(t,r.name.slice(0,r.name.length-1)))return{type:"condition",op:"true",operands:[]};r.name=r.name.slice(r.name.length-1);break;case"fncall":{const n=e(t,r);if(n)return n}}}return null}(e,n);if(t)return t}}}}return function(e,t){return t.operands=t.operands.map(t=>{switch(typeof t){case"object":if(Array.isArray(t))return t;if(null===t)return t;switch(t.type){case"condition":return h(e,t);default:return t}default:return t}}).filter(e=>{switch(typeof e){case"object":if(null!==e&&!Array.isArray(e)&&"condition"===e.type)return m(e)}return!0}),t}(e,t)}function g(e,t,n){const r=(t,n)=>{const r=[];g(r,t,n),n.operands=r,"and"!==t&&"or"!==t||1!==r.length?e.push(n):e.push(r[0])};switch(n.op){case"and":case"or":case"not":n.op===t?(()=>{for(const o of n.operands)switch(typeof o){case"object":if(null===o||Array.isArray(o))throw new Error("Unexpected AST is found.");switch(o.type){case"condition":switch(o.op){case"and":case"or":case"not":"not"!==o.op&&o.op===t?g(e,o.op,o):r(o.op,o);break;default:e.push(o)}break;default:throw new Error(`Unexpected AST ${o.type} is found.`)}break;default:throw new Error("Unexpected AST is found.")}})():r(n.op,n);break;default:e.push(n)}}function y(e,t){var n;if(!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const r=null!==(n=e.params[t.name])&&void 0!==n?n:null;if(Array.isArray(r))throw new Error(`Parameter '${t.name}' items should be atom.`);return r}function w(e,t){var n;if(!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const r=null!==(n=e.params[t.name])&&void 0!==n?n:null;return Array.isArray(r),r}function b(e,t,n){return t.operands=t.operands.map(t=>{switch(typeof t){case"object":if(Array.isArray(t))return t.map(t=>null!==t&&"object"==typeof t&&"parameter"===t.type?y(e,t):t);if(null===t)return t;switch(t.type){case"condition":return v(e,t,n);default:return t}default:return t}}).filter(e=>{switch(typeof e){case"object":if(null!==e&&!Array.isArray(e)&&"condition"===e.type)return m(e)}return!0}),t}function v(e,t,n){if(t.operands.length){{const e=t.operands[0];switch(typeof e){case"object":if(null===e||Array.isArray(e))return{type:"condition",op:"true",operands:[]};switch(e.type){case"field":if(!n.includes(e.name[e.name.length-1].toLowerCase()))return{type:"condition",op:"true",operands:[]};break;case"fncall":return{type:"condition",op:"true",operands:[]}}break;default:return{type:"condition",op:"true",operands:[]}}}{const r=t.operands[1];switch(typeof r){case"object":if(null===r||Array.isArray(r));else switch(r.type){case"fncall":case"subquery":return{type:"condition",op:"true",operands:[]};case"parameter":return b(e,{type:"condition",op:t.op,operands:[t.operands[0],w(e,r),...t.operands.slice(2)]},n)}}}}return b(e,t,n)}const A=new WeakMap,k=new WeakMap,N=new WeakMap,x=new WeakMap;function _(e,t,n,r,o,s){const a=t.args.map(t=>{var n;switch(typeof t){case"object":if(null===t)return t;switch(t.type){case"field":{let e=c(o,t.name[t.name.length-1]);switch(r){case"date":case"datetime":e=new Date(e).getTime()}return e}case"date":case"datetime":switch(r){case"date":case"datetime":return new Date(t.value).getTime();default:return t.value}case"parameter":{if(!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const o=null!==(n=e.params[t.name])&&void 0!==n?n:null;if(null===o)return null;switch(r){case"date":case"datetime":if(Array.isArray(o))throw new Error(`Parameter '${t.name}' should be string, number, or boolean.`);switch(typeof o){case"object":return new Date(o.value).getTime();case"boolean":return new Date(Number(o)).getTime();default:return new Date(o).getTime()}default:if(null===o)return null;if("object"==typeof o){if(Array.isArray(o))throw new Error(`Parameter '${t.name}' should be string, number, or boolean.`);return o.value}return o}}case"fncall":{let n=N.get(t);if(!n){const r=t.fn.toLowerCase();n=e.functions.find(e=>e.name.toLowerCase()===r)}const r=n;switch(null==r?void 0:r.type){case"aggregate":if(!s)throw new Error(`Nested function ${t.fn} is not allowed.`);return j(e,t,r,"any",s);case"scalar":return _(e,t,r,"any",o,s);case"immediate-scalar":return C(e,t,r,"any",o,s);default:throw new Error(`Nested function ${t.fn} is not allowed.`)}}default:return t}default:return t}});return n.fn(e,a,o)}function C(e,t,n,r,o,s){const a=x.get(t.args);if(a)return a.value;let i=!1;const l=t.args.map(t=>{var n;switch(typeof t){case"object":if(null===t)return t;switch(t.type){case"field":throw new Error(`Immediate scalar function should not refer the field (${t.name.join(".")}).`);case"date":case"datetime":switch(r){case"date":case"datetime":return new Date(t.value).getTime();default:return t.value}case"parameter":{if(i=!0,!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const o=null!==(n=e.params[t.name])&&void 0!==n?n:null;if(null===o)return null;switch(r){case"date":case"datetime":if(Array.isArray(o))throw new Error(`Parameter '${t.name}' should be string, number, or boolean.`);switch(typeof o){case"object":return new Date(o.value).getTime();case"boolean":return new Date(Number(o)).getTime();default:return new Date(o).getTime()}default:if(null===o)return null;if("object"==typeof o){if(Array.isArray(o))throw new Error(`Parameter '${t.name}' should be string, number, or boolean.`);return o.value}return o}}case"fncall":{null===s&&null===o||(i=!0);let n=N.get(t);if(!n){const r=t.fn.toLowerCase();n=e.functions.find(e=>e.name.toLowerCase()===r)}const r=n;switch(null==r?void 0:r.type){case"aggregate":if(null===s)throw new Error(`Nested function ${t.fn} is not allowed.`);return j(e,t,r,"any",s);case"scalar":if(null===o)throw new Error(`Nested function ${t.fn} is not allowed.`);return _(e,t,r,"any",o,s);case"immediate-scalar":return C(e,t,r,"any",o,s);default:throw new Error(`Nested function ${t.fn} is not allowed.`)}}default:return t}default:return t}}),c=n.fn(e,l);return i||x.set(t.args,{value:c}),c}function j(e,t,n,r,o){const s=t.args.map(t=>{var n;switch(typeof t){case"object":if(null===t)return t;switch(t.type){case"field":{let e=o.map(e=>c(e,t.name[t.name.length-1]));switch(r){case"date":case"datetime":e=e.map(e=>new Date(e).getTime())}return e}case"date":case"datetime":switch(r){case"date":case"datetime":return new Date(t.value).getTime();default:return t.value}case"parameter":{if(!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const o=null!==(n=e.params[t.name])&&void 0!==n?n:null;if(null===o)return null;switch(r){case"date":case"datetime":if(Array.isArray(o))throw new Error(`Parameter '${t.name}' should be string, number, or boolean.`);switch(typeof o){case"object":return new Date(o.value).getTime();case"boolean":return new Date(Number(o)).getTime();default:return new Date(o).getTime()}default:if(null===o)return null;if("object"==typeof o){if(Array.isArray(o))throw new Error(`Parameter '${t.name}' should be string, number, or boolean.`);return o.value}return o}}case"fncall":{let n=N.get(t);if(!n){const r=t.fn.toLowerCase();n=e.functions.find(e=>e.name.toLowerCase()===r)}const r=n;switch(null==r?void 0:r.type){case"scalar":return o.map(n=>_(e,t,r,"any",n,o));case"immediate-scalar":return o.map(n=>C(e,t,r,"any",n,o));default:throw new Error(`Nested function ${t.fn} is not allowed.`)}}default:return t}default:return t}});return n.fn(e,s,o)}function P(e,t){if(e.has(t)){const n=e.get(t);if(n)return n}return null}function O(e,t,n){for(const r of n)switch(typeof r){case"object":switch(null==r?void 0:r.type){case"field":if(!P(t,r.name[r.name.length-1]))return!1;break;case"fncall":{const n=r.fn.toLowerCase(),o=e.functions.find(e=>e.name.toLowerCase()===n);switch(null==o?void 0:o.type){case"scalar":if(!O(e,t,r.args))return!1}}}}return!0}const F=(e,t,n,r)=>{},E=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return j(t,o,a,s,r)},S=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return _(t,o,a,s,r[0],r)},T=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return _(t,o,a,s,r,null)},D=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return C(t,o,a,s,null,r)},$=(e,t,n,r)=>{const{op:o,op2FieldResultType:s,fnInfo:a}=n;return C(t,o,a,s,r,null)};function L(e,t,n,r,o,s){var a;let i=null;const l=o.operands[0],c=null!==(a=A.get(o))&&void 0!==a?a:function(e,t,n,r){let o=A.get(r);const s=r.operands[0],a=r.operands[1];let i=!1,l="any";switch(typeof a){case"object":if(null===a);else if(Array.isArray(a));else switch(a.type){case"date":case"datetime":i=!0,l=a.type}}switch(typeof s){case"object":if(null===s);else{if(Array.isArray(s))throw new Error("Array is not allowed in the operand(1).");switch(s.type){case"field":o={isField:!0,isDateOrDatetime:i,op:s,op2FieldResultType:l,fnInfo:null,fn:F},A.set(r,o);break;case"fncall":{const a=s.fn.toLowerCase(),i=n.functions.find(e=>e.name.toLowerCase()===a);switch(null==i?void 0:i.type){case"aggregate":if(!t)throw new Error(`Aggregate function ${i.name} is not allowed.`);o={isField:!1,isDateOrDatetime:!1,op:s,op2FieldResultType:l,fnInfo:i,fn:E},A.set(r,o);break;case"scalar":if(t){if(!O(n,e,s.args))throw new Error(s.fn+" is not allowed. Aggregate function is needed.");o={isField:!1,isDateOrDatetime:!1,op:s,op2FieldResultType:l,fnInfo:i,fn:S},A.set(r,o)}else o={isField:!1,isDateOrDatetime:!1,op:s,op2FieldResultType:l,fnInfo:i,fn:T},A.set(r,o);break;case"immediate-scalar":o={isField:!1,isDateOrDatetime:!1,op:s,op2FieldResultType:l,fnInfo:i,fn:t?D:$},A.set(r,o);break;default:throw new Error("Unexpected type appears in the operand(1).")}}break;default:throw new Error("Unexpected type appears in the operand(1).")}}break;default:throw new Error("Unexpected type appears in the operand(1).")}return o}(t,n,r,o);if(null===l);else{if(Array.isArray(l))throw new Error("Array is not allowed in the operand(1).");if(c.isField){const{isDateOrDatetime:t,op:n}=c;i=u(e,s,n.name[n.name.length-1]),t&&null!==i&&(i=new Date(i).getTime())}else i=c.fn(e,r,c,s)}return i}function I(e,t,n,r,o,s){return q(e,t,n,r,o,s)}function q(e,t,n,r,o,s){let a=!0;e:switch(o.op){case"true":break;case"and":for(const i of o.operands)if(!I(e,t,n,r,i,s)){a=!1;break e}break;case"or":for(const a of o.operands)if(I(e,t,n,r,a,s))break e;a=!1;break;case"not":a=!I(e,t,n,r,o.operands[0],s);break;default:{const i=L(e,t,n,r,o,s),l=function(e,t,n){var r;const o=k.get(t);if(o)return o.value;const s=t=>{var n;if(null===t)return null;switch(typeof t){case"object":switch(t.type){case"date":case"datetime":return t.value;case"parameter":{if(!Object.prototype.hasOwnProperty.call(e.params,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const r=null!==(n=e.params[t.name])&&void 0!==n?n:null;if(Array.isArray(r))throw new Error(`Parameter '${t.name}' items should be atom.`);if(null===r)return null;switch(typeof r){case"object":switch(r.type){case"date":case"datetime":return r.value;default:return r}default:return r}}}break;default:return t}};let a=null;const i=t.operands[1];switch(typeof i){case"object":if(null===i);else if(Array.isArray(i))a=i.map(e=>s(e));else switch(i.type){case"fncall":{const t=i.fn.toLowerCase(),n=e.functions.find(e=>e.name.toLowerCase()===t);switch(null==n?void 0:n.type){case"immediate-scalar":a=C(e,i,n,"any",null,null);break;default:throw new Error("Unexpected type appears in the operand(2).")}}break;default:switch(i.type){case"date":case"datetime":a=new Date(i.value).getTime();break;case"parameter":{if(!Object.prototype.hasOwnProperty.call(e.params,i.name))throw new Error(`Parameter '${i.name}' is not found.`);const t=null!==(r=e.params[i.name])&&void 0!==r?r:null;a=Array.isArray(t)?t.map(e=>s(e)):null===t||"object"!=typeof t||"date"!==t.type&&"datetime"!==t.type?t:t.value}break;default:throw new Error("Unexpected type appears in the operand(2).")}}break;default:a=i}switch(t.op){case"like":case"not_like":if("string"!=typeof a)throw new Error(`Operator "${t.op}": operand(2) should be string.`);a=new RegExp(function(e){const t=e.replace(/[.*+?^=!:${}()|[\]/]/g,"\\$&");let n="",r=void 0;for(const e of t){switch(e){case"%":n+="\\"===r?"%":".*";break;case"_":n+="\\"===r?"_":".";break;case"\\":if("\\"===r){n+="\\\\",r=void 0;continue}break;default:"\\"===r&&(n+="\\"),n+=e}r=e}return"\\"===r&&(n+="\\"),`^${n}$`}(a),"i");break;case"in":case"not_in":if(!Array.isArray(a))throw new Error(`Operator "${t.op}": operand(2) should be array.`);break;case"includes":case"excludes":if(!Array.isArray(a))throw new Error(`Operator "${t.op}": operand(2) should be array.`);a=a.map(e=>{if("string"!=typeof e)throw new Error(`Operator "${t.op}": operand(2) array items should be string.`);return e.split(";")})}return k.set(t,{value:a}),a}(r,o);switch(o.op){case"=":i!==l&&(a=!1);break;case"!=":i===l&&(a=!1);break;case"<":if(null===i){a=!1;break}if(null===l){a=!1;break}i<l||(a=!1);break;case"<=":if(null===i){a=!1;break}if(null===l){a=!1;break}i<=l||(a=!1);break;case">":if(null===i){a=!1;break}if(null===l){a=!1;break}i>l||(a=!1);break;case">=":if(null===i){a=!1;break}if(null===l){a=!1;break}i>=l||(a=!1);break;case"like":if("string"!=typeof i){a=!1;break}l.test(i)||(a=!1);break;case"not_like":if("string"!=typeof i){a=!1;break}l.test(i)&&(a=!1);break;case"in":l.filter(e=>null!==e).includes(i)||(a=!1);break;case"not_in":if(null===i){a=!1;break}if(l.includes(null)){a=!1;break}l.includes(i)&&(a=!1);break;case"includes":if("string"!=typeof i){a=!1;break}a=!1;t:for(const e of l){const t=i.split(";");for(const n of e)if(!t.includes(n))continue t;a=!0;break}break;case"excludes":if("string"!=typeof i){a=!1;break}{const e=i.split(";");for(const t of l){let n=!0;for(const r of t)if(!e.includes(r)){n=!1;break}if(n){a=!1;break}}}}}}return a}function M(e,t,n){const r=[];if(!n.length)return r;const o=new Map(Object.keys(n[0]).map(e=>[e.toLowerCase(),e]));e:for(const s of n){for(const n of t)if(!q(o,null,!1,e,n,s))continue e;r.push(s)}return r}function R(e,t,n){var r,o;const s=[];if(!n.length)return s;const a=new Map(Object.keys(n[0][0]).map(e=>[e.toLowerCase(),e])),i=n[0][0],c=new Map(null===(o=null===(r=e.query)||void 0===r?void 0:r.groupBy)||void 0===o?void 0:o.map(e=>{var t;return[e.toLowerCase(),null!==(t=l(i,e))&&void 0!==t?t:""]}));e:for(const r of n){for(const n of t)if(!q(a,c,!0,e,n,r))continue e;s.push(r)}return s}function Q(e,t,n){const r=n.map(e=>e.toLowerCase()),o=[];return g(o,"and",v(e,{type:"condition",op:"and",operands:s(t)},r)),o}function U(e,t,n){return t.map(t=>function e(t,n,r){switch(n.op){case"not":return`(not ${e(t,n.operands[0],r)})`;case"and":case"or":return`(${n.operands.map(n=>e(t,n,r)).join(` ${n.op} `)})`;case"true":case"includes":case"excludes":return"(1=1)"}let o=!1;const s=e=>e.map(e=>{if(null===e)return"null";switch(typeof e){case"object":switch(e.type){case"date":case"datetime":return`'${e.value}'`;case"parameter":return a(e,!1);default:return o=!0,""}case"string":return`'${r.escapeString(e)}'`;default:return e.toString()}}).join(","),a=(e,n)=>{const o=(n?w:y)(t,e);if(null===o)return"null";switch(typeof o){case"object":return Array.isArray(o)?`(${s(o)})`:`'${o.value}'`;case"string":return`'${r.escapeString(o)}'`;default:return String(o)}},i=n.operands.map(e=>{switch(typeof e){case"object":if(Array.isArray(e))return`(${s(e)})`;if(null===e)return"null";switch(e.type){case"field":return r.fieldName(e.name[e.name.length-1]);case"date":case"datetime":return`'${e.value}'`;case"parameter":return a(e,!0);default:return o=!0,""}case"string":return`'${r.escapeString(e)}'`;default:return e.toString()}});if(o)return"(1=1)";{let e=n.op;if("null"===i[1])switch(n.op){case"=":e="is";break;case"!=":e="is not"}return`${String(i[0])} ${e} ${String(i[1])}`}}(e,t,n)).join(" and ")}function B(e){return e.replace(/'/g,"''")}function W(e){return e.replace(/\\/g,"\\\\").replace(/'/g,"\\'")}function z(e,t){if(e.orderBy&&t.length){const n=e.from[0].name.length,r=e.orderBy,o=(e,t)=>"desc"===e.direction?-t:t,s=r.map(e=>({f:e,fName:f(t[0],e.name.slice(n))}));t=t.sort((e,t)=>{e:for(let r=0;r<s.length;r++){let{f:a,fName:i}=s[r],l=null,c=null;if(null!==i?(l=d(e,i),c=d(t,i)):(l=p(e,a.name.slice(n)),s[r].fName=i=f(t,a.name.slice(n)),c=null!==i?d(t,i):null),l!==c){if(null===l)return o(a,"last"===a.nulls?1:-1);if(null===c)return o(a,"last"===a.nulls?-1:1);switch(typeof l){case"number":case"bigint":return o(a,l-c);case"string":return o(a,l>c?1:-1);default:continue e}}}return 0})}return t}class J extends Error{constructor(e){super(e.message),this.result=e}}function Y(e,t){return{src:e,start:0,end:e.length,context:t,templateArgs:[],templateArgsPos:[]}}function Z(e){let t="",n="";if("string"==typeof e.src){n=e.src.slice(Math.max(e.pos-5,0),e.pos+55);let r=n.split(/\r\n|\n|\r/);r=r.slice(0,1).concat("          ^~~~~~~~").concat(...r.slice(1)),n=r.join("\n")+"\n\n";const o=function(e,t){let n=1,r=1;for(let o=0;o<=t;o++)switch(e[o]){case"\r":"\n"===e[o+1]&&o++;case"\n":n++,r=1;break;default:r++}return{line:n,col:r}}(e.src,e.pos);t=`parse failed at position:${e.pos} line:${o.line} col:${o.col} ${e.message?" "+e.message:""}\n     ${n}`}else{n="     (object)\n          ^~~~~~~~";try{n="     "+JSON.stringify(e.src.slice(Math.max(e.pos-10,0),e.pos))+"\n          "+JSON.stringify(e.src.slice(e.pos,e.pos+1))+"\n          "+JSON.stringify(e.src.slice(e.pos+1,e.pos+10));let t=n.split(/\r\n|\n|\r/);t=t.slice(0,2).concat("          ^~~~~~~~").concat(...t.slice(2)),n=t.join("\n")+"\n\n"}catch(e){}t=`parse failed at position:${e.pos} ${e.message?" "+e.message:""}\n     ${n}`}return t}function H(e){return t=>({succeeded:!0,next:{src:t.src,start:t.start,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:e?[e()]:[]})}function G(e){return t=>{throw new J({succeeded:!1,error:!0,src:t.src,pos:t.start,message:e||""})}}function K(e){return t=>0===t.start?{succeeded:!0,next:{src:t.src,start:t.start,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:e?[e()]:[]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "beginning"'}}function V(e){return t=>t.start===t.end?{succeeded:!0,next:{src:t.src,start:t.start,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:e?[e()]:[]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "end"'}}function X(e,t){return e=e||0,n=>r=>{let o=r;const s=[];for(;;){const r=n(o);if(!r.succeeded){if(r.error)return r;if(s.length>=e)break;return{succeeded:!1,error:!1,src:o.src,pos:o.start,message:'operator "quantify"'}}if(o=r.next,s.push({next:r.next,tokens:r.tokens}),t&&t===s.length)break}if(s.length>0){const e=[];for(const t of s)e.push(...t.tokens);return{succeeded:!0,next:s[s.length-1].next,tokens:e}}return{succeeded:!0,next:{src:r.src,start:r.start,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[]}}}function ee(...e){return t=>{let n=null,r=null;for(const o of e){const e=o(t);if(e.succeeded){n={next:e.next,tokens:e.tokens};break}r?e.error?(!r.error||r.pos<e.pos)&&(r=e):r.pos<e.pos&&(r=e):r=e}return n?{succeeded:!0,next:n.next,tokens:n.tokens}:r||{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "first"'}}}function te(...e){return t=>{const n=[];let r=null;for(const o of e){const e=o(t);e.succeeded?n.push({next:e.next,tokens:e.tokens}):r?e.error?(!r.error||r.pos<e.pos)&&(r=e):r.pos<e.pos&&(r=e):r=e}if(n.length>0){const e=n.reduce((e,t)=>e.next.start>=t.next.start?e:t);return{succeeded:!0,next:e.next,tokens:e.tokens}}return r||{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "or"'}}}function ne(e,t){return(...n)=>r=>{let o=r;const s=[];for(const e of n){const t=e(o);if(!t.succeeded)return t;o=t.next,s.push(...t.tokens)}const a=e?e(s,r):s;return{succeeded:!0,next:t?{src:o.src,start:o.start,end:o.end,context:t(o.context),templateArgs:o.templateArgs,templateArgsPos:o.templateArgsPos}:o,tokens:a}}}function re(...e){return t=>{let n=t;for(const t of e){const e=t(n);if(!e.succeeded)return e;n=e.next}return{succeeded:!0,next:t,tokens:[]}}}function oe(e,t){return(...n)=>r=>{if(r.start-e<0)return{succeeded:!1,error:!1,src:r.src,pos:r.start,message:"lookBehind: src is too short"};let o={src:r.src,start:r.start-e,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos};for(const e of n){const t=e(o);if(!t.succeeded)return t;o=t.next}return{succeeded:!0,next:r,tokens:t?[t()]:[]}}}function se(e){return t=>n=>{const r=t(n);if(!r.succeeded)return r;const o=Y(r.tokens,n.context);let s=o,a=!1;if(e.check(s).succeeded)return{succeeded:!0,next:r.next,tokens:r.tokens};e:for(let t=0;void 0===e.maxApply||t<e.maxApply;t++){let t=!1;t:for(const n of e.rules){const{parser:r,rtol:o}="function"==typeof n?{parser:n,rtol:!1}:n,i=s.src.length;for(let n=0;n<=i;n++){const l=r({src:s.src,start:o?i-n:n,end:s.src.length,context:s.context,templateArgs:s.templateArgs,templateArgsPos:s.templateArgsPos});if(l.succeeded){t=!0;const r=s.src.slice(0,o?i-n:n);if(r.push(...l.tokens),r.push(...s.src.slice(l.next.start)),s={src:r,start:0,end:r.length,context:l.next.context,templateArgs:l.next.templateArgs,templateArgsPos:l.next.templateArgsPos},e.check(s).succeeded){a=!0;break e}break t}}}if(!t)break}if(!a&&!e.check(s).succeeded)throw new J({succeeded:!1,error:!0,src:o.src,pos:o.start,message:"The application of production rules was not finished"});return{succeeded:!0,next:r.next,tokens:s.src}}}function ae(e){return t=>{try{return e(t)}catch(e){if(e.result)return e.result;throw e}}}function ie(e,t){return n=>{if("\0"===n.src.slice(n.start,n.start+1)&&n.templateArgsPos){let r=-1;if(0<=n.templateArgsPos.findIndex((e,t)=>(r=t,e===n.start))){const o=n.templateArgs[r];if(e(o))return{succeeded:!0,next:{src:n.src,start:n.start+1,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[t?t(o):o]}}}return{succeeded:!1,error:!1,src:n.src,pos:n.start,message:'operator "stringTemplatesParam()"'}}}function le(e){const t=(n=e.rawToToken,e=>t=>t.src.slice(t.start,t.end).startsWith(e)?{succeeded:!0,next:{src:t.src,start:t.start+e.length,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:[n(e)]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:`operator "charSequence(${e})"`});var n;const r=function(e){return(...t)=>n=>{const r=n.src.slice(n.start,n.end);let o=-1;return t.some((e,t)=>{if(r.startsWith(e))return o=t,!0})?{succeeded:!0,next:{src:n.src,start:n.start+t[o].length,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[e(t[o])]}:{succeeded:!1,error:!1,src:n.src,pos:n.start,message:`operator "charClass(${t.join(",")})"`}}}(e.rawToToken),o=function(e){return(...t)=>n=>{const r=n.src.slice(n.start,n.end);for(const e of t){if(r.startsWith(e))return{succeeded:!1,error:!1,src:n.src,pos:n.start,message:`operator "charClassNot(${t.join(",")})"`}}const o=n.src.codePointAt(n.start);if(void 0===o)return{succeeded:!1,error:!1,src:n.src,pos:n.start,message:`operator "charClassNot(${t.join(",")})"`};const s=String.fromCodePoint(o);return{succeeded:!0,next:{src:n.src,start:n.start+s.length,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[e(s)]}}}(e.rawToToken),s=function(e){return t=>n=>{const r=n.src.slice(n.start,n.end),o=t(r);return o>=0?{succeeded:!0,next:{src:n.src,start:n.start+o,end:n.end,context:n.context,templateArgs:n.templateArgs,templateArgsPos:n.templateArgsPos},tokens:[e(r.substring(0,o))]}:{succeeded:!1,error:!1,src:n.src,pos:n.start,message:'operator "charClassByNeedleFn"'}}}(e.rawToToken),a=ne(e.concatTokens),i=X(1,1),l=X(),c=(e,t)=>X(e,t),u=ne(),f=ne(e=>[]),d=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="Z"||"a"<=n&&n<="z"?n.length:-1}),p=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="Z"?n.length:-1}),m=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"a"<=n&&n<="z"?n.length:-1}),h=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"0"<=n&&n<="9"?n.length:-1}),g=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"1"<=n&&n<="9"?n.length:-1}),y=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"0"<=n&&n<="1"?n.length:-1}),w=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"0"<=n&&n<="7"?n.length:-1}),b=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="F"||"a"<=n&&n<="f"||"0"<=n&&n<="9"?n.length:-1}),v=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return"A"<=n&&n<="Z"||"a"<=n&&n<="z"||"0"<=n&&n<="9"?n.length:-1}),A=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return" \f\n\r\t\v​  ​᠎           ​\u2028\u2029  ​　\ufeff".includes(n)?n.length:-1}),k=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return" \f\t\v​  ​᠎           ​\u2028\u2029  ​　\ufeff".includes(n)?n.length:-1}),N=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return 0<=t&&t<=31||127<=t&&t<=159?n.length:-1}),x=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;const n=String.fromCodePoint(t);return" \f\n\r\t\v​  ​᠎           ​\u2028\u2029  ​　\ufeff".includes(n)||0<=t&&t<=31||127<=t&&t<=159?-1:n.length}),_=r("\r\n","\n","\r"),C=s(e=>{const t=e.codePointAt(0);if(void 0===t)return-1;return String.fromCodePoint(t).length}),j=ee(y,r("_")),P=ee(w,r("_")),O=ee(b,r("_")),F=u(a(c(0,1)(r("+","-")),ee(u(i(g),l(ee(h,r("_")))),t("0")))),E=u(a(F,f(t("n")))),S=u(a(c(0,1)(r("+","-")),ee(u(i(g),l(ee(h,r("_")))),t("0")),c(0,1)(u(t("."),c(1)(ee(h,r("_"))))),c(0,1)(u(r("E","e"),c(0,1)(r("+","-")),ee(u(i(g),l(h)),t("0"))))));return{seq:t,cls:r,notCls:o,clsFn:s,classes:{alpha:d,upper:p,lower:m,num:h,nonzero:g,bin:y,oct:w,hex:b,alnum:v,space:A,spaceWithinSingleLine:k,ctrl:N,newline:_,word:x,any:C},numbers:{bin:(...e)=>u(f(ee(...e)),a(i(y),l(j))),oct:(...e)=>u(f(ee(...e)),a(i(w),l(P))),hex:(...e)=>u(f(ee(...e)),a(i(b),l(O))),int:F,bigint:E,float:S},isParam:ie,cat:a,once:i,repeat:l,qty:c,zeroWidth:e=>H(e),err:e=>G(e),beginning:e=>K(e),end:e=>V(e),first:(...e)=>ee(...e),or:(...e)=>te(...e),combine:u,erase:f,trans:e=>ne(e),ahead:(...e)=>re(...e),behind:(e,t)=>oe(e,t),rules:e=>se(e),makeProgram:ae}}function ce(e,t){return n=>r=>{let o=!0;if(Math.max(0,r.end-r.start)>=n.length){for(let e=0;e<n.length;e++)if(!t(r.src[r.start+e],n[e])){o=!1;break}}else o=!1;return o?{succeeded:!0,next:{src:r.src,start:r.start+n.length,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[e(n)]}:{succeeded:!1,error:!1,src:r.src,pos:r.start,message:`operator "objSequence(${n})"`}}}function ue(e,t){return(...n)=>r=>{const o=Math.max(0,r.end-r.start);let s=-1;return o>0&&n.some((e,n)=>{if(t(r.src[r.start],e))return s=n,!0})?{succeeded:!0,next:{src:r.src,start:r.start+1,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[e(n[s])]}:{succeeded:!1,error:!1,src:r.src,pos:r.start,message:`operator "objClass(${n.join(",")})"`}}}function fe(e,t){return(...n)=>r=>{if(Math.max(0,r.end-r.start)>0)for(const e of n){let o=!0;if(!t(r.src[r.start],e)){o=!1;break}if(o)return{succeeded:!1,error:!1,src:r.src,pos:r.start,message:`operator "objClassNot(${n.join(",")})"`}}return{succeeded:!0,next:{src:r.src,start:r.start+1,end:r.end,context:r.context,templateArgs:r.templateArgs,templateArgsPos:r.templateArgsPos},tokens:[e(r.src[r.start])]}}}const de={},{g:pe,o:me,f:he}=(()=>{var e,t;let n=null;try{n=Function("return this")()}catch(e){}n||(n="object"==typeof window&&window?window:"object"==typeof global&&global?global:"object"==typeof globalThis&&globalThis?globalThis:de);let r=null;try{r=null!==(e={}.constructor)&&void 0!==e?e:Object}catch(e){}r||(r=de);let o=null;try{o=null!==(t={}.toString.constructor)&&void 0!==t?t:Function}catch(e){}return o||(o=de),{g:n,o:r,f:o}})();function ge(e,t){if(e===pe||"__proto__"===t||"__defineGetter__"===t||"__defineSetter__"===t||"__lookupGetter__"===t||"__lookupSetter__"===t)return!0;if(!("prototype"!==t&&"constructor"!==t||null!=e&&"function"!=typeof e))return!0;if((null==e||e===me)&&Object.prototype.hasOwnProperty.call(me,t))return!0;if(null==e||e===he){let e=he;for(;e;){if(Object.prototype.hasOwnProperty.call(e,t))return!0;e=e.__proto__}}return"function"==typeof e&&!Object.prototype.hasOwnProperty.call(e,t)}const ye=le({rawToToken:e=>e,concatTokens:e=>e.length?[e.reduce((e,t)=>String(e)+t)]:[]}),we=function(e){const t=(n=e.rawToToken,e.comparator,e=>t=>Math.max(0,t.end-t.start)>0&&e(t.src[t.start])?{succeeded:!0,next:{src:t.src,start:t.start+1,end:t.end,context:t.context,templateArgs:t.templateArgs,templateArgsPos:t.templateArgsPos},tokens:[n(t.src[t.start])]}:{succeeded:!1,error:!1,src:t.src,pos:t.start,message:'operator "objClassByNeedleFn"'});var n;const r=t(e=>!0);return{seq:ce(e.rawToToken,e.comparator),cls:ue(e.rawToToken,e.comparator),notCls:fe(e.rawToToken,e.comparator),clsFn:t,classes:{any:r},cat:ne(e.concatTokens),once:X(1,1),repeat:X(),qty:(e,t)=>X(e,t),zeroWidth:e=>H(e),err:e=>G(e),beginning:e=>K(e),end:e=>V(e),first:(...e)=>ee(...e),or:(...e)=>te(...e),combine:ne(),erase:ne(e=>[]),trans:e=>ne(e),ahead:(...e)=>re(...e),behind:(e,t)=>oe(e,t),rules:e=>se(e),makeProgram:ae}}({rawToToken:e=>e,concatTokens:e=>e.length?[e.reduce((e,t)=>String(e)+t)]:[],comparator:(e,t)=>e===t}),{seq:be,cls:ve,notCls:Ae,clsFn:ke,classes:Ne,numbers:xe,isParam:_e,cat:Ce,once:je,repeat:Pe,qty:Oe,zeroWidth:Fe,err:Ee,beginning:Se,end:Te,first:De,or:$e,combine:Le,erase:Ie,trans:qe,ahead:Me,rules:Re,makeProgram:Qe}=ye,Ue=e=>ke(t=>t.slice(0,e.length).toLocaleLowerCase()===e?e.length:-1),Be=(e,t,n)=>({type:"condition",op:e,operands:[t,n]}),We=(e,t)=>"object"==typeof e&&"rawop"===e.type&&e.op===t,ze=Le(Ie(Oe(2)(ve("-"))),De(Le(Pe(Ae("\r\n","\n","\r")),De(Ne.newline,Me(Te()))),De(Ne.newline,Me(Te())))),Je=Le(be("/*"),Pe(Ae("*/")),be("*/")),Ye=De(Ne.space,ze,Je),Ze=De(Le(Ue("select"),e=>Ke(e)),Le(Ue("from"),e=>Ke(e)),Le(Ue("where"),e=>Ke(e)),Ce(Le(Ue("order"),Ie(Oe(1)(Ye)),Ue("by"))),Ce(Le(Ue("group"),Ie(Oe(1)(Ye)),Ue("by"))),Le(Ue("having"),e=>Ke(e)),Le(Ue("offset"),e=>Ke(e)),Le(Ue("limit"),e=>Ke(e))),He=Me(e=>Le(Ze,De(Oe(1)(Ye),ve("(",")","'",'"',"=","!","<",">"),Te()))(e).succeeded?{succeeded:!1,error:!1,src:e.src,pos:e.start,message:"Unexpected reserved keyword aheads"}:{succeeded:!0,next:{src:e.src,start:e.start,end:e.end,context:e.context},tokens:[]}),Ge=e=>"string"==typeof e&&/^[A-Za-z0-9$_"]$/.test(e),Ke=Me(e=>{let t=!1;return t=0===e.src.length||(e.start===e.end?Ge(e.src[e.start-1]):0===e.start?Ge(e.src[e.start]):!Ge(e.src[e.start-1])&&Ge(e.src[e.start])||Ge(e.src[e.start-1])&&!Ge(e.src[e.start])),t?{succeeded:!0,next:{src:e.src,start:e.start,end:e.end,context:e.context},tokens:[]}:{succeeded:!1,error:!1,src:e.src,pos:e.start,message:"Expect word break"}}),Ve=qe(e=>[!0])(Ue("true"),Ke),Xe=qe(e=>[!1])(Ue("false"),Ke),et=qe(e=>[null])(Ue("null"),Ke),tt=qe(e=>[Number.POSITIVE_INFINITY])(Oe(0,1)(be("+")),be("Infinity"),Ke),nt=qe(e=>[Number.NEGATIVE_INFINITY])(be("-Infinity"),Ke),rt=qe(e=>[Number.NaN])(be("NaN"),Ke),ot=qe(e=>[Number.parseInt(e[0].replace(/_/g,""),2)])(xe.bin(be("0b"))),st=qe(e=>[Number.parseInt(e[0].replace(/_/g,""),8)])(xe.oct(be("0o"),be("0"))),at=qe(e=>[Number.parseInt(e[0].replace(/_/g,""),16)])(xe.hex(be("0x"),be("0X"))),it=qe(e=>[Number.parseInt(e[0].replace(/_/g,""),10)])(xe.int),lt=qe(e=>[Number.parseFloat(e[0].replace(/_/g,""))])(xe.float),ct=De(st,at,ot,lt,it,tt,nt,rt),ut=De(qe(e=>["'"])(be("\\'")),qe(e=>['"'])(be('\\"')),qe(e=>["`"])(be("\\`")),qe(e=>["/"])(be("\\/")),qe(e=>["\\"])(be("\\\\")),qe(e=>[""])(be("\\\r\n")),qe(e=>[""])(be("\\\r")),qe(e=>[""])(be("\\\n")),qe(e=>["\n"])(be("\\n")),qe(e=>["\n"])(be("\\N")),qe(e=>["\r"])(be("\\r")),qe(e=>["\r"])(be("\\R")),qe(e=>["\v"])(be("\\v")),qe(e=>["\t"])(be("\\t")),qe(e=>["\t"])(be("\\T")),qe(e=>["\b"])(be("\\b")),qe(e=>["\b"])(be("\\B")),qe(e=>["\f"])(be("\\f")),qe(e=>["\f"])(be("\\F")),qe(e=>[String.fromCodePoint(Number.parseInt(e[0],16))])(Ce(Ie(be("\\u")),Oe(4,4)(Ne.hex))),qe(e=>[String.fromCodePoint(Number.parseInt(e[0],16))])(Ce(Ie(be("\\u{")),Oe(1,6)(Ne.hex),Ie(be("}")))),qe(e=>[String.fromCodePoint(Number.parseInt(e[0],16))])(Ce(Ie(be("\\x")),Oe(2,2)(Ne.hex))),qe(e=>[String.fromCodePoint(Number.parseInt(e[0],8))])(Ce(Ie(be("\\")),Oe(3,3)(Ne.oct)))),ft=qe(e=>{var t;return[null!==(t=e[0])&&void 0!==t?t:""]})(Ie(be("'")),Ce(Pe(De(ut,Le(ve("\r","\n"),Ee("Line breaks within strings are not allowed.")),Ae("'")))),Ie(be("'"))),dt=qe(e=>[{type:"date",value:e[0]}])(Ce(Oe(4,4)(Ne.num),ve("-"),Oe(2,2)(Ne.num),ve("-"),Oe(2,2)(Ne.num),Ke)),pt=qe(e=>[{type:"datetime",value:e[0]}])(Ce(Oe(4,4)(Ne.num),ve("-"),Oe(2,2)(Ne.num),ve("-"),Oe(2,2)(Ne.num),ve("T"),Oe(2,2)(Ne.num),ve(":"),Oe(2,2)(Ne.num),Oe(0,1)(Le(ve(":"),Oe(2,2)(Ne.num))),De(ve("Z"),Le(De(ve("+"),ve("-")),Oe(2,2)(Ne.num),ve(":"),Oe(2,2)(Ne.num))),Ke)),mt=qe(e=>{var t;const n=null!==(t=e[0])&&void 0!==t?t:"";if(ge(de,n))throw new Error("Unsafe symbol name is appeared: "+n);return[n]})(Ie(be('"')),Ce(Pe(De(ut,Le(ve("\r","\n"),Ee("Line breaks within strings are not allowed.")),Ae('"')))),Ie(be('"'))),ht=qe(e=>{if(ge(de,e[0]))throw new Error("Unsafe symbol name is appeared: "+e[0]);return e})(Ce(Le(De(Ne.alpha,ve("$","_")),Pe(De(Ne.alnum,ve("$","_")))))),gt=qe(e=>[{name:e}])(De(ht,mt),Pe(Le(Ie(Pe(Ye),ve("."),Pe(Ye)),De(ht,mt)))),yt=qe(e=>[{type:"parameter",name:e[0]}])(Ie(be(":")),ht),wt=De(_e(e=>{switch(typeof e){case"number":case"string":case"boolean":return!0;case"object":if(null===e)return!0;if(e.type)switch(e.type){case"date":if("string"==typeof e.value)return r.test(e.value);break;case"datetime":if("string"==typeof e.value)return o.test(e.value)}}return!1}),pt,dt,ct,ft,Ve,Xe,et,yt),bt=qe(e=>[{fn:e[0],args:e.slice(1)}])(ht,Ie(Pe(Ye)),Ie(ve("(")),Ie(Pe(Ye)),Pe(De(qe(e=>[Object.assign({type:"fncall"},e[0])])(e=>bt(e)),wt,qe(e=>[Object.assign({type:"field"},e[0])])(gt))),Pe(Le(Ie(Pe(Ye)),Ie(ve(",")),Ie(Pe(Ye)),De(qe(e=>[Object.assign({type:"fncall"},e[0])])(e=>bt(e)),wt,qe(e=>[Object.assign({type:"field"},e[0])])(gt)))),Ie(Pe(Ye)),Ie(ve(")"))),vt=qe(e=>[{query:e[0]}])(Ie(ve("("),Pe(Ye)),e=>zt(e),Ie(Pe(Ye),ve(")"))),At=qe(e=>[e])(Ie(ve("("),Pe(Ye)),wt,Ie(Pe(Ye)),Pe(Le(Ie(ve(","),Pe(Ye)),wt)),Ie(Pe(Ye),ve(")"))),kt=qe(e=>[Object.assign(Object.assign({},e[0]),{aliasName:e.length>1?e[1]:null})])(He,De(qe(e=>[Object.assign({type:"fncall"},e[0])])(bt),qe(e=>[Object.assign({type:"field"},e[0])])(gt),qe(e=>[Object.assign({type:"subquery"},e[0])])(vt)),De(Le(Ie(Pe(Ye)),He,ht),Fe(()=>null))),Nt=qe(e=>[{select:e}])(kt,Ie(Pe(Ye)),Pe(Le(Ie(ve(",")),Ie(Pe(Ye)),kt,Ie(Pe(Ye))))),xt=qe(e=>[{from:e}])(Ie(Ue("from")),qe(e=>{var t;return[Object.assign(Object.assign({},e[0]),{aliasName:null!==(t=e[1])&&void 0!==t?t:null})]})(Ie(Oe(1)(Ye)),He,gt,Oe(0,1)(Le(Ie(Oe(1)(Ye)),He,ht))),Pe(qe(e=>{var t;return[Object.assign(Object.assign({},e[0]),{aliasName:null!==(t=e[1])&&void 0!==t?t:null})]})(Ie(Pe(Ye),ve(","),Pe(Ye)),He,gt,De(Le(Ie(Oe(1)(Ye)),He,ht),Fe(()=>null))))),_t=De(be("!="),be("<="),be(">="),be("="),be("<"),be(">"),qe(e=>[`${e[0]}_${e[1]}`])(Ue("not"),Ie(Oe(1)(Ye)),De(Ue("like"),Ue("in")),Ie(Ke,Pe(Ye))),Le(Ue("like"),Ie(Ke,Pe(Ye))),Le(Ue("in"),Ie(Ke,Pe(Ye))),Le(Ue("includes"),Ie(Ke,Pe(Ye))),Le(Ue("excludes"),Ie(Ke,Pe(Ye)))),Ct=we.trans(e=>{return[(t="not",n=e[1],{type:"condition",op:t,operands:[n]})];var t,n})(we.clsFn(e=>We(e,"not")),we.clsFn(e=>!0)),jt=we.trans(e=>[Be("and",e[0],e[2])])(we.clsFn(e=>!0),we.clsFn(e=>We(e,"and")),we.clsFn(e=>!0)),Pt=we.trans(e=>[Be("or",e[0],e[2])])(we.clsFn(e=>!0),we.clsFn(e=>We(e,"or")),we.clsFn(e=>!0)),Ot=qe(e=>[{type:"condition",op:e[1],operands:e.slice(0,1).concat(e.slice(2))}])(He,De(qe(e=>[Object.assign({type:"fncall"},e[0])])(bt),qe(e=>[Object.assign({type:"field"},e[0])])(gt)),Ie(Pe(Ye)),_t,Ie(Pe(Ye)),De(wt,qe(e=>[Object.assign({type:"subquery"},e[0])])(vt),qe(e=>[Object.assign({type:"fncall"},e[0])])(bt),At)),Ft=qe(e=>e)(Oe(0,1)(Le(qe(e=>[{type:"rawop",op:e[0]}])(Ue("not")),Ie(Ke,Pe(Ye)))),De(qe(e=>e)(Ie(Pe(Ye)),Ie(ve("(")),Ie(Pe(Ye)),e=>Et(e),Ie(Pe(Ye)),Ie(ve(")"))),Ot),Pe(Le(Ie(Pe(Ye)),qe(e=>[{type:"rawop",op:e[0]}])(De(Ue("and"),Ue("or"))),Ie(Ke,Pe(Ye)),e=>Et(e)))),Et=Re({rules:[Ct,jt,Pt],check:we.combine(we.classes.any,we.end())})(qe(e=>e)(Ft)),St=qe(e=>[{where:[e[0]]}])(Ie(Pe(Ye),Ke),Ie(Ue("where")),Ie(De(Me(ve("(")),Oe(1)(Ye),Le(Pe(Ye),Ke))),Et),Tt=qe(e=>[{groupBy:e}])(Ie(Pe(Ye),Ke),Ie(Ue("group"),Oe(1)(Ye),Ue("by"),Oe(1)(Ye)),ht,Pe(Le(Ie(Pe(Ye),ve(","),Pe(Ye)),ht))),Dt=qe(e=>[{type:"condition",op:e[1],operands:e.slice(0,1).concat(e.slice(2))}])(He,qe(e=>[Object.assign({type:"fncall"},e[0])])(bt),Ie(Pe(Ye)),_t,Ie(Pe(Ye)),De(wt,qe(e=>[Object.assign({type:"subquery"},e[0])])(vt,qe(e=>[Object.assign({type:"fncall"},e[0])])(bt),At))),$t=qe(e=>e)(Oe(0,1)(Le(qe(e=>[{type:"rawop",op:e[0]}])(Ue("not")),Ie(Ke,Pe(Ye)))),De(qe(e=>e)(Ie(Pe(Ye)),Ie(ve("(")),Ie(Pe(Ye)),e=>Lt(e),Ie(Pe(Ye)),Ie(ve(")"))),Dt),Pe(Le(Ie(Pe(Ye)),qe(e=>[{type:"rawop",op:e[0]}])(De(Ue("and"),Ue("or"))),Ie(Ke,Pe(Ye)),e=>Lt(e)))),Lt=Re({rules:[Ct,jt,Pt],check:we.combine(we.classes.any,we.end())})(qe(e=>e)($t)),It=qe(e=>[{having:[e[0]]}])(Ie(Pe(Ye),Ke),Ie(Ue("having")),Ie(De(Me(ve("(")),Oe(1)(Ye),Le(Pe(Ye),Ke))),Lt),qt=De(Oe(1,1)(Le(Ie(Oe(1)(Ye)),qe(e=>[e[0].toLowerCase()])(De(Ue("asc"),Ue("desc"))),Ie(Ke))),Fe(()=>"asc")),Mt=De(Oe(1,1)(Le(Ie(Oe(1)(Ye),Ue("nulls"),Oe(1)(Ye)),qe(e=>[e[0].toLowerCase()])(De(Ue("first"),Ue("last"))),Ie(Ke))),Fe(()=>"first")),Rt=qe(e=>[{orderBy:e}])(Ie(Pe(Ye),Ke),Ie(Ue("order"),Oe(1)(Ye),Ue("by"),Oe(1)(Ye)),qe(e=>[Object.assign(Object.assign({},e[0]),{direction:e[1],nulls:e[2]})])(gt,qt,Mt),Pe(Le(Ie(Pe(Ye),ve(","),Pe(Ye)),qe(e=>[Object.assign(Object.assign({},e[0]),{direction:e[1],nulls:e[2]})])(gt,qt,Mt)))),Qt=qe(e=>[{offset:e[0]}])(Ie(Pe(Ye),Ke),Ie(Ue("offset"),Oe(1)(Ye)),De(it,yt,_e(e=>"number"==typeof e))),Ut=qe(e=>[{limit:e[0]}])(Ie(Pe(Ye),Ke),Ie(Ue("limit"),Oe(1)(Ye)),De(it,yt,_e(e=>"number"==typeof e))),Bt=qe(e=>[{for:e.map(e=>e.toLowerCase())}])(Ie(Pe(Ye),Ke),Ie(Ue("for"),Oe(1)(Ye)),De(Le(Ue("view"),Oe(0,1)(Le(Ie(Pe(Ye),ve(","),Pe(Ye)),Ue("reference")))),Le(Ue("reference"),Oe(0,1)(Le(Ie(Pe(Ye),ve(","),Pe(Ye)),Ue("view"))))),Ie(Ke)),Wt=qe(e=>[{for:e.map(e=>e.toLowerCase())}])(Ie(Pe(Ye),Ke),Ie(Ue("for"),Oe(1)(Ye)),Ue("update"),De(Le(Ie(Oe(1)(Ye)),Ue("tracking"),Oe(0,1)(Le(Ie(Pe(Ye),ve(","),Pe(Ye)),Ue("viewstat")))),Le(Ie(Oe(1)(Ye)),Ue("viewstat"),Oe(0,1)(Le(Ie(Pe(Ye),ve(","),Pe(Ye)),Ue("tracking")))),Fe(()=>{})),Ie(Ke)),zt=qe(e=>{let t={};for(const n of e)t=Object.assign(Object.assign({},t),n);return[t]})(Ie(Ue("select")),Ie(Oe(1)(Ye)),Nt,xt,Oe(0,1)(St),Oe(0,1)(Le(Tt,Oe(0,1)(It))),Oe(0,1)(Rt),Oe(0,1)(De(Le(Qt,Oe(0,1)(Ut)),Le(Ut,Oe(0,1)(Qt)))),Oe(0,1)(De(Bt,Wt)),Ie(Pe(Ye))),Jt=Qe(Le(Se(),Ie(Pe(Ye)),zt,Ie(Pe(Ye)),Te()));function Yt(e,t){const n=t.name.slice(0,t.name.length-1);return e.from.find(e=>a(e.name,n))}function Zt(e,t,n,r){var o;const s=null!==(o=Yt(e,t))&&void 0!==o?o:n;s&&r(s).add(t.name[t.name.length-1])}function Ht(e,t){for(const n of e.args)switch(typeof n){case"object":if(null===n);else switch(n.type){case"field":t(n);break;case"fncall":Ht(n,t)}}}function Gt(e,t){switch(e.type){case"condition":for(const n of e.operands)switch(typeof n){case"object":if(null===n);else if(Array.isArray(n));else switch(n.type){case"condition":Gt(n,t);break;case"field":t(n);break;case"fncall":for(const e of n.args)switch(typeof e){case"object":if(null===e);else switch(e.type){case"field":t(e);break;case"fncall":Ht(e,t)}}}}}return e}function Kt(e,t,n,r){var o,s,c,u;const f=new Map(null!=r?r:[]);if(0===n.length&&t.from[0].name.length>1)throw new Error("Relationship name is not allowed at first item of root level from clause.");{const e=t.from[0];if(t.from[0].name.length>1)for(;f.has(e.name[0].toLowerCase());)e.name=f.get(e.name[0].toLowerCase()).concat(e.name.slice(1));if(n.length>0&&(e.name=i(n,e.name),!a(e.name.slice(0,n.length),n)))throw new Error(`Resolver name ${e.name.join(".")} is not match to parent resolver ${n.join(".")}`)}const d=t.from[0].name;t.from[0].aliasName&&f.set(t.from[0].aliasName.toLowerCase(),d),t.whereSubQueries=[],t.havingSubQueries=[],t.selectSubQueries=[];for(const e of t.from.slice(1)){if(1===e.name.length)e.name=d.concat(e.name);else{let t=e.name[0].toLowerCase();for(;f.has(t);)e.name=f.get(t).concat(e.name.slice(1)),t=e.name[0].toLowerCase();e.name=i(d,e.name)}e.aliasName&&f.set(e.aliasName.toLowerCase(),e.name)}const p=new Map;let m="select";const h=e=>{switch(m){case"select":e.aliasName&&p.set(e.aliasName.toLowerCase(),e.name);break;case"where":case"having":case"orderby":if(1===e.name.length){const t=e.name[0].toLowerCase();p.has(t)&&(e.name=p.get(t))}}if(1===e.name.length)e.name=d.concat(e.name);else{let n=e.name[0].toLowerCase();for(;f.has(n);)e.name=f.get(n).concat(e.name.slice(1)),n=e.name[0].toLowerCase();e.name=i(d,e.name);const r=e.name.slice(0,e.name.length-1);t.from.find(e=>a(e.name,r))||t.from.push({name:r,aliasName:null})}return e},y=(n,r)=>{const o=n.fn.toLowerCase(),s=e.functions.find(e=>e.name.toLowerCase()===o);if(!s)throw new Error(`Function '${n.fn}' is not found.`);switch(m){case"select":"aggregate"!==s.type||t.groupBy||(t.groupBy=[]);break;case"where":if("aggregate"===s.type)throw new Error(`Aggregate function '${n.fn}' is not allowed.`);if(0!==r&&"immediate-scalar"!==s.type)throw new Error(`Function '${n.fn}' is not allowed at operand ${r+1}.`);break;case"having":if(0!==r&&"immediate-scalar"!==s.type)throw new Error(`Function '${n.fn}' is not allowed at operand ${r+1}.`)}for(const e of n.args)switch(typeof e){case"object":if(null===e);else switch(e.type){case"field":h(e);break;case"fncall":y(e,0)}}return n},w=n=>{switch(n.type){case"condition":for(let r=0;r<n.operands.length;r++){const o=n.operands[r];switch(typeof o){case"object":if(null===o);else if(Array.isArray(o));else switch(o.type){case"condition":w(o);break;case"field":h(o);break;case"fncall":y(o,r);break;case"subquery":("where"===m?t.whereSubQueries:t.havingSubQueries).push(o),o.query=Kt(e,o.query,[],null)}}}}return n};for(let n=0;n<t.select.length;n++){const r=t.select[n];switch(r.type){case"field":h(r);break;case"fncall":y(r,n);break;case"subquery":t.selectSubQueries.push(r),r.query=Kt(e,r.query,d,f)}}if(t.where&&(m="where",w(t.where[0])),t.having&&(m="having",w(t.having[0])),t.orderBy){m="orderby";for(const e of t.orderBy)h(e)}for(const e of t.from)e.queryFields=new Set,e.queryFieldsMap=new Map,e.condFields=new Set,e.condAliasFields=new Set,e.havingCondFields=new Set,e.relationshipIdFields=new Set;const b=e=>Zt(t,e,t.from[0],e=>e.queryFields),v=e=>Zt(t,e,t.from[0],e=>e.condFields),A=e=>Zt(t,e,t.from[0],e=>e.havingCondFields);let k=0;const N=(e,n)=>{n||e.aliasName||(e.aliasName="expr"+k++);let r=void 0;for(const n of e.args)switch(typeof n){case"object":if(null===n);else switch(n.type){case"field":b(n),r||(r=Yt(t,n));break;case"fncall":{const e=N(n,!0);r||(r=e)}}}return n||(null!=r?r:t.from[0]).queryFieldsMap.set(e.aliasName,e),r};for(const e of t.select)switch(e.type){case"field":{b(e);const n=Yt(t,e);null==n||n.queryFieldsMap.set(e.name[e.name.length-1],e)}break;case"fncall":N(e,!1)}if(t.where&&Gt(t.where[0],v),t.having&&Gt(t.having[0],A),t.groupBy)for(const e of t.groupBy)t.from[0].havingCondFields.add(e);t.from[0].name=d;const x=l(e.relationships,d[0]);if(!x)throw new Error(`Resolver '${d[0]}' is not found.`);const _=function e(t,n,r){const o=r.resolverName.toLowerCase(),s=r.fieldOrRelName.toLowerCase(),a=l(t.relationships,r.resolverName);if(!a)throw new Error(`Resolver '${r.resolverName}' is not found.`);const i=n.find(e=>e.resolverName.toLowerCase()===o&&e.fieldOrRelName.toLowerCase()===s);if(i)return i;const c=[],u={fieldOrRelName:r.fieldOrRelName,resolverName:a,direction:r.direction,children:c},f=t.relationships[a],d=n.concat([u]);for(const n of Object.keys(f)){const r=f[n];Array.isArray(r)?c.push(e(t,d,{resolverName:r[0],fieldOrRelName:n,direction:2})):"string"==typeof r?c.push(e(t,d,{resolverName:r,fieldOrRelName:n,direction:1})):c.push(e(t,d,{resolverName:r.resolver,fieldOrRelName:n,direction:1}))}return u}(e,[],{resolverName:x,fieldOrRelName:x,direction:1});for(const n of t.from){let t,r=[_];for(let e=0;e<n.name.length;e++){const o=n.name[e],s=o.toLowerCase(),a=r.find(e=>e.fieldOrRelName.toLowerCase()===s);if(!a)throw new Error(`Resolver '${o}' is not found.`);t=a,r=a.children,n.name[e]=a.fieldOrRelName}t&&(n.resolver=e.resolvers.query[t.resolverName],n.resolverName=t.resolverName)}if(t.where){const e=[];g(e,"and",t.where[0]),t.where=e}if(t.having){const e=[];g(e,"and",t.having[0]),t.having=e}t.from=t.from.slice(0,1).concat(t.from.slice(1).sort((e,t)=>e.name.length-t.name.length));for(let n=0;n<t.from.length;n++){const r=t.from[n];r.fieldAliasNames=new Set(Array.from(r.queryFieldsMap.entries()).map(e=>{const t=e[1];return t.aliasName&&!r.queryFields.has(t.aliasName)?t.aliasName.toLowerCase():""}).filter(e=>!!e));for(const e of r.fieldAliasNames)r.condFields.has(e)&&(r.condFields.delete(e),r.condAliasFields.add(e));r.sortFieldNames=new Set(t.orderBy?t.orderBy.filter(e=>r.name.length+1===e.name.length&&a(r.name,e.name.slice(0,r.name.length))).filter(e=>!r.fieldAliasNames.has(e.name[e.name.length-1].toLowerCase())).map(e=>e.name[e.name.length-1]):[]);{const i=null!==(o=r.resolverName)&&void 0!==o?o:"";for(let o=n+1;o<t.from.length;o++){const n=t.from[o];if(r.name.length+1===n.name.length&&a(r.name,n.name.slice(0,r.name.length))){const t=null!==(s=n.resolverName)&&void 0!==s?s:"",o=null!==(u=(null!==(c=e.relationships[i])&&void 0!==c?c:{})[t])&&void 0!==u?u:{},a=o.id?o.id:e.rules.foreignIdFieldName(t);a&&r.relationshipIdFields.add(a)}}}}return t}function Vt(e){const t=Date.UTC(e.getUTCFullYear(),0,1);return(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())-t)/864e5+1}function Xt(e){const t=Date.UTC(e.getFullYear(),0,1);return(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())-t)/864e5+1}const en={type:"scalar",name:"cast_to_string",fn:(e,t,n)=>{if(t.length>0)return null===t[0]?null:String(t[0]);throw new Error('Argument of function "cast_to_string" should be field.')}},tn={type:"scalar",name:"cast_to_number",fn:(e,t,n)=>{if(t.length>0)return null===t[0]?null:Number(t[0]);throw new Error('Argument of function "cast_to_number" should be field.')}},nn={type:"scalar",name:"cast_to_boolean",fn:(e,t,n)=>{if(t.length>0)return null===t[0]?null:Boolean(t[0]);throw new Error('Argument of function "cast_to_boolean" should be field.')}},rn={type:"scalar",name:"concat",fn:(e,t,n)=>{if(t.length>0){const e=t.filter(e=>null!==e);return 0===e.length?null:e.map(e=>String(e)).join("")}throw new Error('Argument of function "concat" should be field.')}},on={type:"scalar",name:"add",fn:(e,t,n)=>{if(t.length>1){const e=t.filter(e=>null!==e);return 0===e.length?null:e.map(e=>Number(e)).reduce((e,t)=>e+t)}throw new Error('Argument of function "add" should be field.')}},sn={type:"scalar",name:"sub",fn:(e,t,n)=>{if(t.length>1)return null===t[0]?null:t.filter(e=>null!==e).map(e=>Number(e)).reduce((e,t)=>e-t);throw new Error('Argument of function "sub" should be field.')}},an={type:"scalar",name:"mul",fn:(e,t,n)=>{if(t.length>1){const e=t.filter(e=>null!==e);return 0===e.length?null:e.map(e=>Number(e)).reduce((e,t)=>e*t)}throw new Error('Argument of function "mul" should be field.')}},ln={type:"scalar",name:"div",fn:(e,t,n)=>{if(t.length>1)return null===t[0]?null:t.filter(e=>null!==e).map(e=>Number(e)).reduce((e,t)=>e/t);throw new Error('Argument of function "div" should be field.')}},cn={type:"scalar",name:"mod",fn:(e,t,n)=>{if(t.length>1)return null===t[0]?null:t.filter(e=>null!==e).map(e=>Number(e)).reduce((e,t)=>e%t);throw new Error('Argument of function "div" should be field.')}},un={type:"aggregate",name:"count",fn:(e,t,n)=>{if(0===t.length)return n.length;{const e=t[0];if(Array.isArray(e))return e.filter(e=>null!=e).length;throw new Error('Argument of function "count" should be field.')}}},fn={type:"aggregate",name:"count_distinct",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>null!=e).map(e=>JSON.stringify(e));return new Set(t).size}}throw new Error('Argument of function "count_distinct" should be field.')}},dn={type:"aggregate",name:"sum",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e));return t.length?t.reduce((e,t)=>e+t):null}}throw new Error('Argument of function "sum" should be field.')}},pn={type:"aggregate",name:"avg",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e));return t.length?t.reduce((e,t)=>e+t)/t.length:null}}throw new Error('Argument of function "avg" should be field.')}},mn={type:"aggregate",name:"max",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e)||"string"==typeof e);return t.length?t.reduce((e,t)=>e>t?e:t):null}}throw new Error('Argument of function "max" should be field.')}},hn={type:"aggregate",name:"min",fn:(e,t,n)=>{if(t.length>0){const e=t[0];if(Array.isArray(e)){const t=e.filter(e=>"number"==typeof e&&!Number.isNaN(e)||"string"==typeof e);return t.length?t.reduce((e,t)=>e<t?e:t):null}}throw new Error('Argument of function "min" should be field.')}};function gn(e,t){return(n,s,a)=>{if(s.length>0){const e=s[0];switch(typeof e){case"object":if(null===e)return null;switch(e.type){case"date":case"datetime":return t(e.value);default:return null}case"string":return r.test(e)||o.test(e)?t(e):null}}throw new Error(`Argument of function "${e}" should be field.`)}}const yn={type:"scalar",name:"convertTimezone",fn:gn("convertTimezone",e=>{const t=new Date(e),n=60*t.getTimezoneOffset()*1e3;return new Date(t.getTime()-n).toISOString()})},wn={type:"scalar",name:"calendar_month",fn:gn("calendar_month",e=>new Date(e).getUTCMonth()+1)},bn={type:"scalar",name:"calendar_month_lc",fn:gn("calendar_month_lc",e=>new Date(e).getMonth()+1)},vn={type:"scalar",name:"calendar_quarter",fn:gn("calendar_quarter",e=>Math.floor(new Date(e).getUTCMonth()/3)+1)},An={type:"scalar",name:"calendar_quarter_lc",fn:gn("calendar_quarter_lc",e=>Math.floor(new Date(e).getMonth()/3)+1)},kn={type:"scalar",name:"calendar_year",fn:gn("calendar_year",e=>new Date(e).getUTCFullYear())},Nn={type:"scalar",name:"calendar_year_lc",fn:gn("calendar_year_lc",e=>new Date(e).getFullYear())},xn={type:"scalar",name:"day_in_month",fn:gn("day_in_month",e=>new Date(e).getUTCDate())},_n={type:"scalar",name:"day_in_month_lc",fn:gn("day_in_month_lc",e=>new Date(e).getDate())},Cn={type:"scalar",name:"day_in_week",fn:gn("day_in_week",e=>new Date(e).getUTCDay()+1)},jn={type:"scalar",name:"day_in_week_lc",fn:gn("day_in_week_lc",e=>new Date(e).getDay()+1)},Pn={type:"scalar",name:"day_in_year",fn:gn("day_in_year",e=>Vt(new Date(e)))},On={type:"scalar",name:"day_in_year_lc",fn:gn("day_in_year_lc",e=>Xt(new Date(e)))},Fn={type:"scalar",name:"day_only",fn:gn("day_only",e=>new Date(e).toISOString().split("T")[0])},En={type:"scalar",name:"day_only_lc",fn:gn("day_only_lc",e=>{const t=new Date(e);return new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())).toISOString().split("T")[0]})},Sn={type:"scalar",name:"hour_in_day",fn:gn("hour_in_day",e=>new Date(e).getUTCHours())},Tn={type:"scalar",name:"hour_in_day_lc",fn:gn("hour_in_day_lc",e=>new Date(e).getHours())},Dn={type:"scalar",name:"week_in_month",fn:gn("week_in_month",e=>Math.floor((new Date(e).getUTCDate()-1)/7)+1)},$n={type:"scalar",name:"week_in_month_lc",fn:gn("week_in_month_lc",e=>Math.floor((new Date(e).getDate()-1)/7)+1)},Ln=[en,tn,nn,rn,on,sn,an,ln,cn,un,fn,dn,pn,mn,hn,yn,wn,vn,kn,xn,Cn,Pn,Fn,Sn,Dn,{type:"scalar",name:"week_in_year",fn:gn("week_in_year",e=>Math.floor((Vt(new Date(e))-1)/7)+1)},bn,An,Nn,_n,jn,On,En,Tn,$n,{type:"scalar",name:"week_in_year_lc",fn:gn("week_in_year_lc",e=>Math.floor((Xt(new Date(e))-1)/7)+1)}],In={idFieldName:()=>"Id",foreignIdFieldName:e=>e?e+"Id":void 0};function qn(e,t,...n){return function(e,t){return Kt(e,t,[],null)}(e,function(e,...t){const n=Jt("string"==typeof e?Y(e,{}):function(e,t,n){const r=[];let o=0;if(t.length)for(let n=0;n<e.length;n++){const s=e[n];n<t.length&&(r.push(o+s.length),o+=s.length+1)}const s=e.join("\0");return{src:s,start:0,end:s.length,context:n,templateArgs:t,templateArgsPos:r}}(e,t,{}));if(!n.succeeded)throw new Error(Z(n));return n.tokens[0]}(t,...n))}var Mn=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function i(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};function Rn(e,t,n,r,o,s){return Mn(this,void 0,void 0,(function*(){const a=[];o.forEach(e=>function e(t,n){switch(n.type){case"condition":for(let r=0;r<n.operands.length;r++){const o=n.operands[r];switch(typeof o){case"object":if(null===o);else if(Array.isArray(o));else switch(o.type){case"condition":e(t,o);break;case"subquery":t.push({cond:n,index:r,subQuery:o})}}}}return n}(a,e));const i=a.map(o=>Jn(e,t,n,r,o.subQuery.query,null,null,null,s).then(e=>({cond:o.cond,index:o.index,subQuery:o.subQuery,result:e})));(yield Promise.all(i)).map(e=>{var t;const n=e.subQuery.query.select[0];let r="";switch(n.type){case"field":r=n.name[n.name.length-1];break;default:r=null!==(t=n.aliasName)&&void 0!==t?t:""}if(e.result.length){const t=new Map(Object.keys(e.result[0]).map(e=>[e.toLowerCase(),e]));e.cond.operands[e.index]=e.result.map(e=>u(t,e,r))}else e.cond.operands[e.index]=[]})}))}function Qn(e,t,n,r){const o=new Array(t.queryFieldsMap.size),s=new Array(t.queryFieldsMap.size),a=(t,n,r,o)=>{const a=s[t];o[r.aliasName]=_(e,r,a,"any",o,null)},i=(t,n,r,o)=>{const a=s[t];o[r.aliasName]=C(e,r,a,"any",o,null)},l=(e,t,n,r)=>{};{let n=0;for(const c of t.queryFieldsMap.entries()){const[t,u]=c;switch(u.type){case"field":o[n]={isField:!0,fieldName:t,field:u,fn:l};break;case"fncall":if(r)o[n]={isField:!1,fieldName:t,field:u,fn:l};else{const r=u.fn.toLowerCase(),c=e.functions.find(e=>e.name.toLowerCase()===r);switch(s[n]=c,null==c?void 0:c.type){case"scalar":o[n]={isField:!1,fieldName:t,field:u,fn:a};break;case"immediate-scalar":o[n]={isField:!1,fieldName:t,field:u,fn:i};break;default:o[n]={isField:!1,fieldName:t,field:u,fn:l}}}break;default:o[n]={isField:!1,fieldName:t,field:u,fn:l}}n++}}for(const e of n)for(let t=0;t<o.length;t++){const{isField:n,fieldName:r,field:s,fn:a}=o[t];n?s.aliasName&&(e[s.aliasName]=e[r]):a(t,r,s,e)}return n}function Un(e,t,n,r){if(0===r.length)return[];if(1===r.length||0===t.length)return[r];const o=new Map;if(r.length){let e=0;const n=new Map(Object.keys(r[0]).map(e=>[e.toLowerCase(),e]));for(const s of r){const r=[];for(const o of t){let t=u(n,s,o);null==t&&(t="__$$GENSYM_VT4iHbNbZW3C7taC7J6bx8pruw40cX5X$$_"+e++),r.push(t)}const a=JSON.stringify(r);if(o.has(a)){o.get(a).push(s)}else o.set(a,[s])}}return Array.from(o.values())}function Bn(e,t,n,r){var o,s;const a=[];if(!r.length)return a;const i=r[0][0],c=new Map(t.map(e=>{var t;return[e.toLowerCase(),null!==(t=l(i,e))&&void 0!==t?t:""]})),u=new Array(n.queryFieldsMap.size),f=new Array(n.queryFieldsMap.size),d=(t,n,r,o)=>{const s=f[t];o[n.aliasName]=j(e,n,s,"any",r)},p=(t,n,r,o)=>{const s=f[t];o[n.aliasName]=C(e,n,s,"any",null,r)},m=(t,n,r,o)=>{const s=f[t];o[n.aliasName]=_(e,n,s,"any",r[0],r)},h=(e,t,n,r)=>{};{let t=0;for(const r of n.queryFieldsMap.entries()){const[,n]=r;switch(n.type){case"field":{const e=P(c,n.name[n.name.length-1]);if(!e)throw new Error(n.name.join(".")+" is not allowed. Aggregate function is needed.");u[t]={isField:!0,field:n,trueCaseName:e,fn:h}}break;case"fncall":{const r=n.fn.toLowerCase(),a=e.functions.find(e=>e.name.toLowerCase()===r);switch(f[t]=a,null==a?void 0:a.type){case"aggregate":u[t]={isField:!1,field:n,trueCaseName:"",fn:d};break;case"immediate-scalar":u[t]={isField:!1,field:n,trueCaseName:"",fn:p};break;case"scalar":if(!O(e,c,n.args))throw new Error((null!==(o=n.aliasName)&&void 0!==o?o:"(unnamed)")+" is not allowed. Aggregate function is needed.");u[t]={isField:!1,field:n,trueCaseName:"",fn:m};break;default:throw new Error((null!==(s=n.aliasName)&&void 0!==s?s:"(unnamed)")+" is not allowed. Aggregate function is needed.")}}break;default:u[t]={isField:!1,field:n,trueCaseName:"",fn:h}}t++}}for(const e of r){const t={};for(let n=0;n<u.length;n++){const{isField:r,field:o,trueCaseName:s,fn:a}=u[n];r?(t[s]=e[0][s],o.aliasName&&(t[o.aliasName]=e[0][s])):a(n,o,e,t)}a.push(t)}return a}function Wn(e,t,n){const r=new Set;if(t.length){const o=new Set,s=t[0];for(const t of e.queryFieldsMap.entries()){const e=t[1];if(n&&"field"===e.type&&e.aliasName)o.add(e.aliasName);else{const e=l(s,t[0]);e&&o.add(e)}}for(const e of Object.keys(s))o.has(e)||r.add(e)}return r}function zn(e,t,n,r){var o,s,a,i;const l=0===r?"master":"detail",c=JSON.stringify(n.name.slice(0,n.name.length-1)),u=JSON.stringify(n.name),f=null!==(o=n.resolverName)&&void 0!==o?o:"",d=t.get(c),p=null!==(i=0===r?(null!==(s=e.relationships[f])&&void 0!==s?s:{})[d]:(null!==(a=e.relationships[d])&&void 0!==a?a:{})[f])&&void 0!==i?i:{};return{parentType:l,parentKey:c,currentKey:u,resolverName:f,parentResolverName:d,masterRelationshipInfo:p,foreignIdField:"object"==typeof p&&p.id?p.id:0===r?e.rules.foreignIdFieldName(d):e.rules.foreignIdFieldName(f),parentIdFieldName:d?e.rules.idFieldName(d):void 0,currentIdFieldName:e.rules.idFieldName(f)}}function Jn(e,t,n,r,o,a,i,l,c){return Mn(this,void 0,void 0,(function*(){let u,f;const d=null!=i?i:new Map,p=null!=l?l:new Map,g=null!=c?c:{},{limit:y,offset:w}=function(e,t,n){var r,o;if(n=null!=n?n:null,null!==(t=null!=t?t:null)&&"object"==typeof t){if(!Object.prototype.hasOwnProperty.call(e,t.name))throw new Error(`Parameter '${t.name}' is not found.`);const n=null!==(r=e[t.name])&&void 0!==r?r:null;if("number"!=typeof n)throw new Error(`Parameter '${t.name}' should be number.`);t=n}if(null!==n&&"object"==typeof n){if(!Object.prototype.hasOwnProperty.call(e,n.name))throw new Error(`Parameter '${n.name}' is not found.`);const t=null!==(o=e[n.name])&&void 0!==o?o:null;if("number"!=typeof t)throw new Error(`Parameter '${n.name}' should be number.`);n=t}return{limit:t,offset:n}}(t,o.limit,o.offset);!a&&e.events.beginExecute&&(yield e.events.beginExecute({resolverData:g,transactionData:n,transactionOptions:r}));try{const i=o.where?s(o.where):[],l=o.having?s(o.having):[];yield Rn(e,t,n,r,i,g),yield Rn(e,t,n,r,l,g);const c=[],b=new Map;for(let v=0;v<o.from.length;v++){const A=o.from[v],{parentType:k,parentKey:N,currentKey:x,resolverName:_,parentResolverName:C,foreignIdField:j,parentIdFieldName:P,currentIdFieldName:O}=zn(e,p,A,v);if(!A.resolver)throw new Error(`Resolver name ${A.name.join(".")} is not resolved.`);let F=[];const E=d.get(N),S=A.condAliasFields.size>0,T=!(0!==v||!o.groupBy),D=Array.from(A.queryFields.values()),$=Array.from(A.condFields.values()),L=Array.from(A.havingCondFields.values()),I=0===v&&o.groupBy?o.groupBy:[],q=Array.from(A.sortFieldNames.values()),Q=Array.from(A.relationshipIdFields.values()),U=Array.from(new Set(D.concat($).concat(L).concat(e.rules.idFieldName?[e.rules.idFieldName(_)]:[]).concat(I).concat(q).concat(Q)).values()),B=s(i).map(e=>h(A.name,e)).filter(m),W=s(l).map(e=>h(A.name,e)).filter(m),z={functions:e.functions,query:o,params:t,graphPath:A.name,resolverName:_,parentResolverName:C,parentType:k,foreignIdField:j,masterIdField:0===v?P:O,detailIdField:0===v?O:P,parentRecords:E,conditions:B,resolverData:g,transactionData:n,transactionOptions:r};if(0===v){const e=Object.assign(Object.assign({},z),{parent:a,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}});if(F=yield A.resolver(U,S?[]:B,T||S?null:y,T||S?null:w,e),f=e.resolverCapabilities,S&&(f.filtering=!1,f.limit=!1,f.offset=!1,f.sorting=!1),S&&(F=Qn(z,A,F,T)),e.resolverCapabilities.filtering||(F=M(z,B,F)),S||(F=Qn(z,A,F,T)),T){f.limit=!1,f.offset=!1,f.sorting=!1;const e=R(z,W,Un(0,I,0,F));F=Bn(z,I,A,e)}u=F}else if(E&&E.length){e.events.beforeMasterSubQueries&&(yield e.events.beforeMasterSubQueries(z));const t=A.name[A.name.length-1];for(const e of E){const n=Object.assign(Object.assign({},z),{parent:e,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}});let r=(yield A.resolver(U,S?[]:B,1,0,n)).slice(0,1);S&&(n.resolverCapabilities.filtering=!1,n.resolverCapabilities.limit=!1,n.resolverCapabilities.offset=!1,n.resolverCapabilities.sorting=!1),S&&(r=Qn(z,A,r,T)),n.resolverCapabilities.filtering||(r=M(z,B,r)),S||(r=Qn(z,A,r,T)),e[t]=r.length>0?r[0]:null,F=F.concat(r)}e.events.afterMasterSubQueries&&(yield e.events.afterMasterSubQueries(z));const n=b.get(N);n&&n.delete(t)}const J=Wn(A,F,T);c.push([J,F]),b.set(x,J),d.set(x,F),p.set(x,_)}if(o.selectSubQueries&&u){const s=[];for(const a of o.selectSubQueries){const o=a.query.from[0].name,i=JSON.stringify(o.slice(0,o.length-1)),l=d.get(i);if(l){const{parentType:i,resolverName:c,parentResolverName:u,foreignIdField:f,parentIdFieldName:m,currentIdFieldName:h}=zn(e,p,a.query.from[0],0),y={functions:e.functions,query:a.query,params:t,graphPath:o,resolverName:c,parentResolverName:u,parentType:i,foreignIdField:f,masterIdField:m,detailIdField:h,parentRecords:l,resolverData:g,transactionData:n,transactionOptions:r};e.events.beforeDetailSubQueries&&(yield e.events.beforeDetailSubQueries(Object.assign({},y)));for(const i of l)s.push(Jn(e,t,n,r,a.query,i,d,p,g).then(e=>({name:o,parent:i,result:e})));e.events.afterDetailSubQueries&&(yield e.events.afterDetailSubQueries(Object.assign({},y)))}const c=b.get(i);c&&c.delete(o[o.length-1])}(yield Promise.all(s)).forEach(e=>{e.parent[e.name[e.name.length-1]]=e.result})}u?f&&(f.sorting||(u=z(o,u)),f.offset||f.limit?f.offset?f.limit||"number"==typeof y&&(u=u.slice(0,y)):"number"==typeof w&&(u=u.slice(w)):"number"==typeof w&&"number"==typeof y?u=u.slice(w,w+y):"number"==typeof w?u=u.slice(w):"number"==typeof y&&(u=u.slice(0,y))):u=[];for(const e of c){const[t,n]=e;for(const e of n)for(const n of t)delete e[n]}!a&&e.events.endExecute&&(yield e.events.endExecute({resolverData:g,transactionData:n,transactionOptions:r},null))}catch(t){throw!a&&e.events.endExecute&&(yield e.events.endExecute({resolverData:g,transactionData:n,transactionOptions:r},t)),t}return u}))}var Yn=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function i(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};var Zn=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function i(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};class Hn{constructor(e,t){this.query=e,this.runCompiledQuery=t}execute(e){return this.runCompiledQuery(this.query,e)}}function Gn(e){const t=function(e){const t=Object.assign({},e);t.relationships||(t.relationships={});for(const e of Object.keys(t.resolvers.query))t.relationships[e]||(t.relationships[e]={});return t.resolvers.insert||(t.resolvers.insert={}),t.resolvers.update||(t.resolvers.update={}),t.resolvers.remove||(t.resolvers.remove={}),t.functions||(t.functions=[]),t.functions=t.functions.concat(Ln),t.rules||(t.rules={}),t.rules=Object.assign(Object.assign({},In),t.rules),t.events||(t.events={}),t}(e),n={};class r{constructor(){this.eventQueue=[]}publish(e,r,o){const s=n[e];if(s&&s.size){{const t=s.get(null);if(t)for(const n of t.values())this.eventQueue.push({on:r,resolver:e,id:null,fn:n})}const n=t.rules.idFieldName(e);for(const t of o){const o=t[n],a=s.get(o);if(a)for(const t of a.values())this.eventQueue.push({on:r,resolver:e,id:o,fn:t})}}}toPublishFn(){return(e,t,n)=>this.publish(e,t,n)}fire(){if(this.eventQueue.length){const e=this.eventQueue;this.eventQueue=[],setTimeout(()=>{for(const t of e)try{t.fn({on:t.on,resolver:t.resolver,id:t.id})}catch(e){}},0)}}}function o(e,t,r){n[e]||(n[e]=new Map);const o=n[e];o.has(t)||o.set(t,new Set);o.get(t).add(r)}function s(e,t,r){if(!n[e])return;const o=n[e];if(!o.has(t))return;o.get(t).delete(r)}function a(e,t){if(!n[e])return;const r=n[e];for(const[,e]of r.entries())e.delete(t)}return function e(n,i,l,c){const u=null==l?void 0:l.toPublishFn();function f(e,n,r,o){return Zn(this,void 0,void 0,(function*(){try{t.events.beginTransaction&&(yield t.events.beginTransaction({resolverData:{},transactionData:e,transactionOptions:n}));const s=yield o(e,n,r.toPublishFn());return t.events.endTransaction&&(yield t.events.endTransaction({resolverData:{},transactionData:e,transactionOptions:n},null)),r.fire(),s}catch(r){try{t.events.endTransaction&&(yield t.events.endTransaction({resolverData:{},transactionData:e,transactionOptions:n},r))}catch(e){}throw r}}))}function d(e,o){return Zn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Zn(this,void 0,void 0,(function*(){const a=yield Jn(t,null!=o?o:{},n,r,e,null,null,null,null);return e.for&&(e.for.includes("view")||e.for.includes("reference"))&&s(e.from[0].resolverName[e.from[0].resolverName.length-1],"update",a),a}));return c?yield f({},void 0,new r,s):yield s(n,i,u)}))}function p(e,t,n){return Zn(this,void 0,void 0,(function*(){const o=(r,o,s)=>{const a=Array.isArray(n)?n:[n];return s(e,t,a),Promise.resolve()};return c?yield f({},void 0,new r,o):yield o(0,0,u)}))}return{compile:function(e,...n){const r=qn(t,e,...n);return new Hn(r,d)},soql:function(e,...o){return Zn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Zn(this,void 0,void 0,(function*(){const a=qn(t,e,...o),i=yield Jn(t,{},n,r,a,null,null,null,null);return a.for&&(a.for.includes("view")||a.for.includes("reference"))&&s(a.from[0].resolverName[a.from[0].resolverName.length-1],"update",i),i}));return c?yield f({},void 0,new r,s):yield s(n,i,u)}))},insert:function(e,o){return Zn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Zn(this,void 0,void 0,(function*(){const a=Array.isArray(o),i=yield function(e,t,n,r,o){return Yn(this,void 0,void 0,(function*(){const s=e.resolvers.insert;let a=null;for(const e of Object.keys(s))e.toLowerCase()===r.toLowerCase()&&(a=s[e]);if(!a)throw new Error(`Resolver name ${r} is not resolved.`);const i={resolverData:{},transactionData:t,transactionOptions:n};e.events.beginExecute&&(yield e.events.beginExecute(i));let l=null;try{const s={functions:e.functions,graphPath:[],resolverName:r,resolverData:i.resolverData,transactionData:t,transactionOptions:n,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}};l=yield a(o,s),e.events.endExecute&&(yield e.events.endExecute(i,null))}catch(t){throw e.events.endExecute&&(yield e.events.endExecute(i,t)),t}return l}))}(t,n,r,e,a?o:[o]);return s(e,"insert",i),a?i:i[0]}));return c?yield f({},void 0,new r,s):yield s(n,i,u)}))},update:function(e,o){return Zn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Zn(this,void 0,void 0,(function*(){const a=Array.isArray(o),i=yield function(e,t,n,r,o){return Yn(this,void 0,void 0,(function*(){const s=e.resolvers.update;let a=null;for(const e of Object.keys(s))e.toLowerCase()===r.toLowerCase()&&(a=s[e]);if(!a)throw new Error(`Resolver name ${r} is not resolved.`);const i={resolverData:{},transactionData:t,transactionOptions:n};e.events.beginExecute&&(yield e.events.beginExecute(i));let l=null;try{const s={functions:e.functions,graphPath:[],resolverName:r,resolverData:i.resolverData,transactionData:t,transactionOptions:n,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}};l=yield a(o,s),e.events.endExecute&&(yield e.events.endExecute(i,null))}catch(t){throw e.events.endExecute&&(yield e.events.endExecute(i,t)),t}return l}))}(t,n,r,e,a?o:[o]);return s(e,"update",i),a?i:i[0]}));return c?yield f({},void 0,new r,s):yield s(n,i,u)}))},remove:function(e,o){return Zn(this,void 0,void 0,(function*(){const s=(n,r,s)=>Zn(this,void 0,void 0,(function*(){const a=Array.isArray(o)?o:[o];yield function(e,t,n,r,o){return Yn(this,void 0,void 0,(function*(){const s=e.resolvers.remove;let a=null;for(const e of Object.keys(s))e.toLowerCase()===r.toLowerCase()&&(a=s[e]);if(!a)throw new Error(`Resolver name ${r} is not resolved.`);const i={resolverData:{},transactionData:t,transactionOptions:n};e.events.beginExecute&&(yield e.events.beginExecute(i));try{const s={functions:e.functions,graphPath:[],resolverName:r,resolverData:i.resolverData,transactionData:t,transactionOptions:n,resolverCapabilities:{filtering:!1,sorting:!1,limit:!1,offset:!1}};yield a(o,s),e.events.endExecute&&(yield e.events.endExecute(i,null))}catch(t){throw e.events.endExecute&&(yield e.events.endExecute(i,t)),t}}))}(t,n,r,e,a),s(e,"remove",a)}));return c?yield f({},void 0,new r,s):yield s(n,i,u)}))},touch:function(e,t){return Zn(this,void 0,void 0,(function*(){return p(e,"update",t)}))},notifyRemoved:function(e,t){return Zn(this,void 0,void 0,(function*(){return p(e,"remove",t)}))},subscribe:o,unsubscribe:s,unsubscribeAllBySubscriber:a,transaction:function(t,n){return Zn(this,void 0,void 0,(function*(){const o={},s=new r,a=e(o,n,s,!1);return yield f(o,n,s,(e,n,r)=>Zn(this,void 0,void 0,(function*(){yield t({compile:a.compile,soql:a.soql,insert:a.insert,update:a.update,remove:a.remove,touch:a.touch,notifyRemoved:a.notifyRemoved},e)})))}))}}}({},void 0,void 0,!0)}const Kn=le({rawToToken:e=>e,concatTokens:e=>e.length?[e.reduce((e,t)=>e+t)]:[]}),{seq:Vn,cls:Xn,notCls:er,classes:tr,numbers:nr,cat:rr,repeat:or,end:sr,first:ar,combine:ir,erase:lr,trans:cr,ahead:ur,makeProgram:fr}=Kn,dr=cr(e=>[Number.parseInt(e[0].replace(/_/g,""),10)])(nr.int),pr=ar(cr(e=>[Number.parseFloat(e[0].replace(/_/g,""))])(nr.float),dr),mr=cr(e=>[!0])(Vn("true")),hr=cr(e=>[!1])(Vn("false")),gr=cr(e=>e.length?e:[""])(lr(or(tr.spaceWithinSingleLine),Xn('"')),rr(or(ar(cr(e=>['"'])(Vn('""')),er('"')))),lr(Xn('"'),or(lr(tr.spaceWithinSingleLine)))),yr=cr(e=>e.length?e:[null])(lr(or(tr.spaceWithinSingleLine)),ar(mr,hr,pr),lr(or(tr.spaceWithinSingleLine)),ur(ar(Xn(",","\r\n","\n","\r"),sr()))),wr=cr(e=>e.length?[e[0]?e[0].trim():""]:[null])(lr(or(tr.spaceWithinSingleLine)),rr(or(ar(lr(tr.spaceWithinSingleLine,ur(Xn(",","\r\n","\n","\r"))),er(",","\r\n","\n","\r"))))),br=ar(gr,yr,wr),vr=cr(e=>[e])(br,or(ir(lr(Vn(",")),br))),Ar=fr(ir(vr,or(ir(lr(tr.newline),vr)),sr()));var kr=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function i(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};const Nr={noCache:!1,noFiltering:!1,noSorting:!1};function xr(e){Object.assign(Nr,e)}function _r(e){const t=JSON.parse(e);if(!Array.isArray(t))throw new Error("jsonRecordsParser: Records should be array.");return t}function Cr(e){const t=function(e){const t=Ar(Y(e));if(!t.succeeded)throw new Error(Z(t));return t.tokens}(e.trim());if(!t.length)throw new Error("csvRecordsParser: Header row is needed.");const n=t[0];for(let e=0;e<n.length;e++)if(ge(de,n[e]))throw new Error("Unsafe symbol name is appeared: "+n[e]);const r=[];for(let e=1;e<t.length;e++){const o=t[e],s={};for(let e=0;e<n.length;e++)s[n[e]]=o[e];r.push(s)}return r}function jr(e){return e}function Pr(e){return(t,n,r)=>(o,s,i,u,f)=>kr(this,void 0,void 0,(function*(){let d,p=null;f.resolverData.cache?(d=f.resolverData.cache,d.has(t)&&(p=d.get(t))):(d=new Map,r.noCache||(f.resolverData.cache=d));let m=!1,h=null;if(null===p){const r=yield n();h=e(r),d.set(t,h.map(e=>Object.assign({},e)))}else m=!0,h=p;return function(e,t,n,r,o,s,i,u){if(!t.length)return t;const f=new Set,d=new Map(Object.keys(t[0]).map(e=>[e.toLowerCase(),e])),p=new Set(n.map(e=>e.toLowerCase()));for(const e of p.keys())if(!d.has(e))throw new Error(`Field "${e}" is not supplied from resolver "${i.resolverName}".`);if(t.length&&i.parent)switch(i.parentType){case"master":if(i.foreignIdField){const e=c(i.parent,i.masterIdField),n=l(t[0],i.foreignIdField);t=t.filter(t=>t[n]===e)}break;case"detail":if(i.foreignIdField){const e=c(i.parent,i.foreignIdField),n=l(t[0],i.masterIdField);t=t.filter(t=>t[n]===e)}}if(u.noFiltering||(t=M(i,r,t),i.resolverCapabilities.filtering=!0),e&&(t=t.map(e=>Object.assign({},e))),u.noFiltering)return t;if(!u.noSorting&&i.query&&i.query.orderBy){const e=i.query.from[0].name.length;i.graphPath.length===e&&a(i.graphPath,i.query.from[0].name)&&i.query.orderBy.every(t=>t.name.length===e+1&&d.has(t.name[t.name.length-1].toLowerCase()))&&(t=z(i.query,t),i.resolverCapabilities.sorting=!0)}for(const e of d.keys())p.has(e)||f.add(d.get(e));for(const e of t)for(const t of f)delete e[t];return i.resolverCapabilities.sorting&&("number"==typeof s&&(t=t.slice(s)),"number"==typeof o&&(t=t.slice(0,o)),i.resolverCapabilities.limit=!0,i.resolverCapabilities.offset=!0),t}(m,h,o,s,i,u,f,r)}))}const Or=(e,t,n)=>Pr(_r)(e,t,null!=n?n:Nr),Fr=(e,t,n)=>Pr(Cr)(e,t,null!=n?n:Nr),Er=(e,t,n)=>Pr(jr)(e,t,null!=n?n:Nr)}])}));
//# sourceMappingURL=opensoql.min.js.map